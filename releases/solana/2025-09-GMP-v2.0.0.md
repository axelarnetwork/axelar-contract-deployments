# Solana GMP v1.0.0

## Network Status

|                | **Owner**    |
| -------------- | ------------ |
| **Created By** | @nbayindirli |
| **Deployment** | @nbayindirli |

| **Axelar Env**       | **Deployment Status** | **Date**   |
| -------------------- | --------------------- | ---------- |
| **Devnet Amplifier** | Pending               | TBD        |
| **Stagenet**         | Pending               | TBD        |
| **Testnet**          | Pending               | TBD        |
| **Mainnet**          | Pending               | TBD        |

## PDAs

- Add the below PDAs as they are generated during the release process.

### Devnet Amplifier

| **Axelar Env**       | **Program** | **Solana Env** | **PDA**                                       |
| -------------------- | ----------- | -------------- | --------------------------------------------- |
| **Devnet Amplifier** | Gateway     | **Devnet**     | `` |
| **Devnet Amplifier** | Gas Service | **Devnet**     | `` |
| **Devnet Amplifier** | Governance  | **Devnet**     | `` |
| **Devnet Amplifier** | Multicall   | **Devnet**     | `` |

### Stagenet

| **Axelar Env** | **Program** | **Solana Env** | **PDA**                                       |
| -------------- | ----------- | -------------- | --------------------------------------------- |
| **Stagenet**   | Gateway     | **Testnet**    | `` |
| **Stagenet**   | Gas Service | **Testnet**    | `` |
| **Stagenet**   | Governance  | **Testnet**    | `` |
| **Stagenet**   | Multicall   | **Testnet**    | `` |

### Testnet

| **Axelar Env** | **Program** | **Solana Env** | **PDA**                                       |
| -------------- | ----------- | -------------- | --------------------------------------------- |
| **Testnet**    | Gateway     | **Testnet**    | `` |
| **Testnet**    | Gas Service | **Testnet**    | `` |
| **Testnet**    | Governance  | **Testnet**    | `` |
| **Testnet**    | Multicall   | **Testnet**    | `` |

### Mainnet

| **Axelar Env** | **Program** | **Solana Env** | **PDA**                                       |
| -------------- | ----------- | -------------- | --------------------------------------------- |
| **Mainnet**    | Gateway     | **Mainnet**    | `` |
| **Mainnet**    | Gas Service | **Mainnet**    | `` |
| **Mainnet**    | Governance  | **Mainnet**    | `` |
| **Mainnet**    | Multicall   | **Mainnet**    | `` |

## Background

This is the v1.0.0 Solana GMP release.

## Deployment

### Deployment Prerequisites

1. Ensure you have access to the keypairs for the following accounts, unless you plan to generate new keypairs (below):

    | Axelar Env           | Authority                        | Operator                         |
    | -------------------- | -------------------------------- | -------------------------------- |
    | **Devnet-amplifier** | `<generate key with 'upa' prefix>` | `<generate key with 'gop' prefix>` |
    | **Stagenet**         | `<generate key with 'upa' prefix>` | `<generate key with 'gop' prefix>` |
    | **Testnet**          | `<generate key with 'upa' prefix>` | `<generate key with 'gop' prefix>` |
    | **Mainnet**          | `<generate key with 'upa' prefix>` | `<generate key with 'gop' prefix>` |

1. Create an `.env` config with the following:

    ```sh
    # Used by 'solana-verify' tool get verifiable builds
    BASE_IMAGE="solanafoundation/solana-verifiable-build@sha256:979b09eef544de4502a92e28a724a8498a08e2fe506e8905b642e613760403d3"
    COMMIT_HASH="<latest axelar-amplifier-solana commit hash>"
    ENV=<devnet-custom|devnet-amplifier|stagenet|testnet|mainnet>
    CLUSTER=<devnet|testnet|mainnet-beta>
    CHAIN=<solana-custom|solana>
    ```

1. Ensure you have Rust installed. If you don't:

    ```sh
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
    ```

1. Install Solana CLI:

    ```sh
    sh -c "$(curl -sSfL https://release.anza.xyz/v2.2.14/install)"
    ```

1. Install `solana-verify`, for verifiable builds:

    ```sh
    cargo install solana-verify
    ```

1. Set default Solana cluster:

    ```sh
    # Set default cluster
    solana config set --url $CLUSTER
    ```

1. Generate or set existing keypair:

    - To generate and set a new keypair:

        ```sh
        # Get keypair starting with 'upa'
        solana-keygen grind --starts-with upa:1

        # Move new keypair out of current dir
        mv <generated upa keypair>.json /path/to/my/keys/folder/{deployer-{$CLUSTER}.json}

        # Set to new keypair
        solana config set --keypair /path/to/my/keys/folder/{deployer-{$CLUSTER}.json}
        ```

    - To set an existing keypair:

        ```sh
        solana config set --keypair /path/to/my/keys/folder/{<my existing keypair>.json}
        ```

1. Fund keypair (unless on mainnet)

    ```sh
    solana airdrop 5
    ```

1. Get or verify account address for your keypair:

    ```sh
    solana address
    ```

1. Verify account is funded:

    ```sh
    solana balance
    ```

    Note: If funding is not enough, reach out to a team member for SOL.

### Deployment Setup

> [!IMPORTANT]
> For the initial deployment of Solana programs to any of the clusters (devnet, testnet, and mainnet-beta), the program keypairs are required. The pubkey is the program ID and is hardcoded in the program using the `declare_id` macro. In case a new set of keypairs is required, a new release of the crates needs to happen afterwards (due to the id being hardcoded). Updating the ids can be done within the `axelar-amplifier-solana` directory by invoking:
>
> ```sh
> cargo xtask update-ids
> ```
>
> The keypair files should be stored securely as they're needed for the initial deployment on other clusters as well.

> [!NOTE]
> Initial deployment of Solana programs doesn't support offline signing, the process needs to be done online. When deploying, an `upgrade-authority` can be set, which will later be able to perform program upgrades â€” upgrades support offline signing.

1. Clone the [`axelar-amplifier-solana`](https://github.com/axelarnetwork/axelar-amplifier-solana) repo.

1. Compile the Solana programs:

    ```sh
    # Go to the solana directory within the cloned repo
    cd axelar-amplifier-solana

    # Compile the Solana programs
    solana-verify build --base-image $BASE_IMAGE --library-name axelar_solana_gas_service
    solana-verify build --base-image $BASE_IMAGE --library-name axelar_solana_gateway
    solana-verify build --base-image $BASE_IMAGE --library-name axelar_solana_governance
    solana-verify build --base-image $BASE_IMAGE --library-name axelar_solana_multicall

    # Go back
    cd ..
    ```

1. Declare additional environment variables in your `.env`:

    ```sh
    GATEWAY_PROGRAM_KEYPAIR_PATH="<path/to/gateway_program_keypair.json>"
    GATEWAY_PROGRAM_PATH="axelar-amplifier-solana/target/deploy/axelar_solana_gateway.so"

    GAS_SERVICE_PROGRAM_KEYPAIR_PATH="<path/to/gas_service_program_keypair.json>"
    GAS_SERVICE_PROGRAM_PATH="axelar-amplifier-solana/target/deploy/axelar_solana_gas_service.so"

    GOVERNANCE_PROGRAM_KEYPAIR_PATH="<path/to/governance_program_keypair.json>"
    GOVERNANCE_PROGRAM_PATH="axelar-amplifier-solana/target/deploy/axelar_solana_governance.so"

    MULTICALL_PROGRAM_KEYPAIR_PATH="<path/to/multicall_program_keypair.json>"
    MULTICALL_PROGRAM_PATH="axelar-amplifier-solana/target/deploy/axelar_solana_multicall.so"

    UPGRADE_AUTHORITY_KEYPAIR_PATH="<path/to/upgrade_authority_keypair.json>"
    ```

    ```bash
    source .env
    ```

1. Add Solana chain config to the `axelar-chains-config/info/$ENV.json` file under the `chains` key:

    ```json
    "$CHAIN": {
    "name": "Solana $ENV",
    "axelarId": "$CHAIN",
    "rpc": "https://api.$CLUSTER.solana.com",
    "chainType": "svm",
    "decimals": 9,
    "finality": "31",
    "approxFinalityWaitTime": 1,
    "tokenSymbol": "SOL",
    "explorer": {
        "name": "Solana $CLUSTER Explorer",
        "url": "https://explorer.solana.com/?cluster=$CLUSTER"
    },
    "contracts": {}
    }
    ```

### Deployment Steps

> [!NOTE]
> If `--upgrade-authority` is omitted, the current Solana CLI keypair is set as upgrade-authority.
> After each deployment, populate the above tables with the respective PDAs.

1. Enter the `axelar-amplifier-solana` directory

    ```sh
    cd axelar-amplifier-solana
    ```

1. Deploy and verify axelar_solana_gateway program:

    ```sh
    anchor deploy -p axelar_solana_gateway --provider.cluster $CLUSTER --program-keypair GATEWAY_PROGRAM_KEYPAIR_PATH -v -- --upgrade-authority $UPGRADE_AUTHORITY_KEYPAIR_PATH


    anchor verify -p axelar_solana_gateway --provider.cluster $CLUSTER -d $BASE_IMAGE -e $ENV --skip-build -- --no-default-features --features $ENV
    ```

// TODO: add remaining
