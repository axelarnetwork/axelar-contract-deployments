# Solana GMP vX.Y.Z

|                | **Owner**                      |
| -------------- | ------------------------------ |
| **Created By** | @<GITHUB_USERNAME> (<EMAIL>)   |
| **Deployment** | @<GITHUB_USERNAME> (<EMAIL>)   |

| **Network**          | **Deployment Status** | **Date**         |
| -------------------- | --------------------- | ---------------- |
| **Devnet Amplifier** | Pending               | <DEPLOY_DATE>    |
| **Stagenet**         | Pending               | <DEPLOY_DATE>    |
| **Testnet**          | Pending               | <DEPLOY_DATE>    |
| **Mainnet**          | Pending               | <DEPLOY_DATE>    |

- [GitHub Release](<GITHUB_RELEASE_URL>)

## Background

This is the v.X.Y.Z Solana GMP release, introducing General Message Passing (GMP) capabilities for Solana blockchain.

## Deployment

### Prerequisites

1. Install Solana CLI:

```sh
sh -c "$(curl -sSfL https://release.anza.xyz/stable/install)"
```

2. Clone the solana-axelar repository.

3. Build the Solana programs:

```sh
# Go to the solana directory within the cloned repo
pushd solana-axelar/solana/

# Compile the Solana programs
cargo xtask build

# Go back
popd
```

4. Set up environment configuration:

```sh
# Create .env file with appropriate values
PRIVATE_KEY=<SOLANA_DEPLOYER_KEY>
ENV=<devnet-amplifier|stagenet|testnet|mainnet>
CHAIN=<solana-testnet|solana>  # Use solana-testnet for devnet-amplifier, stagenet, testnet; use solana for mainnet
```

### Initial Solana Config

Add Solana chain config to the `${ENV}.json` file under the `chains` key.

#### Devnet-Amplifier / Stagenet / Testnet:

```json
"solana-testnet": {
  "name": "Solana",
  "axelarId": "solana-testnet",
  "rpc": "https://api.testnet.solana.com",
  "networkType": "testnet",
  "chainType": "svm",
  "decimals": 9,
  "finality": "32",
  "approxFinalityWaitTime": 15,
  "tokenSymbol": "SOL",
  "explorer": {
    "name": "Solana Explorer",
    "url": "https://explorer.solana.com/?cluster=testnet"
  },
  "contracts": {}
}
```

#### Mainnet:

```json
"solana": {
  "name": "Solana",
  "axelarId": "solana",
  "rpc": "https://api.mainnet-beta.solana.com",
  "networkType": "mainnet",
  "chainType": "svm",
  "decimals": 9,
  "finality": "32",
  "approxFinalityWaitTime": 15,
  "tokenSymbol": "SOL",
  "explorer": {
    "name": "Solana Explorer",
    "url": "https://explorer.solana.com"
  },
  "contracts": {}
}
```

### Deployment Steps

1. Deploy Gateway program:

```sh
solana program-v4 deploy \
  --program-keypair <PATH_TO_GATEWAY_PROGRAM_KEYPAIR> \
  --authority <AUTHORITY_PUBKEY> \
  solana-axelar/solana/target/sbf-solana-solana/release/axelar_solana_gateway.so
```

2. Deploy Gas Service program:

```sh
solana program-v4 deploy \
  --program-keypair <PATH_TO_GAS_SERVICE_PROGRAM_KEYPAIR> \
  --authority <AUTHORITY_PUBKEY> \
  solana-axelar/solana/target/sbf-solana-solana/release/axelar_solana_gas_service.so
```

3. Deploy Governance program:

```sh
solana program-v4 deploy \
  --program-keypair <PATH_TO_GOVERNANCE_PROGRAM_KEYPAIR> \
  --authority <AUTHORITY_PUBKEY> \
  solana-axelar/solana/target/sbf-solana-solana/release/axelar_solana_governance.so
```

4. Deploy Multicall program:

```sh
solana program-v4 deploy \
  --program-keypair <PATH_TO_MULTICALL_PROGRAM_KEYPAIR> \
  --authority <AUTHORITY_PUBKEY> \
  solana-axelar/solana/target/sbf-solana-solana/release/axelar_solana_multicall.so
```

| Network              | `minimumRotationDelay` | `previousSignersRetention` |
| -------------------- | ---------------------- | -------------------------- |
| **Devnet-amplifier** | `0`                    | `15`                       |
| **Stagenet**         | `300`                  | `15`                       |
| **Testnet**          | `3600`                 | `15`                       |
| **Mainnet**          | `86400`                | `15`                       |

5. Initialize Gateway:

```sh
solana/solana-axelar-cli send gateway init \
  --previous-signers-retention <RETENTION_COUNT> \
  --minimum-rotation-delay <DELAY_IN_SECONDS> \
  --operator <OPERATOR_PUBKEY>
```

6. After deploying Solana contracts, deploy the Solana GMP Amplifier (separate documentation required).

7. Rotate genesis verifier set on Solana Gateway:

```sh
solana/solana-axelar-cli send gateway rotate \
  --signer <SIGNER_PRIVATE_KEY_HEX> \
  --nonce <CURRENT_NONCE> \
  --new-nonce <NEW_NONCE>
```

8. Update configuration with program addresses:

After deployment, the contract addresses need to be added to the corresponding configuration files so that the CLI can interact with them.

## Checklist

The following checks should be performed after the rollout:

### Verify Solana → EVM GMP call

1. Send a GMP call:

```sh
solana/solana-axelar-cli send gateway call-contract \
  --destination-chain <DESTINATION_CHAIN_NAME> \
  --destination-address <DESTINATION_ADDRESS> \
  --payload <MESSAGE_PAYLOAD_HEX>
```

2. Route GMP call via Amplifier:
   - Use the Amplifier relay mechanism to route the message.

3. Submit proof with multisig session ID:

```sh
# Change PRIVATE_KEY in .env to EVM
PRIVATE_KEY=<EVM_DEPLOYER_KEY>

node evm/gateway.js -n <DESTINATION_CHAIN> --action submitProof --multisigSessionId <MULTISIG_SESSION_ID>
```

4. Confirm message approval:

```sh
node evm/gateway.js -n <DESTINATION_CHAIN> --action isContractCallApproved --commandID <COMMAND_ID> --sourceChain $CHAIN --sourceAddress <SOURCE_ADDRESS> --destination <DESTINATION_ADDRESS> --payloadHash <PAYLOAD_HASH>
```

### Verify EVM → Solana GMP Call

1. Send a GMP call:

```sh
node evm/gateway.js -n <SOURCE_CHAIN> --action callContract --destinationChain $CHAIN --destination <DESTINATION_ADDRESS> --payload <PAYLOAD_HEX>
```

2. Route GMP call via Amplifier:
   - Use the Amplifier relay mechanism to route the message.

3. Submit proof with multisig session ID:

```sh
# Change PRIVATE_KEY in .env to Solana
PRIVATE_KEY=<SOLANA_DEPLOYER_KEY>

solana/solana-axelar-cli send gateway submit-proof \
  --multisig-session-id <MULTISIG_SESSION_ID>
```

4. Execute message:

```sh
solana/solana-axelar-cli send gateway execute \
  --source-chain <SOURCE_CHAIN_NAME> \
  --message-id <MESSAGE_ID> \
  --source-address <SOURCE_ADDRESS> \
  --destination-address <DESTINATION_PUBKEY> \
  --payload <PAYLOAD_HEX>
```
