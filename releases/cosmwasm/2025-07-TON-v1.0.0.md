# TON GMP Amplifier

|                | **Owner**                            |
| -------------- | ------------------------------------ |
| **Created By** | @dfapel <dominik@commonprefix.com>       |
| **Deployment** | @makischristou <makis@commonprefix.com> |

| **Network**          | **Deployment Status** | **Date**   |
| -------------------- | --------------------- | ---------- |
| **Devnet Amplifier** | Completed             | 2025-07-01  |
| **Stagenet**         | -             | TBD |
| **Testnet**          | -             | TBD |
| **Mainnet**          | -             | TBD |

- [Amplifier Releases](https://github.com/axelarnetwork/axelar-amplifier/releases)
- [TonVotingVerifier v1.0.0](https://github.com/commonprefix/axelar-amplifier/releases/tag/ton-voting-verifier-v1.0.0)
- [Gateway v1.1.1](https://github.com/axelarnetwork/axelar-amplifier/releases/tag/gateway-v1.1.1)
- [TonMultisigProver v1.0.0](https://github.com/axelarnetwork/axelar-amplifier/releases/tag/ton-multisig-prover-v1.0.0)

## Background

These are the instructions for deploying Amplifier contracts for TON connection.

### Pre-requisites

Ensure that the [External Gateway](../ton/2025-07-GMP-v1.0.0.md) is deployed first, as `TonVotingVerifier` needs the `sourceGatewayAddress` which is the External Gateway address.

## Deployment

- Create an `.env` config. `CHAIN` is set to `ton2` for Devnet Amplifier and should be `ton` on all other networks. `ENV` is either `devnet-amplifier`, `stagenet`, `testnet` or `mainnet`. 

```yaml
MNEMONIC=xyz
ENV=xyz
CHAIN=xyz
RELEASES_BASE_URL=https://pub-7233af746dc8432f8d9547af0133309d.r2.dev
ARTIFACT_PATH=wasm
```

- Confirm `Gateway(v1.1.1)` contract is already stored in `$ENV.json`

```bash
Gateway(v1.1.1) -> "storeCodeProposalCodeHash": "2ba600ee0d162184c9387eaf6fad655f1d75db548f93e379f0565cb2042d856f"
```

### Store Amplifier contracts

1. Download the TON CosmWasm smart contracts' wasm bytecode.

```bash
mkdir $ARTIFACT_PATH
wget $RELEASES_BASE_URL/releases/cosmwasm/ton-voting-verifier/1.0.0/ton_voting_verifier.wasm --directory-prefix=$ARTIFACT_PATH
wget $RELEASES_BASE_URL/releases/cosmwasm/ton-multisig-prover/1.0.0/ton_multisig_prover.wasm --directory-prefix=$ARTIFACT_PATH
```

2. Download and verify checksum.

```bash
wget -O checksums.txt $RELEASES_BASE_URL/releases/cosmwasm/ton-voting-verifier/1.0.0/checksums.txt
CHECKSUM=$(cat checksums.txt | grep voting_verifier.wasm | awk '{print $1}')
shasum -a 256 $ARTIFACT_PATH/ton_voting_verifier.wasm | grep $CHECKSUM

wget -O checksums.txt $RELEASES_BASE_URL/releases/cosmwasm/ton-multisig-prover/1.0.0/checksums.txt
CHECKSUM=$(cat checksums.txt | grep multisig_prover.wasm | awk '{print $1}')
shasum -a 256 $ARTIFACT_PATH/ton_multisig_prover.wasm | grep $CHECKSUM
```

3. Make sure your output matches with the following expected output before proceeding.

```
c032a01481ecc3250fa359b14b6a12cfa84f1ec3ce7f788b3975bb9767827240  wasm/ton_voting_verifier.wasm
9905f6358854c2b243edcae4bf4529109ace9c0e1897353ebeda4f977b03a982  wasm/ton_multisig_prover.wasm
```

- Add `TonVotingVerifier` and `TonMultisigProver` contract to `$ENV.json`.
```bash
# Add under `config.axelar.contracts`
"TonVotingVerifier": {},
"TonMultisigProver": {}
```

4. Add `INIT_ADDRESSES` to `.env`.

| Network              | `INIT_ADDRESSES`                                                                                                                            |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| **Devnet-amplifier** | `axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj,axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9`                                               |
| **Stagenet**         | `axelar1pumrull7z8y5kc9q4azfrmcaxd8w0779kg6anm,axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj,axelar12qvsvse32cjyw60ztysd3v655aj5urqeup82ky` |
| **Testnet**          | `axelar1uk66drc8t9hwnddnejjp92t22plup0xd036uc2,axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj,axelar12f2qn005d4vl03ssjq07quz6cja72w5ukuchv7` |
| **Mainnet**          | `axelar1uk66drc8t9hwnddnejjp92t22plup0xd036uc2,axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj,axelar1nctnr9x0qexemeld5w7w752rmqdsqqv92dw9am` |

- Gov proposal environment variables. Update these for each network

| Network              | `PROVER_ADMIN`                                  | `DEPOSIT_VALUE` | `REWARD_AMOUNT`     | `RUN_AS_ACCOUNT`                                |
| -------------------- | ----------------------------------------------- | --------------- | ------------------- | ----------------------------------------------- |
| **Devnet-amplifier** | `axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9` | `100000000`     | `1000000uamplifier` | `axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9` |
| **Stagenet**         | `axelar1l7vz4m5g92kvga050vk9ycjynywdlk4zhs07dv` | `100000000`     | `1000000uaxl`       | `axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj` |
| **Testnet**          | `axelar17qafmnc4hrfa96cq37wg5l68sxh354pj6eky35` | `2000000000`    | `1000000uaxl`       | `axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj` |
| **Mainnet**          | `axelar1pczf792wf3p3xssk4dmwfxrh6hcqnrjp70danj` | `2000000000`    | `1000000uaxl`       | `axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj` |

```bash
PROVER_ADMIN=[prover admin who is responsible for the contract's operations]
DEPOSIT_VALUE=[deposit value]
REWARD_AMOUNT=[reward amount]
RUN_AS_ACCOUNT=[wasm deployer/governance address]
```

> **_NOTE:_**
> Set `RUN_AS_ACCOUNT` to an EOA account's address instead of the governance address to avoid having to instantiate the contracts via another governance proposal.

- Store `TonVotingVerifier`

```bash
ts-node cosmwasm/submit-proposal.js store \
  -c TonVotingVerifier \
  -t "Upload TonVotingVerifier contract v1.0.0" \
  -d "Upload TonVotingVerifier contract v1.0.0" \
  -a "$ARTIFACT_PATH/ton_voting_verifier.wasm" \
  --deposit $DEPOSIT_VALUE \
  --instantiateAddresses $INIT_ADDRESSES
```

- Store `TonMultisigProver`

```bash
ts-node cosmwasm/submit-proposal.js store \
  -c TonMultisigProver \
  -t "Upload TonMultisigProver contract v1.0.0" \
  -d "Upload TonMultisigProver contract v1.0.0" \
  -a "$ARTIFACT_PATH/ton_multisig_prover.wasm" \
  --deposit $DEPOSIT_VALUE \
  --instantiateAddresses $INIT_ADDRESSES
```

- Add config in `$ENV.json` to deploy Amplifier contracts.

| Network              | `governanceAddress`                             | `adminAddress`                                  |
| -------------------- | ----------------------------------------------- | ----------------------------------------------- |
| **Devnet-amplifier** | `axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9` | `axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9` |
| **Stagenet**         | `axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj` | `axelar1l7vz4m5g92kvga050vk9ycjynywdlk4zhs07dv` |
| **Testnet**          | `axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj` | `axelar17qafmnc4hrfa96cq37wg5l68sxh354pj6eky35` |
| **Mainnet**          | `axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj` | `axelar1pczf792wf3p3xssk4dmwfxrh6hcqnrjp70danj` |

| Network              | `serviceName` | `votingThreshold` | `signingThreshold` |
| -------------------- | ------------- | ----------------- | ------------------ |
| **Devnet-amplifier** | `validators`  | `["6", "10"]`     | `["6", "10"]`      |
| **Stagenet**         | `amplifier`   | `["51", "100"]`   | `["51", "100"]`    |
| **Testnet**          | `amplifier`   | `["51", "100"]`   | `["51", "100"]`    |
| **Mainnet**          | `amplifier`   | `["2", "3"]`      | `["2", "3"]`       |

```bash
GOVERNANCE_ADDRESS=
SERVICE_NAME=
SOURCE_GATEWAY_ADDRESS=[the address of the TON edge gateway]
VOTING_THRESHOLD=
ADMIN_ADDRESS=
```

Add under `config.axelar.contracts.TonVotingVerifier` based on Network:
```bash
\"$CHAIN\" : {
  "governanceAddress": "$GOVERNANCE_ADDRESS",
  "serviceName": "$SERVICE_NAME",
  "sourceGatewayAddress": "$SOURCE_GATEWAY_ADDRESS",
  "votingThreshold": "$VOTING_THRESHOLD",
  "msgIdFormat": "hex_tx_hash",
  "addressFormat": "ton"
}
```

Add under `config.axelar.contracts.TonMultisigProver` based on Network
```bash
\"$CHAIN\" : {
  "governanceAddress": "$GOVERNANCE_ADDRESS",
  "adminAddress": "$ADMIN_ADDRESS",
  "signingThreshold": "$SIGNING_THRESHOLD",
  "serviceName": "$SERVICE_NAME",
  "verifierSetDiffThreshold": 0,
  "encoder": "ton",
  "keyType": "ed25519"
}
```

### Instantiate Amplifier contracts

| Network              | `CONTRACT_ADMIN`                                |
| -------------------- | ----------------------------------------------- |
| **Devnet-amplifier** | `axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9` |
| **Stagenet**         | `axelar12qvsvse32cjyw60ztysd3v655aj5urqeup82ky` |
| **Testnet**          | `axelar12f2qn005d4vl03ssjq07quz6cja72w5ukuchv7` |
| **Mainnet**          | `axelar1nctnr9x0qexemeld5w7w752rmqdsqqv92dw9am` |

```bash
CONTRACT_ADMIN=[wasm contract admin address for the upgrade and migration based on network]
```

1. Instantiate `VotingVerifier`

```bash
ts-node ./cosmwasm/deploy-contract.js instantiate -c TonVotingVerifier --fetchCodeId --instantiate2 --admin $CONTRACT_ADMIN
```

2. Instantiate `Gateway`

```bash
ts-node ./cosmwasm/deploy-contract.js instantiate -c Gateway --fetchCodeId --instantiate2 --admin $CONTRACT_ADMIN
```

3. Instantiate `MultisigProver`

```bash
ts-node ./cosmwasm/deploy-contract.js instantiate -c TonMultisigProver --fetchCodeId --instantiate2 --admin $CONTRACT_ADMIN
```

**Note**:
Additionally add the address of the instantiated TonMultisigProver to `config.axelar.contracts.MultisigProver` as well to allow to use the canonical cosmwasm scripts (e.g., signer rotation).

4. Set environment variables

- Network-specific environment variables: These variables need to be updated by the network.

```bash
VOTING_VERIFIER=$(cat "./axelar-chains-config/info/$ENV.json" | jq ".axelar.contracts.TonVotingVerifier[\"$CHAIN\"].address" | tr -d '"')
GATEWAY=$(cat "./axelar-chains-config/info/$ENV.json" | jq ".axelar.contracts.Gateway[\"$CHAIN\"].address" | tr -d '"')
MULTISIG_PROVER=$(cat "./axelar-chains-config/info/$ENV.json" | jq ".axelar.contracts.TonMultisigProver[\"$CHAIN\"].address" | tr -d '"')
MULTISIG=$(cat "./axelar-chains-config/info/$ENV.json" | jq ".axelar.contracts.Multisig.address" | tr -d '"')
REWARDS=$(cat "./axelar-chains-config/info/$ENV.json" | jq ".axelar.contracts.Rewards.address" | tr -d '"')
ROUTER=$(cat "./axelar-chains-config/info/$ENV.json" | jq ".axelar.contracts.Router.address" | tr -d '"')
```

5. Register TON Gateway at the Router

```bash
ts-node cosmwasm/submit-proposal.js execute \
  -c Router \
  -t "Register Gateway for TON" \
  -d "Register Gateway address for TON at Router contract" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"register_chain\": {
      \"chain\": \"$CHAIN\",
      \"gateway_address\": \"$GATEWAY\",
      \"msg_id_format\": \"hex_tx_hash\"
      }
    }"
```

- Approve Proposal (must be done within 5 minutes on devnet-amplifier/stagenet and 1 hour on testnet/mainnet)

- Verify Gateway Registration:

```bash
axelard q wasm contract-state smart $ROUTER "{\"chain_info\": \"$CHAIN\"}" --output json --node [axelar rpc address] | jq .
```

```bash
# You should see something like this:
{
  "data": {
    "name": "ton2",
    "gateway": {
      "address": "axelar1qr2e4l4ap6wef7gdd5de9sr3hvzgw46ctp2e0axd598alt6nu6aqusaaw3"
    },
    "frozen_status": 0,
    "msg_id_format": "hex_tx_hash"
  }
}
```

6. Register prover contract on coordinator

```bash
ts-node cosmwasm/submit-proposal.js execute \
  -c Coordinator \
  -t "Register Multisig Prover for TON" \
  -d "Register Multisig Prover address for $CHAIN at Coordinator contract" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"register_prover_contract\": {
      \"chain_name\": \"$CHAIN\",
      \"new_prover_addr\": \"$MULTISIG_PROVER\"
    }
  }"
```

7. Authorize TON Multisig prover on Multisig

```bash
ts-node cosmwasm/submit-proposal.js execute \
  -c Multisig \
  -t "Authorize Multisig Prover for TON" \
  -d "Authorize Multisig Prover address for $CHAIN at Multisig contract" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"authorize_callers\": {
      \"contracts\": {
        \"$MULTISIG_PROVER\": \"$CHAIN\"
      }
    }
  }"
```

```bash
axelard q wasm contract-state smart $MULTISIG "{\"is_caller_authorized\": {\"contract_address\": \"$MULTISIG_PROVER\", \"chain_name\": \"$CHAIN\"}}" --output json --node [axelar rpc address] --chain-id $ENV | jq .

# Result should look like:
{
  "data": true
}
```

8. Create reward pool for voting verifier

#### Rewards

| Network              | `epoch_duration` | `participation_threshold` | `rewards_per_epoch` |
| -------------------- | ---------------- | ------------------------- | ------------------- |
| **Devnet-amplifier** | `100`            | `["7", "10"]`             | `100`               |
| **Stagenet**         | `600`            | `["7", "10"]`             | `100`               |
| **Testnet**          | `14845`          | `["7", "10"]`             | `100`               |
| **Mainnet**          | `14845`          | `["8", "10"]`             | `1260000000`        |

```bash
EPOCH_DURATION=
PARTICIPATION_THRESHOLD=
REWARDS_PER_EPOCH=
```

```bash
ts-node cosmwasm/submit-proposal.js execute \
  -c Rewards \
  -t "Create pool for TON in $CHAIN voting verifier" \
  -d "Create pool for TON in $CHAIN voting verifier" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"create_pool\": {
      \"params\": {
        \"epoch_duration\": \"$EPOCH_DURATION\",
        \"participation_threshold\": $PARTICIPATION_THRESHOLD,
        \"rewards_per_epoch\": \"$REWARDS_PER_EPOCH\"
      },
      \"pool_id\": {
        \"chain_name\": \"$CHAIN\",
        \"contract\": \"$VOTING_VERIFIER\"
      }
    }
  }"
```

9. Create reward pool for multisig

```bash
ts-node cosmwasm/submit-proposal.js execute \
  -c Rewards \
  -t "Create pool for TON in $CHAIN multisig" \
  -d "Create pool for TON in $CHAIN multisig" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"create_pool\": {
      \"params\": {
        \"epoch_duration\": \"$EPOCH_DURATION\",
        \"participation_threshold\": [$PARTICIPATION_THRESHOLD],
        \"rewards_per_epoch\": \"$REWARDS_PER_EPOCH\"
      },
      \"pool_id\": {
        \"chain_name\": \"$CHAIN\",
        \"contract\": \"$MULTISIG\"
      }
    }
  }"
```

10. Update ampd config file with the TON chain configuration. Verifiers should use their own TON RPC node for the `rpc_url` in production.

| Network              | `rpc_url`                             |
| -------------------- | -------------------------------------- |
| **Devnet-amplifier** | `https://testnet.toncenter.com/api/v3` |
| **Stagenet**         | `https://testnet.toncenter.com/api/v3` |
| **Testnet**          | `https://testnet.toncenter.com/api/v3` |
| **Mainnet**          | `https://toncenter.com/api/v3`          |

```bash
RPC_URL=
```

```toml
[[handlers]]
type="TonMsgVerifier"
rpc_url="$RPC_URL"
cosmwasm_contract="$VOTING_VERIFIER"

[[handlers]]
type="TonVerifierSetVerifier"
rpc_url="$RPC_URL"
cosmwasm_contract="$VOTING_VERIFIER"

[[handlers]]
type="MultisigSigner"
chain_name="$CHAIN"
cosmwasm_contract="$MULTISIG"
```

11. Register chain support for 

```bash
ampd register-public-key ed25519

ampd register-chain-support $SERVICE_NAME $CHAIN
```

12. Add funds to reward pools from a wallet containing the reward funds `$REWARD_AMOUNT`

```bash
axelard tx wasm execute $REWARDS "{ \"add_rewards\": { \"pool_id\": { \"chain_name\": \"$CHAIN\", \"contract\": \"$MULTISIG\" } } }" --amount $REWARD_AMOUNT --from $WALLET
axelard tx wasm execute $REWARDS "{ \"add_rewards\": { \"pool_id\": { \"chain_name\": \"$CHAIN\", \"contract\": \"$VOTING_VERIFIER\" } } }" --amount $REWARD_AMOUNT --from $WALLET

# Check reward pool to confirm funding worked
ts-node cosmwasm/query.js rewards -n $CHAIN
```

13. Create genesis verifier set

Note that this step can only be run once a sufficient number of verifiers have registered.

```bash
axelard tx wasm execute $MULTISIG_PROVER '"update_verifier_set"' --from $PROVER_ADMIN --gas auto --gas-adjustment 1.2

# Query the multisig prover for active verifier set
axelard q wasm contract-state smart $MULTISIG_PROVER '"current_verifier_set"'
```

## Checklist

The [TON GMP checklist](../ton/2025-07-GMP-v1.0.0.md) will test GMP call.
