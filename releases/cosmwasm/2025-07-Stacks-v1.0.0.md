# Stacks Amplifier

|                | **Owner**                                                                   |
|----------------|-----------------------------------------------------------------------------|
| **Created By** | @raress96 <rares.serban@buidly.com>                                         |
| **Deployment** | @blockchainguyy <ayush@interoplabs.io>, @raress96 <rares.serban@buidly.com> |

| **Network**          | **Deployment Status** | **Date**   |
|----------------------|-----------------------|------------|
| **Devnet Amplifier** | Deployed              | 2025-05-09 |
| **Stagenet**         | -                     | TBD        |
| **Testnet**          | -                     | TBD        |
| **Mainnet**          | -                     | TBD        |

- [Amplifier Releases TBD](https://github.com/axelarnetwork/axelar-amplifier/pull/728)
- [StacksVotingVerifier v1.0.0 TBD](https://github.com/Trust-Machines/axelar-amplifier/pull/6)
- [Gateway v1.1.1](https://github.com/axelarnetwork/axelar-amplifier/releases/tag/gateway-v1.1.1)
- [StacksMultisigProver v1.0.0 TBD](https://github.com/Trust-Machines/axelar-amplifier/pull/6)

## Background

These are the instructions for deploying Amplifier contracts for the Stacks connection.

### Pre-requisites

Ensure that the [Stacks contracts](../stacks/2025-05-v1.0.0.md) are deployed (but not yet **setup**!) before deploying the
Axelar contracts as the `StacksVotingVerifier` needs the `sourceGatewayAddress` which is the Stacks Gateway Storage.

You can run to make sure all the contracts are deployed:

```bash
node stacks/check-contracts.js
```

## Deployment

| Network              | `DEPOSIT_VALUE` |
|----------------------|-----------------|
| **Devnet-amplifier** | `100000000`     |
| **Testnet**          | `2000000000`    |
| **Mainnet**          | `2000000000`    |

- Create an `.env` config.

```yaml
MNEMONIC=xyz
ENV=xyz
CHAIN=stacks
RELEASES_BASE_URL=https://tm-axelar-amplifier.goodforbitcoin.xyz
ARTIFACT_PATH=wasm
DEPOSIT_VALUE=
```

- Add config in `$ENV.json` to deploy Amplifier contracts.

| Network              | `governanceAddress`                             | `adminAddress`                                  |
|----------------------|-------------------------------------------------|-------------------------------------------------|
| **Devnet-amplifier** | `axelar1e98ervm2x6jt58szwyg99dn6ts77v2clkvytrc` | `axelar1e98ervm2x6jt58szwyg99dn6ts77v2clkvytrc` |
| **Testnet**          | `axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj` | `axelar17qafmnc4hrfa96cq37wg5l68sxh354pj6eky35` |
| **Mainnet**          | `axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj` | `axelar1pczf792wf3p3xssk4dmwfxrh6hcqnrjp70danj` |

| Network              | `serviceName` | `votingThreshold` | `signingThreshold` | `confirmationHeight` | `msgIdFormat`                 | `addressFormat` | `encoder` |
|----------------------|---------------|-------------------|--------------------|----------------------|-------------------------------|-----------------|-----------|
| **Devnet-amplifier** | `validators`  | `["2", "3"]`      | `["2", "3"]`       | `1`                  | `hex_tx_hash_and_event_index` | `stacks`        | `stacks`  |
| **Testnet**          | `amplifier`   | `["51", "100"]`   | `["51", "100"]`    | `1`                  | `hex_tx_hash_and_event_index` | `stacks`        | `stacks`  |
| **Mainnet**          | `amplifier`   | `["2", "3"]`      | `["2", "3"]`       | `1`                  | `hex_tx_hash_and_event_index` | `stacks`        | `stacks`  |

```bash
# Add under `config.axelar.contracts.StacksAbiTransformer` based on Network
\"$CHAIN\" : {
}

# Add under `config.axelar.contracts.StacksVotingVerifier` based on Network
\"$CHAIN\" : {
  "governanceAddress": "[governance address]",
  "serviceName": "[service name]",
  "sourceGatewayAddress": "[external gateway storage address]",
  "votingThreshold": "[voting threshold]",
  "blockExpiry": 10,
  "confirmationHeight": 1,
  "msgIdFormat": "hex_tx_hash_and_event_index",
  "addressFormat": "stacks"
}

# Add under `config.axelar.contracts.StacksMultisigProver` based on Network
\"$CHAIN\" : {
  "governanceAddress": "[governance address]",
  "adminAddress": "[admin address]",
  "signingThreshold": "[signing threshold]",
  "serviceName": "[service name]",
  "verifierSetDiffThreshold": 1,
  "encoder": "stacks",
  "keyType": "ecdsa"
}
```

### Store Amplifier contracts

1. Download the Stacks CosmWasm smart contracts' wasm bytecode. TBD

```bash
mkdir $ARTIFACT_PATH
wget $RELEASES_BASE_URL/pre-releases/cosmwasm/f863b56/voting_verifier.wasm --directory-prefix=$ARTIFACT_PATH
wget $RELEASES_BASE_URL/pre-releases/cosmwasm/f863b56/multisig_prover.wasm --directory-prefix=$ARTIFACT_PATH
wget $RELEASES_BASE_URL/pre-releases/cosmwasm/f863b56/stacks_abi_transformer.wasm --directory-prefix=$ARTIFACT_PATH
```

2. Download and verify checksum.

```bash
wget -O checksums.txt $RELEASES_BASE_URL/pre-releases/cosmwasm/f863b56/checksums.txt
CHECKSUM=$(cat checksums.txt | grep voting_verifier.wasm | awk '{print $1}')
shasum -a 256 $ARTIFACT_PATH/voting_verifier.wasm | grep $CHECKSUM

wget -O checksums.txt $RELEASES_BASE_URL/pre-releases/cosmwasm/f863b56/checksums.txt
CHECKSUM=$(cat checksums.txt | grep multisig_prover.wasm | awk '{print $1}')
shasum -a 256 $ARTIFACT_PATH/multisig_prover.wasm | grep $CHECKSUM

wget -O checksums.txt $RELEASES_BASE_URL/pre-releases/cosmwasm/f863b56/checksums.txt
CHECKSUM=$(cat checksums.txt | grep stacks_abi_transformer.wasm | awk '{print $1}')
shasum -a 256 $ARTIFACT_PATH/stacks_abi_transformer.wasm | grep $CHECKSUM
```

3. Make sure your output matches with the following expected output before proceeding.

```
bd826cfd1f7b46b5fae703b56590b6b80c3501d667b52f6781d5a8803d3b9098  wasm/voting_verifier.wasm
ca23280ad6ac865d4ff32426a764051a0f5e1ea48b260a0ae9ae5b4405bfc926  wasm/multisig_prover.wasm
9eed64f761969979fe0be46e26b42f958f2103ebfdeb7edc76d393dfe0e691c0  wasm/stacks_abi_transformer.wasm
```

4. Store `StacksAbiTransformer`

```bash
node cosmwasm/submit-proposal.js store \
  -c StacksAbiTransformer \
  -a "$ARTIFACT_PATH/stacks_abi_transformer.wasm"
```

5. Store `StacksVotingVerifier`.

```bash
node cosmwasm/submit-proposal.js store \
  -c StacksVotingVerifier \
  -a "$ARTIFACT_PATH/voting_verifier.wasm"
```

6. Store `StacksMultisigProver`.

```bash
node cosmwasm/submit-proposal.js store \
  -c StacksMultisigProver \
  -a "$ARTIFACT_PATH/multisig_prover.wasm"
```

### Instantiate Amplifier contracts

- Confirm `StacksAbiTransformer(v1.0.0)`, `StacksVotingVerifier(v1.0.0)`, `Gateway(v1.1.1)` and `StacksMultisigProver(v1.0.0)` contracts are already stored in `$ENV.json`:

```bash
StacksAbiTransformer(v1.0.0) -> "storeCodeProposalCodeHash": "TBD"
StacksVotingVerifier(v1.0.0) -> "storeCodeProposalCodeHash": "TBD"
Gateway (v1.1.1) -> "storeCodeProposalCodeHash": "2ba600ee0d162184c9387eaf6fad655f1d75db548f93e379f0565cb2042d856f"
StacksMultisigProver(v1.0.0) -> "storeCodeProposalCodeHash": "TBD"
```

| Network              | `CONTRACT_ADMIN`                                |
|----------------------|-------------------------------------------------|
| **Devnet-amplifier** | `axelar1e98ervm2x6jt58szwyg99dn6ts77v2clkvytrc` |
| **Testnet**          | `axelar12f2qn005d4vl03ssjq07quz6cja72w5ukuchv7` |
| **Mainnet**          | `axelar1nctnr9x0qexemeld5w7w752rmqdsqqv92dw9am` |

```bash
CONTRACT_ADMIN=[wasm contract admin address for the upgrade and migration based on network]
```

1. Instantiate `StacksAbiTransformer`.

```bash
node ./cosmwasm/deploy-contract.js instantiate -c StacksAbiTransformer --fetchCodeId --instantiate2 --admin $CONTRACT_ADMIN
```

2. Instantiate `StacksVotingVerifier`.

```bash
node ./cosmwasm/deploy-contract.js instantiate -c StacksVotingVerifier --fetchCodeId --instantiate2 --admin $CONTRACT_ADMIN
```

3. Instantiate `Gateway`.

```bash
node ./cosmwasm/deploy-contract.js instantiate -c Gateway --fetchCodeId --instantiate2 --admin $CONTRACT_ADMIN
```

4. Instantiate `StacksMultisigProver`.

```bash
node ./cosmwasm/deploy-contract.js instantiate -c StacksMultisigProver --fetchCodeId --instantiate2 --admin $CONTRACT_ADMIN
```

5. Set environment variables.

- Network-specific environment variables: These variables need to be updated by the network.

```bash
STACKS_ABI_TRANSFORMER=$(cat ./axelar-chains-config/info/$ENV.json | jq ".axelar.contracts.StacksAbiTransformer[\"$CHAIN\"].address" | tr -d '"')
STACKS_VOTING_VERIFIER=$(cat ./axelar-chains-config/info/$ENV.json | jq ".axelar.contracts.StacksVotingVerifier[\"$CHAIN\"].address" | tr -d '"')
GATEWAY=$(cat ./axelar-chains-config/info/$ENV.json | jq ".axelar.contracts.Gateway[\"$CHAIN\"].address" | tr -d '"')
STACKS_MULTISIG_PROVER=$(cat ./axelar-chains-config/info/$ENV.json | jq ".axelar.contracts.StacksMultisigProver[\"$CHAIN\"].address" | tr -d '"')
MULTISIG=$(cat ./axelar-chains-config/info/$ENV.json | jq .axelar.contracts.Multisig.address | tr -d '"')
REWARDS=$(cat ./axelar-chains-config/info/$ENV.json | jq .axelar.contracts.Rewards.address | tr -d '"')
ROUTER=$(cat ./axelar-chains-config/info/$ENV.json | jq .axelar.contracts.Router.address | tr -d '"')
```

- Gov proposal environment variables. Update these for each network

| Network              | `PROVER_ADMIN`                                  | `REWARD_AMOUNT`     |
|----------------------|-------------------------------------------------|---------------------|
| **Devnet-amplifier** | `axelar1e98ervm2x6jt58szwyg99dn6ts77v2clkvytrc` | `1000000uamplifier` |
| **Testnet**          | `axelar17qafmnc4hrfa96cq37wg5l68sxh354pj6eky35` | `1000000uaxl`       |
| **Mainnet**          | `axelar1pczf792wf3p3xssk4dmwfxrh6hcqnrjp70danj` | `1000000uaxl`       |

```bash
PROVER_ADMIN=[prover admin who is responsible for the contract's operations]
REWARD_AMOUNT=[reward amount]
RUN_AS_ACCOUNT=[wasm deployer/governance address]
```

> **_NOTE:_** > `--runAs $RUN_AS_ACCOUNT` is only required for Devnet-amplifier. Do not use `--runAs` for Stagenet,
> Testnet, or Mainnet.

> **_NOTE:_**
> Add a community post for the Mainnet Proposal. e.g., https://www.mintscan.io/axelar/proposals/274

6. Register `Gateway` on the Router.

```bash
node cosmwasm/submit-proposal.js execute \
  -c Router \
  -t "Register Gateway for $CHAIN" \
  -d "Register Gateway address for $CHAIN at Router contract" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"register_chain\": {
      \"chain\": \"$CHAIN\",
      \"gateway_address\": \"$GATEWAY\",
      \"msg_id_format\": \"hex_tx_hash_and_event_index\"
      }
    }"
```

```bash
axelard q wasm contract-state smart $ROUTER "{\"chain_info\": \"$CHAIN\"}" --output json | jq .

# You should see something like this:
{
  "data": {
    "name": "<chain-name>",
    "gateway": {
      "address": "axelar1r5aggjq5d5np83ejq5ynt7ah30y9srk84es3xatnyc9k4nmq7grsc7qnda"
    },
    "frozen_status": 0,
    "msg_id_format": "hex_tx_hash_and_event_index"
  }
}
```

7. Update `ampd` with the Stacks chain configuration. Verifiers should use their own Hiro API nodes for the `http_url`
   in production.

| Network              | `http_url`                    |
|----------------------|-------------------------------|
| **Devnet-amplifier** | `https://api.testnet.hiro.so` |
| **Testnet**          | `https://api.testnet.hiro.so` |
| **Mainnet**          | `https://localhost:1234`      |

```bash
[[handlers]]
type="StacksMsgVerifier"
chain_name = 'stacks'
http_url=[http url]
cosmwasm_contract="$STACKS_VOTING_VERIFIER"

[[handlers]]
type="StacksVerifierSetVerifier"
chain_name = 'stacks'
http_url=[http url]
cosmwasm_contract="$STACKS_VOTING_VERIFIER"
```

8. Verifiers should register their ECDSA public key (if they haven't already) and register Stacks chain support.

```bash
ampd register-public-key ecdsa

ampd register-chain-support "[service name]" $CHAIN
```

9. Register `StacksMultisigProver` contract on coordinator.

```bash
node cosmwasm/submit-proposal.js execute \
  -c Coordinator \
  -t "Register Multisig Prover for $CHAIN" \
  -d "Register Multisig Prover address for $CHAIN at Coordinator contract" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"register_prover_contract\": {
      \"chain_name\": \"$CHAIN\",
      \"new_prover_addr\": \"$STACKS_MULTISIG_PROVER\"
    }
  }"
```

10. Authorize `StacksMultisigProver` on Multisig.

```bash
node cosmwasm/submit-proposal.js execute \
  -c Multisig \
  -t "Authorize Multisig Prover for $CHAIN" \
  -d "Authorize Multisig Prover address for $CHAIN at Multisig contract" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"authorize_callers\": {
      \"contracts\": {
        \"$STACKS_MULTISIG_PROVER\": \"$CHAIN\"
      }
    }
  }"
```

```bash
axelard q wasm contract-state smart $MULTISIG "{\"is_caller_authorized\": {\"contract_address\": \"$STACKS_MULTISIG_PROVER\", \"chain_name\": \"$CHAIN\"}}" --output json | jq .

# Result should look like:
{
  "data": true
}
```

11. Create reward pool for `StacksVotingVerifier`.

#### Rewards

| Network              | `epoch_duration` | `participation_threshold` | `rewards_per_epoch` |
|----------------------|------------------|---------------------------|---------------------|
| **Devnet-amplifier** | `100`            | `["7", "10"]`             | `100`               |
| **Testnet**          | `14845`          | `["7", "10"]`             | `100`               |
| **Mainnet**          | `14845`          | `["8", "10"]`             | `TBD`               |

```bash
node cosmwasm/submit-proposal.js execute \
  -c Rewards \
  -t "Create pool for $CHAIN Voting Verifier" \
  -d "Create pool for $CHAIN Voting Verifier" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"create_pool\": {
      \"params\": {
        \"epoch_duration\": \"[epoch duration]\",
        \"participation_threshold\": [participation threshold],
        \"rewards_per_epoch\": \"[rewards per epoch]\"
      },
      \"pool_id\": {
        \"chain_name\": \"$CHAIN\",
        \"contract\": \"$STACKS_VOTING_VERIFIER\"
      }
    }
  }"
```

12. Create reward pool for Multisig.

```bash
node cosmwasm/submit-proposal.js execute \
  -c Rewards \
  -t "Create pool for $CHAIN in Axelar Multisig" \
  -d "Create pool for $CHAIN in Axelar Multisig" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"create_pool\": {
      \"params\": {
        \"epoch_duration\": \"[epoch duration]\",
        \"participation_threshold\": [participation threshold],
        \"rewards_per_epoch\": \"[rewards per epoch]\"

      },
      \"pool_id\": {
        \"chain_name\": \"$CHAIN\",
        \"contract\": \"$MULTISIG\"
      }
    }
  }"
```

13. Add funds to reward pools from a wallet with `$REWARD_AMOUNT`.

```bash
axelard tx wasm execute $REWARDS "{ \"add_rewards\": { \"pool_id\": { \"chain_name\": \"$CHAIN\", \"contract\": \"$MULTISIG\" } } }" --amount $REWARD_AMOUNT --from $WALLET

axelard tx wasm execute $REWARDS "{ \"add_rewards\": { \"pool_id\": { \"chain_name\": \"$CHAIN\", \"contract\": \"$STACKS_VOTING_VERIFIER\" } } }" --amount $REWARD_AMOUNT --from $WALLET
```

14. Ensure the reward pools were created correctly.

```bash
node cosmwasm/query.js rewards -n $CHAIN
```

15. Create genesis verifier set

Note that this step can only be run once a sufficient number of verifiers have registered.

| Network              | `min_num_verifiers` |
|----------------------|---------------------|
| **Devnet-amplifier** | 2                   |
| **Testnet**          | 21                  |
| **Mainnet**          | 25                  |

```bash
axelard tx wasm execute $STACKS_MULTISIG_PROVER '"update_verifier_set"' --from $PROVER_ADMIN --gas auto --gas-adjustment 1.2
```

Query the multisig prover for active verifier set

```bash
axelard q wasm contract-state smart $STACKS_MULTISIG_PROVER '"current_verifier_set"'
```

## Next Steps

At this point you should proceed to the [Stacks Deployment: Phase 2](../stacks/2025-05-v1.0.0.md), which will setup the
Stacks contracts with appropriate initial verifier set etc.

## Checklist

The [Stacks checklist](../stacks/2025-05-v1.0.0.md) will test GMP & ITS calls.
