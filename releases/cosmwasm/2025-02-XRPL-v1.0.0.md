# XRPL Amplifier

|                | **Owner**                        |
| -------------- | -------------------------------- |
| **Created By** | @k4m4 <nikolas@commonprefix.com> |
| **Deployment** | @k4m4 <nikolas@commonprefix.com> |

| **Network**          | **Deployment Status** | **Date**   |
| -------------------- | --------------------- | ---------- |
| **Devnet Amplifier** | Deployed              | 2025-01-29 |
| **Stagenet**         | -                     | TBD        |
| **Testnet**          | -                     | TBD        |
| **Mainnet**          | -                     | TBD        |

- [Amplifier Releases](https://github.com/commonprefix/axelar-amplifier/releases)
- [XRPLVotingVerifier v1.1.0](https://github.com/commonprefix/axelar-amplifier/releases/tag/xrpl-voting-verifier-v1.1.0)
- [XRPLGateway v1.1.1](https://github.com/commonprefix/axelar-amplifier/releases/tag/xrpl-gateway-v1.1.1)
- [XRPLMultisigProver v1.1.1](https://github.com/commonprefix/axelar-amplifier/releases/tag/xrpl-multisig-prover-v1.1.1)

## Background

These are the instructions for deploying Amplifier contracts for the XRPL connection.

### Pre-requisites

Ensure that the [XRPL multisig account](../xrpl/2025-02-v1.0.0.md) is created and configured first, as `XRPLVotingVerifier` needs the XRPL multisig account's address as `sourceGatewayAddress` and the `XRPLGateway` and `XRPLMultisigProver` contracts need it as `xrplMultisigAddress`.

## Deployment

- Create an `.env` config. `CHAIN` should be set to `xrpl` for mainnet, and `xrpl-test-1` for all other networks.

```yaml
MNEMONIC=xyz
ENV=xyz
CHAIN=xyz
```

- Confirm `XrplVotingVerifier(v1.1.0)`, `XrplGateway(v1.1.1)` and `XrplMultisigProver(v1.1.1)` contracts are already stored in `$ENV.json`

```bash
XrplVotingVerifier(v1.1.0) -> "storeCodeProposalCodeHash": "0x123"
XrplGateway(v1.1.1) -> "storeCodeProposalCodeHash": "0xabc"
XrplMultisigProver(v1.1.1) -> "storeCodeProposalCodeHash": "0xdef"
```

- Add config in `$ENV.json` to deploy Amplifier contracts.

| Network              | `governanceAddress`                             | `adminAddress`                                  |
| -------------------- | ----------------------------------------------- | ----------------------------------------------- |
| **Devnet-amplifier** | `axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9` | `axelar1lsasewgqj7698e9a25v3c9kkzweee9cvejq5cs` |
| **Stagenet**         | `axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj` | `axelar1l7vz4m5g92kvga050vk9ycjynywdlk4zhs07dv` |
| **Testnet**          | `axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj` | `axelar17qafmnc4hrfa96cq37wg5l68sxh354pj6eky35` |
| **Mainnet**          | `axelar10d07y265gmmuvt4z0w9aw880jnsr700j7v9daj` | `axelar1pczf792wf3p3xssk4dmwfxrh6hcqnrjp70danj` |

| Network              | `serviceName` | `votingThreshold` | `signingThreshold` | `confirmationHeight` |
| -------------------- | ------------- | ----------------- | ------------------ | -------------------- |
| **Devnet-amplifier** | `validators`  | `["2", "3"]`      | `["2", "3"]`       | `1`                  |
| **Stagenet**         | `amplifier`   | `["51", "100"]`   | `["51", "100"]`    | `1`                  |
| **Testnet**          | `amplifier`   | `["51", "100"]`   | `["51", "100"]`    | `1`                  |
| **Mainnet**          | `amplifier`   | `["2", "3"]`      | `["2", "3"]`       | `1`                  |

```bash
# Add under `config.axelar.contracts.XrplGateway` based on Network
\"$CHAIN\" : {
  "governanceAddress": "axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9",
  "adminAddress": "axelar1lsasewgqj7698e9a25v3c9kkzweee9cvejq5cs"
}

# Add under `config.axelar.contracts.XrplVotingVerifier` based on Network
\"$CHAIN\" : {
  "governanceAddress": "[governance address]",
  "serviceName": "[service name]",
  "votingThreshold": [
    "2",
    "3"
  ],
  "blockExpiry": 5,
  "confirmationHeight": 1,
}

XRPL_RPC_URL="https://s.devnet.rippletest.net:51234"
XRPL_MULTISIG_ADDRESS="rGAbJZEzU6WaYv5y1LfyN7LBBcQJ3TxsKC"
XRPL_AVAILABLE_TICKETS=$(curl -s -X POST $XRPL_RPC_URL -d '{
    "method": "account_objects",
    "params": [{
        "limit": 1000,
        "account": "'$XRPL_MULTISIG_ADDRESS'",
        "ledger_index": "validated",
        "type": "ticket"
    }]
  }' -H "Content-Type: application/json" | jq '.result.account_objects | map(select(.LedgerEntryType == "Ticket") | .TicketSequence)' -c)
XRPL_LAST_ASSIGNED_TICKET_NUMBER=$(echo $XRPL_AVAILABLE_TICKETS | jq 'min | . - 1' -c)
XRPL_NEXT_SEQUENCE_NUMBER=$(curl -s -X POST $XRPL_RPC_URL -d '{
    "method": "account_info",
    "params": [{
        "account": "'$XRPL_MULTISIG_ADDRESS'",
        "ledger_index": "current",
        "strict": true
    }]
  }' -H "Content-Type: application/json" | jq '.result.account_data.Sequence')

# Add under `config.axelar.contracts.XRPLMultisigProver` based on Network
\"$CHAIN\" : {
  "governanceAddress": "[governance address]",
  "adminAddress": "[admin address]",
  "signingThreshold": "[signing threshold]",
  "serviceName": "[service name]",
  "verifierSetDiffThreshold": 1,
  "xrplFee": 300,
  "ticketCountThreshold": 5,
  "availableTickets": $XRPL_AVAILABLE_TICKETS,
  "nextSequenceNumber": $XRPL_NEXT_SEQUENCE_NUMBER,
  "lastAssignedTicketNumber": $XRPL_LAST_ASSIGNED_TICKET_NUMBER
}
```

### Instantiate Amplifier contracts

| Network              | `CONTRACT_ADMIN`                                |
| -------------------- | ----------------------------------------------- |
| **Devnet-amplifier** | `axelar1lsasewgqj7698e9a25v3c9kkzweee9cvejq5cs` |
| **Stagenet**         | `axelar12qvsvse32cjyw60ztysd3v655aj5urqeup82ky` |
| **Testnet**          | `axelar12f2qn005d4vl03ssjq07quz6cja72w5ukuchv7` |
| **Mainnet**          | `axelar1nctnr9x0qexemeld5w7w752rmqdsqqv92dw9am` |

```bash
CONTRACT_ADMIN=[wasm contract admin address for the upgrade and migration based on network]
```

1. Instantiate `XRPLVotingVerifier`.

```bash
node ./cosmwasm/deploy-contract.js instantiate -c XrplVotingVerifier --fetchCodeId --instantiate2 --admin $CONTRACT_ADMIN
```

2. Instantiate `XRPLGateway`.

```bash
node ./cosmwasm/deploy-contract.js instantiate -c XrplGateway --fetchCodeId --instantiate2 --admin $CONTRACT_ADMIN
```

3. Instantiate `XRPLMultisigProver`.

```bash
node ./cosmwasm/deploy-contract.js instantiate -c XrplMultisigProver --fetchCodeId --instantiate2 --admin $CONTRACT_ADMIN
```

4. Set environment variables.

- Network-specific environment variables: These variables need to be updated by the network.

```bash
XRPL_VOTING_VERIFIER=$(cat ./axelar-chains-config/info/$ENV.json | jq ".axelar.contracts.XrplVotingVerifier[\"$CHAIN\"].address" | tr -d '"')
XRPL_GATEWAY=$(cat ./axelar-chains-config/info/$ENV.json | jq ".axelar.contracts.XrplGateway[\"$CHAIN\"].address" | tr -d '"')
XRPPL_MULTISIG_PROVER=$(cat ./axelar-chains-config/info/$ENV.json | jq ".axelar.contracts.XrplMultisigProver[\"$CHAIN\"].address" | tr -d '"')
MULTISIG=$(cat ./axelar-chains-config/info/$ENV.json | jq .axelar.contracts.Multisig.address | tr -d '"')
REWARDS=$(cat ./axelar-chains-config/info/$ENV.json | jq .axelar.contracts.Rewards.address | tr -d '"')
```

- Gov proposal environment variables. Update these for each network

| Network              | `PROVER_ADMIN`                                  | `DEPOSIT_VALUE` | `REWARD_AMOUNT`     |
| -------------------- | ----------------------------------------------- | --------------- | ------------------- |
| **Devnet-amplifier** | `axelar1lsasewgqj7698e9a25v3c9kkzweee9cvejq5cs` | `100000000`     | `1000000uamplifier` |
| **Stagenet**         | `axelar1l7vz4m5g92kvga050vk9ycjynywdlk4zhs07dv` | `100000000`     | `1000000uaxl`       |
| **Testnet**          | `axelar17qafmnc4hrfa96cq37wg5l68sxh354pj6eky35` | `2000000000`    | `1000000uaxl`       |
| **Mainnet**          | `axelar1pczf792wf3p3xssk4dmwfxrh6hcqnrjp70danj` | `2000000000`    | `1000000uaxl`       |

```bash
PROVER_ADMIN=[prover admin who is responsible for the contract's operations]
DEPOSIT_VALUE=[deposit value]
REWARD_AMOUNT=[reward amount]
RUN_AS_ACCOUNT=[wasm deployer/governance address]
```

> **_NOTE:_** > `--runAs $RUN_AS_ACCOUNT` is only required for Devnet-amplifier. Do not use `--runAs` for Stagenet, Testnet, or Mainnet.

5. Register `XRPLGateway` on the Router.

> **_NOTE:_**
> Add a community post for the Mainnet Proposal. e.g., https://www.mintscan.io/axelar/proposals/274

```bash
node cosmwasm/submit-proposal.js execute \
  -c Router \
  -t "Register Gateway for XRPL" \
  -d "Register Gateway address for XRPL at Router contract" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"register_chain\": {
      \"chain\": \"$CHAIN\",
      \"gateway_address\": \"$GATEWAY\",
      \"msg_id_format\": \"hex_tx_hash\"
      }
    }"
```

```bash
axelard q wasm contract-state smart <router-address> '{"chain_info": "xrpl"}' --output json | jq .

# You should see something like this:
{
  "data": {
    "name": "xrpl",
    "gateway": {
      "address": "axelar1hzz0s0ucrhdp6tue2lxk3c03nj6f60qy463we7lgx0wudd72ctmsee8enx"
    },
    "frozen_status": 0,
    "msg_id_format": "hex_tx_hash"
  }
}
```

6. Update `ampd` with the XRPL chain configuration. Verifiers should use their own `rippled` RPC node for the `chain_rpc_url` in production.

| Network              | `http_url`                               |
| -------------------- | ---------------------------------------- |
| **Devnet-amplifier** | `https://s.devnet.rippletest.net:51234/` |
| **Stagenet**         | `https://s.altnet.rippletest.net:51234/` |
| **Testnet**          | `https://s.altnet.rippletest.net:51234/` |
| **Mainnet**          | `https://s1.ripple.com:51234/`           |

```bash
[[handlers]]
type="XRPLMsgVerifier"
chain_name="xrpl-dev"
chain_rpc_url=[http url]
cosmwasm_contract="$XRPL_VOTING_VERIFIER"

[[handlers]]
type="XRPLMultisigSigner"
multisig_contract="$MULTISIG"
multisig_prover_contract="$XRPL_MULTISIG_PROVER"
```

7. Verifiers should register their public key and register XRPL chain support.

```bash
ampd register-public-key ecdsa

ampd register-chain-support "[service name]" $CHAIN
```

8. Register `XRPLMultisigProver` contract on coordinator.

```bash
node cosmwasm/submit-proposal.js execute \
  -c Coordinator \
  -t "Register Multisig Prover for XRPL" \
  -d "Register Multisig Prover address for XRPL at Coordinator contract" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"register_prover_contract\": {
      \"chain_name\": \"$CHAIN\",
      \"new_prover_addr\": \"$MULTISIG_PROVER\"
    }
  }"
```

9. Authorize `XRPLMultisigProver` on Multisig.

```bash
node cosmwasm/submit-proposal.js execute \
  -c Multisig \
  -t "Authorize Multisig Prover for XRPL" \
  -d "Authorize Multisig Prover address for XRPL at Multisig contract" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"authorize_callers\": {
      \"contracts\": {
        \"$XRPL_MULTISIG_PROVER\": \"$CHAIN\"
      }
    }
  }"
```

```bash
axelard q wasm contract-state smart <multisig-addr> '{"is_caller_authorized": {"contract_address": "<xrpl-multisig-prover-addr>", "chain_name": "xrpl"}}' --output json | jq .

# Result should look like:
{
  "data": true
}
```

10. Create reward pool for `XRPLVotingVerifier`.

#### Rewards

| Network              | `epoch_duration` | `participation_threshold` | `rewards_per_epoch` |
| -------------------- | ---------------- | ------------------------- | ------------------- |
| **Devnet-amplifier** | `100`            | `["7", "10"]`             | `100`               |
| **Stagenet**         | `600`            | `["7", "10"]`             | `100`               |
| **Testnet**          | `14845`          | `["7", "10"]`             | `100`               |
| **Mainnet**          | `14845`          | `["8", "10"]`             | `TBD`               |

```bash
node cosmwasm/submit-proposal.js execute \
  -c Rewards \
  -t "Create pool for XRPLVotingVerifier" \
  -d "Create pool for XRPLVotingVerifier" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"create_pool\": {
      \"params\": {
        \"epoch_duration\": [epoch duration],
        \"participation_threshold\": [participation threshold],
        \"rewards_per_epoch\": [rewards per epoch]
      },
      \"pool_id\": {
        \"chain_name\": \"$CHAIN\",
        \"contract\": \"$XRPL_VOTING_VERIFIER\"
      }
    }
  }"
```

11. Create reward pool for Multisig.

```bash
node cosmwasm/submit-proposal.js execute \
  -c Rewards \
  -t "Create pool for XRPL in Axelar Multisig" \
  -d "Create pool for XRPL in Axelar Multisig" \
  --runAs $RUN_AS_ACCOUNT \
  --deposit $DEPOSIT_VALUE \
  --msg "{
    \"create_pool\": {
      \"params\": {
        \"epoch_duration\": [epoch duration],
        \"participation_threshold\": [participation threshold],
        \"rewards_per_epoch\": [rewards per epoch]
      },
      \"pool_id\": {
        \"chain_name\": \"$CHAIN\",
        \"contract\": \"$MULTISIG\"
      }
    }
  }"
```

12. Add funds to reward pools from a wallet with `$REWARD_AMOUNT`.

```bash
axelard tx wasm execute $REWARDS "{ \"add_rewards\": { \"pool_id\": { \"chain_name\": \"$CHAIN\", \"contract\": \"$MULTISIG\" } } }" --amount $REWARD_AMOUNT --from $WALLET

axelard tx wasm execute $REWARDS "{ \"add_rewards\": { \"pool_id\": { \"chain_name\": \"$CHAIN\", \"contract\": \"$XRPL_VOTING_VERIFIER\" } } }" --amount $REWARD_AMOUNT --from $WALLET
```

13. Create genesis verifier set.

Note that this step can only be run once a sufficient number of verifiers have registered.

```bash
axelard tx wasm execute $XRPL_MULTISIG_PROVER '"update_verifier_set"' --from $PROVER_ADMIN
```

## Checklist

The [XRPL checklist](../xrpl/2025-02-v1.0.0.md) will test GMP & ITS calls.
