# STELLAR GMP v1.0.0

|                | **Owner**                            |
| -------------- | ------------------------------------ |
| **Created By** | @ahramy <ahram@interoplabs.io>       |
| **Deployment** | @RiceAndMeet <steven@interoplabs.io> |

| **Network**          | **Deployment Status** | **Date** |
| -------------------- | --------------------- | -------- |
| **Devnet Amplifier** | -                     | TBD      |
| **Stagenet**         | -                     | TBD      |
| **Testnet**          | -                     | TBD      |
| **Mainnet**          | -                     | TBD      |

- [Crates](https://crates.io/users/interoplabs-ci)
- [Releases](https://github.com/axelarnetwork/axelar-cgp-stellar/releases)

## Background

Changes in the release:

1. This is the v1.0.0 initial GMP release.

## Deployment

Create an `.env` config.

```yaml
PRIVATE_KEY=xyz
ENV=xyz
CHAIN=stellar-2024-q4
```

```bash
# Deploy Gateway
node stellar/deploy-contract.js deploy axelar_gateway --version v1.0.0

# Instantiate stellar VotingVerifier
node ./cosmwasm/deploy-contract.js instantiate -c VotingVerifier -n stellar-2024-q4 --fetchCodeId --instantiate2

# Instantiate stellar gateway
node ./cosmwasm/deploy-contract.js instantiate -c Gateway -n stellar-2024-q4 --fetchCodeId --instantiate2

# Instantiate stellar MultisigProver
node ./cosmwasm/deploy-contract.js instantiate -c MultisigProver -n stellar-2024-q4 --fetchCodeId --instantiate2

# Register stellar gateway at the Router
node cosmwasm/submit-proposal.js execute \
  -c Router \
  -t "Register Gateway for stellar-2024-q4" \
  -d "Register Gateway address for stellar at Router contract" \
  --deposit 100000000 \
  --runAs axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9 \
  --msg '{"register_chain":{"chain":"stellar-2024-q4","gateway_address":"axelar1wr8kmmwc7v4v7kgpnyjggf3dacnvzmmsmxhw58tnflqf0wr93hyql4y6fn","msg_id_format":"hex_tx_hash_and_event_index"}}'

# Register chain on ampd
for i in $(seq 0 4); do kubectl exec -it ampd-set-2-axelar-amplifier-worker-"$i" -n devnet-amplifier -c ampd -- ampd register-chain-support validators stellar-2024-q4 ; done
for i in $(seq 0 4); do kubectl exec -it ampd-set-2-axelar-amplifier-worker-"$i" -n devnet-amplifier -c ampd -- ampd register-public-key ed25519 ; done

# Register_prover_contract on coordinator
node cosmwasm/submit-proposal.js execute \
  -c Coordinator \
  -t "Register Multisig Prover for stellar-2024-q4" \
  -d "Register Multisig Prover address for stellar-2024-q4 at Coordinator contract" \
  --deposit 100000000 \
  --runAs axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9 \
  --msg '{"register_prover_contract":{"chain_name":"stellar-2024-q4","new_prover_addr":"axelar1knpl88d730hdmlmxfpjl46jxlals0cxwzxp8c8tavrc8g2rduugqtvl6kg"}}'

# Authorize_callers on multisig prover
node cosmwasm/submit-proposal.js execute \
  -c Multisig \
  -t "Authorize Multisig Prover for stellar-2024-q4" \
  -d "Authorize Multisig Prover address for stellar-2024-q4 at Multisig contract" \
  --runAs axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9 \
  --deposit 100000000 \
  --msg '{"authorize_callers":{"contracts":{"axelar1knpl88d730hdmlmxfpjl46jxlals0cxwzxp8c8tavrc8g2rduugqtvl6kg":"stellar-2024-q4"}}}'

## verify
axelard q wasm contract-state smart axelar19jxy26z0qnnspa45y5nru0l5rmy9d637z5km2ndjxthfxf5qaswst9290r '{"is_caller_authorized": {"contract_address": "axelar1knpl88d730hdmlmxfpjl46jxlals0cxwzxp8c8tavrc8g2rduugqtvl6kg", "chain_name": "stellar-2024-q4"}}' --output json | jq .

# update_verifier_set
axelard tx wasm execute axelar1knpl88d730hdmlmxfpjl46jxlals0cxwzxp8c8tavrc8g2rduugqtvl6kg '"update_verifier_set"' --from amplifier --gas auto --gas-adjustment 1.2

# Create verify reward pool
node cosmwasm/submit-proposal.js execute \
  -c Rewards \
  -t "Create pool for stellar-2024-q4 in stellar voting verifier" \
  -d "Create pool for stellar-2024-q4 in stellar voting verifier" \
  --runAs axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9 \
  --deposit 100000000 \
  --msg '{
  "create_pool": {
    "params": {
      "epoch_duration": "100",
      "participation_threshold": [
        "8",
        "10"
      ],
      "rewards_per_epoch": "100"
    },
    "pool_id": {
      "chain_name": "stellar-2024-q4",
      "contract": "axelar1fclvpd3kx4udp3nxw88tk8279z36uvmkn6da0jh7fnz6eddh2n2s09n6tg"
    }
  }
}'

## verify
axelard q wasm contract-state smart axelar1vaj9sfzc3z0gpel90wu4ljutncutv0wuhvvwfsh30rqxq422z89qnd989l '{"rewards_pool":{"pool_id":{"chain_name":"stellar-2024-q4","contract":"axelar1fclvpd3kx4udp3nxw88tk8279z36uvmkn6da0jh7fnz6eddh2n2s09n6tg"}}}' --output json | jq .

# Create multisig reward pool
node cosmwasm/submit-proposal.js execute \
  -c Rewards \
  -t "Create pool for stellar-2024-q4 in axelar multisig" \
  -d "Create pool for stellar-2024-q4 in axelar multisig" \
  --runAs axelar1zlr7e5qf3sz7yf890rkh9tcnu87234k6k7ytd9 \
  --deposit 100000000 \
  --msg '{
  "create_pool": {
    "params": {
      "epoch_duration": "100",
      "participation_threshold": [
        "8",
        "10"
      ],
      "rewards_per_epoch": "100"
    },
    "pool_id": {
      "chain_name": "stellar-2024-q4",
      "contract": "axelar19jxy26z0qnnspa45y5nru0l5rmy9d637z5km2ndjxthfxf5qaswst9290r"
    }
  }
}'

## verify
axelard q wasm contract-state smart axelar1vaj9sfzc3z0gpel90wu4ljutncutv0wuhvvwfsh30rqxq422z89qnd989l '{"rewards_pool":{"pool_id":{"chain_name":"stellar-2024-q4","contract":"axelar19jxy26z0qnnspa45y5nru0l5rmy9d637z5km2ndjxthfxf5qaswst9290r"}}}' --output json | jq .

# Add funds to reward pools
echo $KEYRING_PASSWORD | axelard tx wasm execute axelar1vaj9sfzc3z0gpel90wu4ljutncutv0wuhvvwfsh30rqxq422z89qnd989l '{"add_rewards":{"pool_id":{"chain_name":"stellar-2024-q4","contract":"axelar19jxy26z0qnnspa45y5nru0l5rmy9d637z5km2ndjxthfxf5qaswst9290r"}}}' --amount 1000000uamplifier --from validator

echo $KEYRING_PASSWORD | axelard tx wasm execute axelar1vaj9sfzc3z0gpel90wu4ljutncutv0wuhvvwfsh30rqxq422z89qnd989l '{"add_rewards":{"pool_id":{"chain_name":"stellar-2024-q4","contract":"axelar1fclvpd3kx4udp3nxw88tk8279z36uvmkn6da0jh7fnz6eddh2n2s09n6tg"}}}' --amount 1000000uamplifier --from validator

# Update ampd with stellar chain config
kubectl edit configmaps ampd-set-2-axelar-amplifier-worker-config -n devnet-amplifier

# Rotate genesis verifier set on Stellar Gateway
node stellar/gateway.js rotate --chain-name stellar-2024-q4

# Deploy Operators
node stellar/deploy-contract.js deploy axelar_operators --version v1.0.0

# Deploy Gas Service
node stellar/deploy-contract.js deploy axelar_gas_service --version v1.0.0

# Deploy Example
node stellar/deploy-contract.js deploy example --version v1.0.0 --use-dummy-its-address

# Register refunder address as an operator
node stellar/operators.js --action add_operator --chain-name $CHAIN_NAME -e devnet-amplifier --args $REFUNDER_ADDRESS
```

## Checklist

The following checks should be performed after the rollout

- [ ] Stellar → EVM GMP call

```bash
node stellar/gmp.js send avalanche 0x0FCb262571be50815627C16Eca1f5F3D342FF5a5 0x1234 CDLZFC3SYJYDZT7K67VZ75HPJVIEUVNIXF47ZG2FB2RMQQVU2HHGCYSC 1

kubectl exec genesis-0 -n devnet-amplifier -c core -- bash -c 'echo $KEYRING_PASSWORD | axelard tx wasm execute $GATEWAY '{"verify_messages":
      [{"cc_id":{
        "source_chain":"stellar-2024-q4","message_id":"0x7b903beabbf200f7408c8c46cc4e5281396fff68f718515984ad6481f563be2b-0"},
        "destination_chain":"avalanche",
        "destination_address":"0xba76c6980428A0b10CFC5d8ccb61949677A61233","source_address":"GALITAYSFTLEVXIBTF5FVUIV7PFVF7VF5VSZVFYCXA7PXSZ2LZMY54VG","payload_hash":"56570de287d73cd1cb6092bb8fdee6173974955fdef345ae579ee9f475ea7432"}]
    }' $ARGS

kubectl exec genesis-0 -n devnet-amplifier -c core -- bash -c 'echo $KEYRING_PASSWORD | axelard tx wasm execute $GATEWAY '{"route_messages":
      [{"cc_id":{
        "source_chain":"stellar-2024-q4","message_id":"0x7b903beabbf200f7408c8c46cc4e5281396fff68f718515984ad6481f563be2b-0"},
        "destination_chain":"avalanche",
        "destination_address":"0xba76c6980428A0b10CFC5d8ccb61949677A61233","source_address":"GAIA45FE43FHCKPK5A2RYBDTYG3D3TT3F3KHFWGWX53TH7FIMBK6LRSJ","payload_hash":"56570de287d73cd1cb6092bb8fdee6173974955fdef345ae579ee9f475ea7432"}]
    }' $ARGS


kubectl exec genesis-0 -n devnet-amplifier -c core -- bash -c 'echo $KEYRING_PASSWORD | axelard tx wasm execute axelar1p22kz5jr7a9ruu8ypg40smual0uagl64dwvz5xt042vu8fa7l7dsl3wx8q '"'"'{"construct_proof":[{"source_chain":"stellar-2024-q4","message_id":"0xee9f59136fd961ff6494da0ae4fbb8a4fc973a55c4f11543ef430c6f177866ff-0"}]}'"'"' --gas auto --gas-adjustment 3 -b block --from validator

node evm/gateway.js -n avalanche --action submitProof --multisigSessionId 3

node ./evm/gateway.js -n avalanche --action execute --commandID 0x934F10D2DABE8AADB12EB4D0D10CBB3D3124DAB7B4165B65AF537EBF0197402E --sourceChain avalanche --sourceAddress 0x0FCb262571be50815627C16Eca1f5F3D342FF5a5 --destination 0x0FCb262571be50815627C16Eca1f5F3D342FF5a5 --payload 0x1234
```

- [ ] EVM → Stellar GMP call

```bash
node evm/gateway.js -n avalanche --action callContract --destinationChain stellar-2024-q4 --destination CCAZD6NDVKGZ5XE7UD3PZWJTJY45V7YY22XGPBUSUOEI7GQZLTPCXR7C --payload 0x1234 -y

axd tx wasm execute $GATEWAY '{"verify_messages":
      [{"cc_id":{
        "source_chain":"avalanche", "message_id":"0x4c332c321fb039d017249de35640fb9768380f9dbd741fbcf56ea7245144588f-0"},
        "destination_chain":"stellar-2024-q4",        "destination_address":"CCAZD6NDVKGZ5XE7UD3PZWJTJY45V7YY22XGPBUSUOEI7GQZLTPCXR7C",
        "source_address":"0xba76c6980428A0b10CFC5d8ccb61949677A61233",        "payload_hash":"56570de287d73cd1cb6092bb8fdee6173974955fdef345ae579ee9f475ea7432"}]
    }' $ARGS

axd tx wasm execute $GATEWAY '{"route_messages":
      [{"cc_id":{
        "source_chain":"avalanche",        "message_id":"0x4c332c321fb039d017249de35640fb9768380f9dbd741fbcf56ea7245144588f-0"},
        "destination_chain":"stellar-2024-q4",        "destination_address":"CCAZD6NDVKGZ5XE7UD3PZWJTJY45V7YY22XGPBUSUOEI7GQZLTPCXR7C",
        "source_address":"0xba76c6980428A0b10CFC5d8ccb61949677A61233",        "payload_hash":"56570de287d73cd1cb6092bb8fdee6173974955fdef345ae579ee9f475ea7432"}]
    }' $ARGS

axd tx wasm execute $PROVER '{"construct_proof":[{"source_chain":"avalanche","message_id":"0x4c332c321fb039d017249de35640fb9768380f9dbd741fbcf56ea7245144588f-0"}]}' $ARGS

node stellar/gateway.js submit-proof 1 --chain-name stellar-2024-q4

node stellar/gmp.js execute avalanche '0x0bcbbfc9b006db6958f3fce75f11fdc306b45e8e43396211f414f40d2d6db7c5-0' 0xba76c6980428A0b10CFC5d8ccb61949677A61233 0x1234
```
