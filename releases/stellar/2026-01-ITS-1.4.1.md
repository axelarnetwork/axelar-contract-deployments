# Stellar ITS v1.4.1

|                | **Owner**                        |
| -------------- | -------------------------------- |
| **Created By** | @ahramy (<ahram@interoplabs.io>) |
| **Deployment** | TBD                              |

| **Network**  | **Deployment Status** | **Date** |
| ------------ | --------------------- | -------- |
| **Stagenet** | TBD                   | TBD      |
| **Testnet**  | TBD                   | TBD      |

- [Crates](https://crates.io/crates/stellar-interchain-token-service/1.4.1)
- [Releases](https://github.com/axelarnetwork/axelar-amplifier-stellar/releases/tag/stellar-interchain-token-service-v1.4.1)

## Background & Deployment

This deployment is being performed due to the Stellar testnet reset on December 17 at 17:00 UTC,
Only for stagenet and testnet environments - not devnet-amplifier and mainnet.

Create an `.env` config. `CHAIN` should be set to `stellar-2025-q4` for stagenet and testnet.

```yaml
# Change `PRIVATE_KEY in `.env` to Stellar
PRIVATE_KEY=<stellar_deployer_key>
ENV=<stagenet|testnet>
CHAIN=<stellar-2025-q4>
```

#### Contract Version Info

| Contract                 | **Stagenet** | **Testnet** |
| ------------------------ | ------------ | ----------- |
| `InterchainTokenService` | `1.4.1`      | `1.4.1`     |
| `AxelarExample`          | `1.0.3`      | `1.0.3`     |
| `Multicall`              | `1.0.1`      | `1.0.1`     |
| `TokenUtils`             | `1.0.0`      | `1.0.0`     |

Set `$VERSION` to the appropriate version from the table above for your target environment.

1. Deploy Interchain Token Service

Ensure that `initializeArgs` are correct in `$ENV.json` after deployment.

```bash
# Please note: Deploy InterchainTokenService v1.1.2 first, then upgrade to v1.4.1.
ts-node stellar/deploy-contract deploy InterchainTokenService --version 1.1.2
ts-node stellar/deploy-contract upgrade InterchainTokenService --version 1.4.1
```

2. Re-deploy Axelar Example with ITS support

```bash
ts-node stellar/deploy-contract deploy AxelarExample --version $VERSION
```

3. Register Stellar ITS on ITS Hub

ITS hub contract configuration in `$ENV.json` must include the following attributes per chain:

```bash
"axelar": {
  "contracts": {
    ...
    "InterchainTokenService": {
      ...
      "$CHAIN": {
        "maxUintBits": 127,
        "maxDecimalsWhenTruncating": 255
      }
    }
    ...
  }
}
```

- Add a community post for the mainnet proposal (i.e: <https://community.axelar.network/t/proposal-add-its-hub-to-mainnet/3227>) and share on `mainnet-announcements` channel on Discord.

```bash
ts-node cosmwasm/contract.ts its-hub-register-chains $CHAIN \
    --governance # omit on devnet-amplifier
```

4. Setting up trusted chains on Stellar

```bash
# Add all trusted chains to Stellar ITS
ts-node stellar/its add-trusted-chains all
```

5. Set Stellar as trusted chain on EVM ITS. Similarly, set Stellar as a trusted chain for every other non EVM ITS contract

```bash
# Change `PRIVATE_KEY in `.env` to EVM
PRIVATE_KEY=<evm_deployer_key>

ts-node evm/its set-trusted-chains $CHAIN -n all
```

6. Deploy Multicall

```bash
ts-node stellar/deploy-contract deploy Multicall --version $VERSION
```

7. Deploy Stellar Token Utils

```bash
ts-node stellar/deploy-contract deploy TokenUtils --version $VERSION
```

## Checklist

The following checks should be performed after the rollout

```bash
ITS_HUB_ADDRESS=<its_hub_address>
```

### Execute Command

The GMP call needs to be routed via Amplifier before the `execute` call.

- <https://docs.axelar.dev/dev/amplifier/chain-integration/relay-messages>

### Stellar to EVM

- Note: The final execute step of the GMP call on EVM can be performed via:

```bash
# Change `PRIVATE_KEY in `.env` to EVM
PRIVATE_KEY=<evm_deployer_key>

ts-node evm/gateway -n [destination-chain] --action execute --payload $PAYLOAD --sourceChain axelar --sourceAddress $ITS_HUB_ADDRESS --messageId [message-id] --destination [destination-address]
```

1. Deploy Native Interchain Token

```bash
ts-node stellar/its deploy-interchain-token TEST test 18 0x1234 100

ts-node stellar/its deploy-remote-interchain-token 0x1234 [destination-chain] --gas-amount 10000000
```

2. Interchain Token Transfer for Native Interchain Token

```bash
ts-node stellar/its interchain-transfer [token-id] [destination-chain] [destination-address] [amount] --gas-amount 10000000
```

3. Deploy Remote Canonical Token

```bash
# Use XLM based on network:
# Devnet-Amplifier / Stagenet / Testnet: CDLZFC3SYJYDZT7K67VZ75HPJVIEUVNIXF47ZG2FB2RMQQVU2HHGCYSC
# Mainnet: CAS3J7GYLGXMF6TDJBBYYSE3HQ6BBSMLNUQ34T6TZMYMW2EVH34XOWMA

ts-node stellar/its register-canonical-token [token-address]

ts-node stellar/its deploy-remote-canonical-token [token-address] [destination-chain] --gas-amount 10000000
```

4. Interchain Token Transfer for Canonical Token

```bash
ts-node stellar/its interchain-transfer [token-id] [destination-chain] [destination-address] [amount] --gas-amount 10000000
```

### EVM to Stellar

- Note: The final execute step of the GMP call on Stellar can be performed via:

```bash
# Change `PRIVATE_KEY in `.env` to Stellar
PRIVATE_KEY=<stellar_deployer_key>

ts-node stellar/its execute [source-chain] [message-id] [source-address] [payload]
```

1. Deploy Native Interchain Token

```bash
ts-node evm/interchainTokenFactory --action deployInterchainToken -n [source-chain] --destinationChain $CHAIN --salt "salt" --name "test" --symbol "TEST" --decimals 18

# Adjust `--gasValue` or add gas directly from axelarscan for mainnet
ts-node evm/interchainTokenFactory --action deployRemoteInterchainToken -n [source-chain] --destinationChain $CHAIN --salt "salt" --gasValue 1000000000000000000
```

2. Interchain Token Transfer for Native Interchain Token

```bash
ts-node evm/its --action interchainTransfer -n [source-chain] --destinationChain $CHAIN --destinationAddress [encoded-recipient] --tokenId [token-id] --amount [amount]
```

3. Deploy Remote Canonical Token

```bash
ts-node evm/interchainTokenFactory --action registerCanonicalInterchainToken -n [source-chain] --destinationChain $CHAIN --tokenAddress [token-address]

ts-node evm/interchainTokenFactory --action deployRemoteCanonicalInterchainToken -n [source-chain] --destinationChain $CHAIN --tokenAddress [token-address] --gasValue 1000000000000000000
```

4. Interchain Token Transfer for Canonical Token

```bash
ts-node evm/its --action interchainTransfer -n [source-chain] --destinationChain $CHAIN --destinationAddress [encoded-recipient] --tokenId [token-id] --amount [amount] --gasValue 1000000000000000000
```

### Link Token

- Please reference [stellar/docs/link-token.md](../stellar/docs/link-token.md) for more details.

Link a token on EVM as source chain (MINT_BURN) with a stellar custom token on Stellar as dest chain (MINT_BURN_FROM)

```bash
NAME="TEST"
SYMBOL="TEST"
SALT=0x1234
EVM_CHAIN=flow
STELLAR_CHAIN="stellar-2025-q4"  # Use "stellar-2025-q4" for stagenet/testnet or "stellar" for mainnet
STELLAR_TOKEN_ADMIN="STELLAR_TOKEN_ADMIN_ADDRESS"

# Deploy a custom token with 7 decimals on Stellar
stellar contract deploy --wasm target/wasm32-unknown-unknown/release/stellar_custom_token_example.wasm --source wallet --network testnet -- --admin $STELLAR_TOKEN_ADMIN --decimal 7 --name $NAME --symbol $SYMBOL

# Set STELLAR_TOKEN_ADDRESS from the result
STELLAR_TOKEN_ADDRESS=

# Register the token metadata on Stellar
ts-node stellar/its register-token-metadata $STELLAR_TOKEN_ADDRESS --gas-amount 10000000

# Deploy a token with 18 decimals on EVM
ts-node evm/interchainTokenFactory --action deployInterchainToken --minter 0xba76c6980428A0b10CFC5d8ccb61949677A61233 --name $NAME --symbol $SYMBOL --decimals 18 --initialSupply 10000000 --salt $SALT -n $EVM_CHAIN

# Set EVM_TOKEN_ADDRESS and EVM_TOKEN_ID from the result
EVM_TOKEN_ADDRESS=
EVM_TOKEN_ID=

# Register the token metadata on EVM
ts-node evm/its register-token-metadata $EVM_TOKEN_ADDRESS -n $EVM_CHAIN --gasValue 1000000000000000000

# Register Custom Token on EVM
MINT_BURN_TYPE=4
ts-node evm/interchainTokenFactory --action registerCustomToken --tokenAddress $EVM_TOKEN_ADDRESS --tokenManagerType $MINT_BURN_TYPE --operator 0xba76c6980428A0b10CFC5d8ccb61949677A61233 --salt $SALT -n $EVM_CHAIN -y

# Link Token
MINT_BURN_FROM_TYPE=1
ts-node evm/interchainTokenFactory --action linkToken --destinationChain $STELLAR_CHAIN --destinationTokenAddress $STELLAR_TOKEN_ADDRESS --tokenManagerType $MINT_BURN_FROM_TYPE --linkParams "0x" --salt $SALT -n $EVM_CHAIN --gasValue 10000000000000000000 -y

# Set TOKEN_ID from the result
TOKEN_ID=

# Get token manager address on EVM
ts-node evm/its token-manager-address $TOKEN_ID -n $EVM_CHAIN -y

# Set EVM_TOKEN_MANAGER from the result
EVM_TOKEN_MANAGER=

# Transfer mintership to the token manager
ts-node evm/its transfer-mintership $EVM_TOKEN_ADDRESS $EVM_TOKEN_MANAGER -n $EVM_CHAIN -y

# Get token manager address on Stellar
ts-node stellar/its deployed-token-manager $TOKEN_ID -y

# Set STELLAR_TOKEN_MANAGER from the result
STELLAR_TOKEN_MANAGER=

# Add the token manager as a minter
ts-node stellar/token-utils add-minter $STELLAR_TOKEN_ADDRESS $STELLAR_TOKEN_MANAGER

# Set User address
USER=  # Replace with your user address

# Mint token to the user
ts-node stellar/token-utils mint $STELLAR_TOKEN_ADDRESS $USER 10000000000

# Check balance of the token for the user
ts-node stellar/token-utils balance $STELLAR_TOKEN_ADDRESS $USER

# Interchain Transfer from Stellar to EVM
ts-node stellar/its interchain-transfer $TOKEN_ID $EVM_CHAIN <destinationAddress> 1 --gas-amount 10000000

# Interchain Transfer from EVM to Stellar
ts-node evm/its interchain-transfer $STELLAR_CHAIN $TOKEN_ID $USER 1 -n $EVM_CHAIN

# Check balance of the token for the user
ts-node stellar/token-utils balance $STELLAR_TOKEN_ADDRESS $USER
```
