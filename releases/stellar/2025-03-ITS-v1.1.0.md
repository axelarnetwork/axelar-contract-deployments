# Stellar ITS v1.1.0

|                | **Owner**                            |
| -------------- | ------------------------------------ |
| **Created By** | @nbayindirli (noah@interoplabs.io)   |
| **Deployment** | @nbayindirli (noah@interoplabs.io)   |

| **Network**          | **Deployment Status** | **Date** |
| -------------------- | --------------------- | -------- |
| **Devnet Amplifier** | Upgrade WIP           | 4/7/2025 |
| **Stagenet**         | Upgrade WIP           | 4/7/2025 |
| **Testnet**          | Upgrade WIP           | 4/7/2025 |
| **Mainnet**          | Upgrade WIP           | 4/7/2025 |

- [Crates](https://crates.io/crates/stellar-interchain-token-service/1.1.0)
- [Releases](https://github.com/axelarnetwork/axelar-amplifier-stellar/releases/tag/stellar-interchain-token-service-v1.1.0)

## Background

- This is the v1.1.0 Stellar ITS release.

Contract changes in the release:

- See changes in [GMP v1.1.0](./2025-02-GMP-v1.1.0.md)

## Deployment

Ensure that [Stellar GMP](./2025-02-GMP-v1.1.0.md) is upgraded first.

Create an `.env` config. `CHAIN` should be set to `stellar` for mainnet, and `stellar-2025-q1` for all other networks.

```yaml
# Change `PRIVATE_KEY in `.env` to Stellar
PRIVATE_KEY=<stellar_deployer_key>
ENV=<devnet-amplifier|stagenet|testnet|mainnet>
CHAIN=<stellar-2025-q1|stellar>
```

1. Verify deployer address

| Network              | `deployer address`                                         |
| -------------------- | ---------------------------------------------------------- |
| **Devnet-amplifier** | `GCRN3JXRVXHQTFQFM7NR4TTTORGZDCJWPIOLPQQHL6WMAQGVMWSXJL3Q` |
| **Stagenet**         | `GBP4FSAOFV5O72AB3YQRDCYVD47W4N7KQK3OJODXSU3OBPNGKX4SQTJ3` |
| **Testnet**          | `GBP4FSAOFV5O72AB3YQRDCYVD47W4N7KQK3OJODXSU3OBPNGKX4SQTJ3` |
| **Mainnet**          | `GCUIBOS2JPTJSJ3PFMXU4RD67PS5QT7FG3HSXHFZQGVNIYXPYODKRJ7S` |

2. Retrieve full list of tokenIds supported by Stellar ITS

| Network              | `InterchainTokenService storage`                           |
| -------------------- | ---------------------------------------------------------- |
| **Devnet-amplifier** | [source](https://stellar.expert/explorer/testnet/contract/CATNQHWMG4VOWPSWF4HXVW7ASDJNX7M7F6JLFC544T7ZMMXXAE2HUDTY/storage) |
| **Stagenet**         | [source](https://stellar.expert/explorer/testnet/contract/CBD5WIIZ3BR62DQWUON2SV556UYSHL3KLBTPRX54TWDYJGPMVLZUBXXP/storage) |
| **Testnet**          | [source](https://stellar.expert/explorer/testnet/contract/CCXT3EAQ7GPQTJWENU62SIFBQ3D4JMNQSB77KRPTGBJ7ZWBYESZQBZRK/storage) |
| **Mainnet**          | [source](https://stellar.expert/explorer/public/contract/CBDBMIOFHGWUFRYH3D3STI2DHBOWGDDBCRKQEUB4RGQEBVG74SEED6C6/storage) |

Note: You may convert using a [base64 to hex converter](https://cryptii.com/pipes/base64-to-hex).

| Network              | `InterchainTokenService tokenIds (base64)`                 |
| -------------------- | ---------------------------------------------------------- |
| **Devnet-amplifier** | `["Ti+Y+1SPlMl6ZvSfJSq1lTJna8pWcboxzVkujlT0/F0=","J535ZSKoVNJdPK0QfK4QNZtrlGDrRoDaTmXV59EqXq0=","bFaSJThTT7kJQzooI+f4g992m1LpEacDWN20EBHQ3ro=","jC5tzI2Z+ljSXkwbNbkKMnWlWo59Pk+E2K5gdYOfna4=","25L0WIB2ChfMc3cFtRM+oOzIJaEQfs+61S9DqJ+WqAw=","sy1A5j5i5v43b84Zvz6ed57K3Dyb5pI+T+4oKVXbl2Q=","DLFdu9+hYIW0XgkQTMSF5lSaI/cKdmSnoTn75jZbv8A=","caBrwGL0ROiIbKS5sn7rSVTC6idQmOvsfx7E+cUpI10=","MJlVSFxI9myqmYe0kPZAM0DZ82x+7qMHKqijO9Lq89o=","w3yhg24JHcNlkpZ585AEdw7pc1s3BuDlcFXtQBCoibE=","wTusnWDmOBMA0jtpoUzBTeSCOA6CDH4yzWZVakASQtk="]` |
| **Stagenet**         | `["",""]`                                                  |
| **Testnet**          | `["",""]`                                                  |
| **Mainnet**          | `["",""]`                                                  |

| Network              | `InterchainTokenService tokenIds (hex w/ 0x prefix)`       |
| -------------------- | ---------------------------------------------------------- |
| **Devnet-amplifier** | `["4e2f98fb548f94c97a66f49f252ab59532676bca5671ba31cd592e8e54f4fc5d","279df96522a854d25d3cad107cae10359b6b9460eb4680da4e65d5e7d12a5ead","6c56922538534fb909433a2823e7f883df769b52e911a70358ddb41011d0deba","8c2e6dcc8d99fa58d25e4c1b35b90a3275a55a8e7d3e4f84d8ae6075839f9dae","db92f45880760a17cc737705b5133ea0ecc825a1107ecfbad52f43a89f96a80c","b32d40e63e62e6fe376fce19bf3e9e779ecadc3c9be6923e4fee282955db9764","0cb15dbbdfa16085b45e09104cc485e6549a23f70a7664a7a139fbe6365bbfc0","71a06bc062f444e8886ca4b9b27eeb4954c2ea275098ebec7f1ec4f9c529235d","309955485c48f66caa9987b490f6403340d9f36c7eeea3072aa8a33bd2eaf3da","c37ca1836e091dc365929679f39004770ee9735b3706e0e57055ed4010a889b1","c13bac9d60e6381300d23b69a14cc14de482380e820c7e32cd66556a401242d9"]` |
| **Stagenet**         | `["",""]`                                                  |
| **Testnet**          | `["",""]`                                                  |
| **Mainnet**          | `["",""]`                                                  |

3. Take note of the current bytes value for `InterchainTokenWasmHash` via the explorer link above.

4. Take note of the current bytes value for `TokenManagerWasmHash` via the explorer link above.

5. Upload `TokenManager` & retrieve WASM hash

```bash
node stellar/deploy-contract.js upload TokenManager --version 1.1.0
```

Save the returned `TokenManager` WASM hash for use in the next step.

6. Upload `InterchainToken` & retrieve WASM hash

```bash
node stellar/deploy-contract.js upload InterchainToken --version 1.1.0
```

Save the returned `InterchainToken` WASM hash for use in the next step.

7. Upgrade `InterchainTokenService` & migrate storage schema

```bash
node stellar/deploy-contract.js upgrade InterchainTokenService --version 1.1.0 --migration-data '{"newTokenManagerWasmHash":"<newTokenManagerWasmHash-bytes-from-above>","newInterchainTokenWasmHash":"<newInterchainTokenWasmHash-bytes-from-above>"}'
```

8. Pause the `InterchainTokenService` contract

```bash
node stellar/contract.js pause InterchainTokenService
```

9. Verify `InterchainTokenService` is paused

```bash
node stellar/contract.js paused InterchainTokenService
```

10. Run `ITS::migrate_token` for ALL deployed tokenIds (hex)

```bash
node stellar/its.js migrate-tokens -- --tokenIds ["<tokenIdN>"] --version 1.1.0
```

NOTE: `InterchainToken` + `TokenManager` contracts will be migrated automatically.

11. Unpause the 'InterchainTokenService' contract

```bash
node stellar/contract.js unpause InterchainTokenService
```

12. Revisit the `InterchainTokenService` storage via the explorer link above.

- The bytes value for `InterchainTokenWasmHash` should be replaced with a new WASM hash.
- The bytes value for `TokenManagerWasmHash` should be replaced with a new WASM hash.

13. Upgrade the `Upgrader` contract

```bash
node stellar/deploy-contract.js upgrade Upgrader --version 1.1.0
```

14. Remove the `createUpgradeAuths()` code added in the first step.

## Checklist

The following checks should be performed after the rollout

```bash
ITS_HUB_ADDRESS=<its_hub_address>
```

### Execute Command

The GMP call needs to be routed via Amplifier before the `execute` call.

- https://docs.axelar.dev/dev/amplifier/chain-integration/relay-messages

### Stellar to EVM

- Note: The final execute step of the GMP call on EVM can be performed via:

```bash
# Change `PRIVATE_KEY `.env` to EVM
PRIVATE_KEY=<evm_deployer_key>

node evm/gateway.js -n [destination-chain] --action execute --payload $PAYLOAD --sourceChain axelar --sourceAddress $ITS_HUB_ADDRESS --messageId [message-id] --destination [destination-address]
```

1. Deploy Native Interchain Token

```bash
node stellar/its.js deploy-interchain-token TEST test 18 0x1234 100

node stellar/its.js deploy-remote-interchain-token 0x1234 [destination-chain] --gas-amount 10000000
```

2. Interchain Token Transfer for Native Interchain Token

```bash
node stellar/its.js interchain-transfer [token-id] [destination-chain] [destination-address] [amount] --gas-amount 10000000
```

3. Deploy Remote Canonical Token

```bash
# Use XLM based on network:
# Devnet-Amplifier / Stagenet / Testnet: CDLZFC3SYJYDZT7K67VZ75HPJVIEUVNIXF47ZG2FB2RMQQVU2HHGCYSC
# Mainnet: CAS3J7GYLGXMF6TDJBBYYSE3HQ6BBSMLNUQ34T6TZMYMW2EVH34XOWMA

node stellar/its.js register-canonical-token [token-address]

node stellar/its.js deploy-remote-canonical-token [token-address] [destination-chain] --gas-amount 10000000
```

4. Interchain Token Transfer for Canonical Token

```bash
node stellar/its.js interchain-transfer [token-id] [destination-chain] [destination-address] [amount] --gas-amount 10000000
```

### EVM to Stellar

- Note: The final execute step of the GMP call on Stellar can be performed via:

```bash
# Change `PRIVATE_KEY in `.env` to Stellar
PRIVATE_KEY=<stellar_deployer_key>

node stellar/its.js execute [destination-chain] [message-id] [source-address] [payload]
```

1. Deploy Native Interchain Token

```bash
node evm/interchainTokenFactory.js --action deployInterchainToken -n [source-chain] --destinationChain $CHAIN --salt "salt" --name "test" --symbol "TEST" --decimals 18

# Adjust `--gasValue` or add gas directly from axelarscan for mainnet
node evm/interchainTokenFactory.js --action deployRemoteInterchainToken -n [source-chain] --destinationChain $CHAIN --salt "salt" --gasValue 1000000000000000000
```

2. Interchain Token Transfer for Native Interchain Token

```bash
node evm/its.js --action interchainTransfer -n [source-chain] --destinationChain $CHAIN --destinationAddress [encoded-recipient] --tokenId [token-id] --amount [amount]
```

3. Deploy Remote Canonical Token

```bash
node evm/interchainTokenFactory.js --action registerCanonicalInterchainToken -n [source-chain] --destinationChain $CHAIN --tokenAddress [token-address]

node evm/interchainTokenFactory.js --action deployRemoteCanonicalInterchainToken -n [source-chain] --destinationChain $CHAIN --tokenAddress [token-address] --gasValue 1000000000000000000
```

4. Interchain Token Transfer for Canonical Token

```bash
node evm/its.js --action interchainTransfer -n [source-chain] --destinationChain $CHAIN --destinationAddress [encoded-recipient] --tokenId [token-id] --amount [amount] --gasValue 1000000000000000000
```
