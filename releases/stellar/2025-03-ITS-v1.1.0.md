# Stellar ITS v1.1.0

|                | **Owner**                            |
| -------------- | ------------------------------------ |
| **Created By** | @nbayindirli (<noah@interoplabs.io>)   |
| **Deployment** | @nbayindirli (<noah@interoplabs.io>)   |

| **Network**          | **Deployment Status** | **Date**   |
| -------------------- | --------------------- | ---------- |
| **Devnet Amplifier** | WIP                   | 2025-04-07 |
| **Stagenet**         | WIP                   | 2025-04-07 |
| **Testnet**          | WIP                   | 2025-04-07 |
| **Mainnet**          | WIP                   | 2025-04-07 |

- [Crates](https://crates.io/crates/stellar-interchain-token-service/1.1.0)
- [Releases](https://github.com/axelarnetwork/axelar-amplifier-stellar/releases/tag/stellar-interchain-token-service-v1.1.0)

## Background

- This is the v1.1.0 Stellar ITS release.

Contract changes in the release:

- See changes in [GMP v1.1.0](./2025-02-GMP-v1.1.0.md)

## Deployment

Ensure that [Stellar GMP](./2025-02-GMP-v1.1.0.md) is upgraded first.

Create an `.env` config. `CHAIN` should be set to `stellar` for mainnet, and `stellar-2025-q1` for all other networks.

```yaml
# Change `PRIVATE_KEY in `.env` to Stellar
PRIVATE_KEY=<stellar_deployer_key>
ENV=<devnet-amplifier|stagenet|testnet|mainnet>
CHAIN=<stellar-2025-q1|stellar>
```

1. Verify deployer address

| Network              | `deployer address`                                         |
| -------------------- | ---------------------------------------------------------- |
| **Devnet-amplifier** | `GCRN3JXRVXHQTFQFM7NR4TTTORGZDCJWPIOLPQQHL6WMAQGVMWSXJL3Q` |
| **Stagenet**         | `GBP4FSAOFV5O72AB3YQRDCYVD47W4N7KQK3OJODXSU3OBPNGKX4SQTJ3` |
| **Testnet**          | `GBP4FSAOFV5O72AB3YQRDCYVD47W4N7KQK3OJODXSU3OBPNGKX4SQTJ3` |
| **Mainnet**          | `GCUIBOS2JPTJSJ3PFMXU4RD67PS5QT7FG3HSXHFZQGVNIYXPYODKRJ7S` |

2. Take note of the current bytes value for `InterchainTokenWasmHash` via the explorer link above.

3. Take note of the current bytes value for `TokenManagerWasmHash` via the explorer link above.

4. Upload `TokenManager` & retrieve WASM hash

```bash
node stellar/deploy-contract.js upload TokenManager --version 1.1.0
```

Save the returned `TokenManager` WASM hash for use in the next step.

5. Upload `InterchainToken` & retrieve WASM hash

```bash
node stellar/deploy-contract.js upload InterchainToken --version 1.1.0
```

Save the returned `InterchainToken` WASM hash for use in the next step.

6. Upgrade `InterchainTokenService` & migrate storage schema

```bash
node stellar/deploy-contract.js upgrade InterchainTokenService --version 1.1.0 --migration-data '{"newTokenManagerWasmHash":"<new-token-manager-wasm-hash-bytes-from-above>","newInterchainTokenWasmHash":"<new-interchain-token-wasm-hash-bytes-from-above>"}'
```

7. Retrieve full list of tokenIds supported by Stellar ITS

| Network              | `InterchainTokenService storage`                           |
| -------------------- | ---------------------------------------------------------- |
| **Devnet-amplifier** | [source](https://stellar.expert/explorer/testnet/contract/CATNQHWMG4VOWPSWF4HXVW7ASDJNX7M7F6JLFC544T7ZMMXXAE2HUDTY/storage) |
| **Stagenet**         | [source](https://stellar.expert/explorer/testnet/contract/CBD5WIIZ3BR62DQWUON2SV556UYSHL3KLBTPRX54TWDYJGPMVLZUBXXP/storage) |
| **Testnet**          | [source](https://stellar.expert/explorer/testnet/contract/CCXT3EAQ7GPQTJWENU62SIFBQ3D4JMNQSB77KRPTGBJ7ZWBYESZQBZRK/storage) |
| **Mainnet**          | [source](https://stellar.expert/explorer/public/contract/CBDBMIOFHGWUFRYH3D3STI2DHBOWGDDBCRKQEUB4RGQEBVG74SEED6C6/storage) |

Note: You may convert using a [base64 to hex converter](https://cryptii.com/pipes/base64-to-hex).

| Network              | `InterchainTokenService tokenIds (base64)`                 |
| -------------------- | ---------------------------------------------------------- |
| **Devnet-amplifier** | `"Ti+Y+1SPlMl6ZvSfJSq1lTJna8pWcboxzVkujlT0/F0=" "J535ZSKoVNJdPK0QfK4QNZtrlGDrRoDaTmXV59EqXq0=" "bFaSJThTT7kJQzooI+f4g992m1LpEacDWN20EBHQ3ro=" "jC5tzI2Z+ljSXkwbNbkKMnWlWo59Pk+E2K5gdYOfna4=" "25L0WIB2ChfMc3cFtRM+oOzIJaEQfs+61S9DqJ+WqAw=" "sy1A5j5i5v43b84Zvz6ed57K3Dyb5pI+T+4oKVXbl2Q=" "DLFdu9+hYIW0XgkQTMSF5lSaI/cKdmSnoTn75jZbv8A=" "caBrwGL0ROiIbKS5sn7rSVTC6idQmOvsfx7E+cUpI10=" "MJlVSFxI9myqmYe0kPZAM0DZ82x+7qMHKqijO9Lq89o=" "w3yhg24JHcNlkpZ585AEdw7pc1s3BuDlcFXtQBCoibE=" "wTusnWDmOBMA0jtpoUzBTeSCOA6CDH4yzWZVakASQtk="` |
| **Stagenet**         | `"bk5TOcAqehReN14EFgsCy2nm+cXT4e+zjs+IsJ5zq6g="` |
| **Testnet**          | `"hgCk3PiKUb4rIPgeg9BHL3Vkwrs20mpJErDxJEeG2EI=" "aL82NlxN1WLwsn27SRgZ5oKPZmI+l2GQDWMplCX22hQ=" "JPX22guaGus0Idr+O6//yXuWvZZmhWRCuiZ7VwjImD0=" "duMC51dDoYm5CMaR5IHLyG92Na59VmZ+uvRFVdiAPgs=" "20v3Yhagupg08MkM9XWucRVK2yU8WgKnpL4iYWOJyEA=" "xZnM6srsSlfMzSFh6xYqblDADTKRMKH8i5YJSj9lu+c=" "gZJCYZxzvwvSswXTbba617qr35yCR6lnBaraHAM12ck=" "cc6njm/zY85UuBcwV5DfnZHWQwU1ZGLAfTFu+H5JqXE=" "nh2GXgc053GnIIWlXezhFztcRVxDPiMoisr/Ebvy/JY=" "hp16iVNpHmS4VOHwxRptA5aXdLzR/kroSeqQ/qGHLsk=" "oocckvNmRBhA1IHxcP4IqnFTtd5VQLwtqfmovl0C9kU=" "u0ljfh0l1AYB0ij8l5W2Dq8fDg0ZZWjFRNKNsJG/kek=" "IIZ3ovlibC9CIOAiHQGuD7gH/hVKAcbL3bQNIuF6vWY=" "w1Bsp4qdLqIMlMVXwpcxO+XRNYIrpKz2HphQUOemJ+Q="` |
| **Mainnet**          | `"A/cM/Lqj2/Fx22VBAjjgW1jDrnywIZy3Bo1Z1Wr5b7Q=" "dGQ0vIU2L8yyO8EEthUPrvCy0v+WpQ8tElUwREprmQ8=" "XqRV/aAChDa0fS7nCVsHUDo9emkk9vDjOrzuIaPtKv0=" "zlmGy2Rk0M/FhXFVKbDXxzQxjq33qxrvWtExvamdenI=" "pGiAIMevFALTHyQpjk+P1+e9nlgSqIEjHi9nOq0UxcE=" "+qa+qidI5P8g0RG6rRHsU27kxgjD5Lc+bD/XkGWShKo=" "xHlsRTIOfLZxlLAiX4ruZM+diCMXxWEGmNfBfespLw0=" "0ZLTZvcC/ljjXUjx2SZHEchrQYgiApj2qZ/XfNnACXM=" "JuOWPNpbr6ugOgKTMnzWAl+tyBbSth9pzsPD43NT0j4="` |

| Network              | `InterchainTokenService tokenIds (hex w/ 0x prefix)`       |
| -------------------- | ---------------------------------------------------------- |
| **Devnet-amplifier** | `"0x4e2f98fb548f94c97a66f49f252ab59532676bca5671ba31cd592e8e54f4fc5d" "0x279df96522a854d25d3cad107cae10359b6b9460eb4680da4e65d5e7d12a5ead" 0x6c56922538534fb909433a2823e7f883df769b52e911a70358ddb41011d0deba" "0x8c2e6dcc8d99fa58d25e4c1b35b90a3275a55a8e7d3e4f84d8ae6075839f9dae" "0xdb92f45880760a17cc737705b5133ea0ecc825a1107ecfbad52f43a89f96a80c" "0xb32d40e63e62e6fe376fce19bf3e9e779ecadc3c9be6923e4fee282955db9764" "0x0cb15dbbdfa16085b45e09104cc485e6549a23f70a7664a7a139fbe6365bbfc0" "0x71a06bc062f444e8886ca4b9b27eeb4954c2ea275098ebec7f1ec4f9c529235d" "0x309955485c48f66caa9987b490f6403340d9f36c7eeea3072aa8a33bd2eaf3da" "0xc37ca1836e091dc365929679f39004770ee9735b3706e0e57055ed4010a889b1" "0xc13bac9d60e6381300d23b69a14cc14de482380e820c7e32cd66556a401242d9"` |
| **Stagenet**         | `"0x6e4e5339c02a7a145e375e04160b02cb69e6f9c5d3e1efb38ecf88b09e73aba8"` |
| **Testnet**          | `"0x8600a4dcf88a51be2b20f81e83d0472f7564c2bb36d26a4912b0f1244786d842" "0x68bf36365c4dd562f0b27dbb491819e6828f66623e9761900d63299425f6da14" "0x24f5f6da0b9a1aeb3421dafe3bafffc97b96bd9666856442ba267b5708c8983d" "0x76e302e75743a189b908c691e481cbc86f7635ae7d56667ebaf44555d8803e0b" "0xdb4bf76216a0ba9834f0c90cf575ae71154adb253c5a02a7a4be22616389c840" "0xc599cceacaec4a57cccd2161eb162a6e50c00d329130a1fc8b96094a3f65bbe7" "0x819242619c73bf0bd2b305d36db6bad7baabdf9c8247a96705aada1c0335d9c9" "0x71cea78e6ff363ce54b817305790df9d91d64305356462c07d316ef87e49a971" "0x9e1d865e0734e771a72085a55dece1173b5c455c433e23288acaff11bbf2fc96" "0x869d7a8953691e64b854e1f0c51a6d03969774bcd1fe4ae849ea90fea1872ec9" "0xa2871c92f366441840d481f170fe08aa7153b5de5540bc2da9f9a8be5d02f645" "0xbb49637e1d25d40601d228fc9795b60eaf1f0e0d196568c544d28db091bf91e9" "0x208677a2f9626c2f4220e0221d01ae0fb807fe154a01c6cbddb40d22e17abd66" "0xc3506ca78a9d2ea20c94c557c297313be5d135822ba4acf61e985050e7a627e4"` |
| **Mainnet**          | `"0x03f70cfcbaa3dbf171db65410238e05b58c3ae7cb0219cb7068d59d56af96fb4" "0x746434bc85362fccb23bc104b6150faef0b2d2ff96a50f2d125530444a6b990f" "0x5ea455fda0028436b47d2ee7095b07503a3d7a6924f6f0e33abcee21a3ed2afd" "0xce5986cb6464d0cfc585715529b0d7c734318eadf7ab1aef5ad131bda99d7a72" "0xa4688020c7af1402d31f24298e4f8fd7e7bd9e5812a881231e2f673aad14c5c1" "0xfaa6beaa2748e4ff20d111baad11ec536ee4c608c3e4b73e6c3fd790659284aa" "0xc4796c45320e7cb67194b0225f8aee64cf9d882317c5610698d7c17deb292f0d" "0xd192d366f702fe58e35d48f1d9264711c86b4188220298f6a99fd77cd9c00973" "0x26e3963cda5bafaba03a0293327cd6025fadc816d2b61f69cec3c3e37353d23e"` |

8. Pause the `InterchainTokenService` contract

```bash
node stellar/contract.js pause InterchainTokenService
```

9. Verify `InterchainTokenService` is paused

```bash
node stellar/contract.js paused InterchainTokenService
```

10. Verify the `InterchainTokenService` tokenIds are still accurate via the explorer link above.

11. Call `ITS::migrate_token` for ALL deployed tokenIds (hex)

```bash
node stellar/its.js migrate-tokens "tokenId1" "tokenId2" "tokenIdN" --version 1.1.0
```

NOTE: `InterchainToken` + `TokenManager` contracts will be migrated automatically.

12. Unpause the 'InterchainTokenService' contract

```bash
node stellar/contract.js unpause InterchainTokenService
```

13. Revisit the `InterchainTokenService` storage via the explorer link above.

- The bytes value for `InterchainTokenWasmHash` should be replaced with a new WASM hash.
- The bytes value for `TokenManagerWasmHash` should be replaced with a new WASM hash.

14. Upgrade the `Upgrader` contract

```bash
node stellar/deploy-contract.js upgrade Upgrader --version 1.1.0
```

15. Remove the `createUpgradeAuths()` code added in the first step.

## Checklist

The following checks should be performed after the rollout

```bash
ITS_HUB_ADDRESS=<its_hub_address>
```

### Execute Command

The GMP call needs to be routed via Amplifier before the `execute` call.

- <https://docs.axelar.dev/dev/amplifier/chain-integration/relay-messages>

### Stellar to EVM

- Note: The final execute step of the GMP call on EVM can be performed via:

```bash
# Change `PRIVATE_KEY `.env` to EVM
PRIVATE_KEY=<evm_deployer_key>

node evm/gateway.js -n [destination-chain] --action execute --payload $PAYLOAD --sourceChain axelar --sourceAddress $ITS_HUB_ADDRESS --messageId [message-id] --destination [destination-address]
```

1. Deploy Native Interchain Token

```bash
node stellar/its.js deploy-interchain-token TEST test 18 0x1234 100

node stellar/its.js deploy-remote-interchain-token 0x1234 [destination-chain] --gas-amount 10000000
```

2. Interchain Token Transfer for Native Interchain Token

```bash
node stellar/its.js interchain-transfer [token-id] [destination-chain] [destination-address] [amount] --gas-amount 10000000
```

3. Deploy Remote Canonical Token

```bash
# Use XLM based on network:
# Devnet-Amplifier / Stagenet / Testnet: CDLZFC3SYJYDZT7K67VZ75HPJVIEUVNIXF47ZG2FB2RMQQVU2HHGCYSC
# Mainnet: CAS3J7GYLGXMF6TDJBBYYSE3HQ6BBSMLNUQ34T6TZMYMW2EVH34XOWMA

node stellar/its.js register-canonical-token [token-address]

node stellar/its.js deploy-remote-canonical-token [token-address] [destination-chain] --gas-amount 10000000
```

4. Interchain Token Transfer for Canonical Token

```bash
node stellar/its.js interchain-transfer [token-id] [destination-chain] [destination-address] [amount] --gas-amount 10000000
```

### EVM to Stellar

- Note: The final execute step of the GMP call on Stellar can be performed via:

```bash
# Change `PRIVATE_KEY in `.env` to Stellar
PRIVATE_KEY=<stellar_deployer_key>

node stellar/its.js execute [destination-chain] [message-id] [source-address] [payload]
```

1. Deploy Native Interchain Token

```bash
node evm/interchainTokenFactory.js --action deployInterchainToken -n [source-chain] --destinationChain $CHAIN --salt "salt" --name "test" --symbol "TEST" --decimals 18

# Adjust `--gasValue` or add gas directly from axelarscan for mainnet
node evm/interchainTokenFactory.js --action deployRemoteInterchainToken -n [source-chain] --destinationChain $CHAIN --salt "salt" --gasValue 1000000000000000000
```

2. Interchain Token Transfer for Native Interchain Token

```bash
node evm/its.js --action interchainTransfer -n [source-chain] --destinationChain $CHAIN --destinationAddress [encoded-recipient] --tokenId [token-id] --amount [amount]
```

3. Deploy Remote Canonical Token

```bash
node evm/interchainTokenFactory.js --action registerCanonicalInterchainToken -n [source-chain] --destinationChain $CHAIN --tokenAddress [token-address]

node evm/interchainTokenFactory.js --action deployRemoteCanonicalInterchainToken -n [source-chain] --destinationChain $CHAIN --tokenAddress [token-address] --gasValue 1000000000000000000
```

4. Interchain Token Transfer for Canonical Token

```bash
node evm/its.js --action interchainTransfer -n [source-chain] --destinationChain $CHAIN --destinationAddress [encoded-recipient] --tokenId [token-id] --amount [amount] --gasValue 1000000000000000000
```
