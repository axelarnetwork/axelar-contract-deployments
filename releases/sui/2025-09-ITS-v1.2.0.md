# Sui ITS v1.2.0

|                | **Owner**                              |
| -------------- | -------------------------------------- |
| **Created By** | @drewstaylor <drew@interoplabs.io>     |
| **Deployment** | @blockchainguyy <ayush@interoplabs.io> |

| **Network**          | **Deployment Status** | **Date**   |
| -------------------- | --------------------- | ---------- |
| **Devnet Amplifier** | Completed             | 2025-09-18 |
| **Stagenet**         | Completed             | 2025-09-19 |
| **Testnet**          | TBD                   | TBD        |
| **Mainnet**          | TBD                   | TBD        |

[Release](https://www.npmjs.com/package/@axelar-network/axelar-cgp-sui/tag/v1.2.0)

Many of the deployment commands require either Owner or Operator privileges on the ITS contract.

Some commands require a wallet that owns the contract's admin capability (`OwnerCap`). By default, this will be the address that deployed the ITS v0 contract.

The commands requiring this capability are:

- [Upgrading the ITS move contract](#upgrading-the-its-move-contract)
- [Enabling the Upgrade](#enabling-the-upgrade)
- [Disabling the Legacy Contract](#disabling-the-legacy-contract)

Migrating legacy coin metadata requires a `OperatorCap` capability. This is any address added as an operator for the affected coin. By default, the address that deployed and initialized the ITS v0 contract possesses a `OperatorCap`.

The commands requiring this capability are:

- [Migrating Legacy Tokens](#migrating-legacy-tokens)

## Deployment

```bash
# Clone latest main and update deps
npm ci && npm run build
```

Create a `.env` config. Use `all` for `CHAINS` to run the cmd for every EVM chain, or set a specific chain. On `devnet-amplifier` chain name will be set to `sui-2`.

```bash
PRIVATE_KEY=<sui-its-admin-caps-holder>
PRIVATE_KEY_TYPE="mnemonic" # Optional
SIGNATURE_SCHEME=secp256k1
ENV=<devnet-amplifier|stagenet|testnet|mainnet>
CHAIN=sui
```

| Network          | ITS Admin Caps Holder (OwnerCap, UpgradeCap, OperatorCap)          |
| ---------------- | ------------------------------------------------------------------ |
| devnet-amplifier | 0x3a6ff6c3d2b12d8acd39d9bbddca1094c28081123e59ffd0dee618d36207ee88 |
| stagenet         | 0x3a6ff6c3d2b12d8acd39d9bbddca1094c28081123e59ffd0dee618d36207ee88 |
| testnet          | 0x3a6ff6c3d2b12d8acd39d9bbddca1094c28081123e59ffd0dee618d36207ee88 |
| mainnet          | 0x980372415053fe9d09956dea38d33d295f10de3d5c5226099304fe346ce241c9 |

1. To fix the issue of some tokens not displaying correctly in wallets, we need to fetch the affected tokens. This list can be fetched before, or after the upgrade.

```bash
# Save legacy tokens for later migration
ts-node sui/tokens legacy-coins
```

2. Update the release dependency in `package.json`

```diff
- "@axelar-network/axelar-cgp-sui": "1.1.3",
+ "@axelar-network/axelar-cgp-sui": "1.2.0",
```

and run

```bash
npm i
```

3. Update the Sui compiler version from 1.38 to 1.55 using [suiup](https://github.com/MystenLabs/suiup)

```bash
# If 1.55 is already installed
suiup default set sui@v1.55.0

# Or, if 1.55 is not yet installed
suiup install sui@v1.55.0

# Make sure that 1.55 version is in your path:
sui --version
# sui 1.55.0-53c8eb3b93dc
```

4. Do the upgrade tx

```bash
# Upgrade InterchainTokenService v0 -> v1
ts-node sui/deploy-contract upgrade InterchainTokenService any_upgrade
```

5. Migrate version control state to enable the upgrade.

```bash
ts-node sui/deploy-contract migrate InterchainTokenService
```

## Checklist

The following post-upgrade tasks should be performed after the rollout

- [ ] [Disable the legacy ITS contract](#disabling-the-legacy-contract)
- [ ] [Verify Version Control state (v0 and v1)](#verify-version-control-state)
- [ ] [Re-deploy Example contract](#re-deploy-example-contract)
- [ ] [Migrate metadata of legacy coins](#migrating-legacy-tokens)
- [ ] [Test ITS token deployment and transfers](#test-its-token-deployment-and-transfers)
- [ ] [Test custom token linking](#test-custom-token-linking)

### Disabling the Legacy Contract

```bash
# Disallow all functions in the legacy ITS package
ts-node sui/contract pause --functions "all" --version "0" InterchainTokenService
```

### Verify Version Control State

1. All functions should be enabled on v1

```bash
ts-node sui/its check-version-control 1
```

2. Only `allow_function` and `disallow_function` should be enabled on v0

```bash
ts-node sui/its check-version-control 0
```

### Re-deploy Example contract

1. Re-deploy the Example contract:

- Note (Optional): Preferred to use PRIVATE_KEY of deployer

```bash
ts-node sui/deploy-contract deploy Example
```

### Migrating Legacy Tokens

- Note: use PRIVATE_KEY of ITS Admin Caps Holder

```bash
# Migrate legacy tokens in batches of 10 coins per tx
ts-node sui/its migrate-coin-metadata-all --batch 10
# Or
# Migrate legacy tokens in batches of 10, with verbose logging
ts-node sui/its migrate-coin-metadata-all --batch 10 --logging 10
```

### Test ITS token deployment and transfers

1. Test Sui Token Deployment using either lock / unlock or mint / burn token manager

```bash
# Register token with manager type: lock / unlock
ts-node sui/its-example deploy-token [coin-symbol] "Test Token" 9 --origin

# Register token with manager type: mint / burn
ts-node sui/its-example deploy-token [coin-symbol] "Test Token" 9 --tokenManagerMode "mint_burn" --mintAmount 100 --origin
```

Testing Sui <-> EVM transfers

1. Send Token Deployment to Another Chain

```bash
ts-node sui/its-example send-deployment [coin-symbol] [chain] [gas-value]
# Example:
# ts-node sui/its-example send-deployment LOCK avalanche 0.5
```

2. Send Tokens to an EVM Chain

```bash
ts-node sui/its-example send-token [coin-symbol] [chain] [recepient-address] [gas-value] [amount-to-send]
# Example:
# ts-node sui/its-example send-token LOCK avalanche 0xba76c6980428A0b10CFC5d8ccb61949677A61233 0.5 50
```

3. Send Tokens Back to Sui, from an EVM Chain

```bash
ts-node evm/its interchain-transfer sui [token-id] [recipient] [amount-to-send] --gasValue [gas-value] -n [evm-chain]
# Example:
# ts-node evm/its interchain-transfer sui 0x334e3a13a8d0a8fc8ab5c7828fa4c664821f0a514e2ed447de9d9103352d7873 0x76f89a9b56dc580aed9f97e2b3bd03d8d24464e38522da9464c15103761c6707 5 --gasValue 5000 -n avalanche
```

### Test custom token linking

0. Enviroment setup

```bash
NAME="TEST1234"
SYMBOL="TEST1234"
EVM_DECIMALS=9
SUI_DECIMALS=6
# EVM contract validates salt uniqueness, salt cannot be reused
EVM_TEMP_SALT="TEST1234" # Token manager deployed with this salt will be discarded
# Sui contract validates salt length, it must match Sui address (66)
SALT=0x0000000000000000000000000000000000000000000000000000000000000001 
EVM_CHAIN=avalanche
TOKEN_MANAGER_MODE=lock_unlock # Source chain
DESTINATION_TOKEN_MANAGER_MODE=mint_burn # Destination chain

# Token manager types
LOCK_UNLOCK=2
MINT_BURN=4
MINT_BURN_FROM=1
```

#### Case 1: Sui as source chain

1. Deploy tokens on both chains and register token metadata for each

- Run on EVM chain, update env with the EVM private key:

```bash
# DESTINATION CHAIN
# Deploy token on EVM
ts-node evm/interchainTokenFactory --action deployInterchainToken --minter [wallet-address] --name $NAME --symbol $SYMBOL --decimals $EVM_DECIMALS --initialSupply 100000000000 --salt $EVM_TEMP_SALT -n $EVM_CHAIN

# Set EVM_TOKEN_ADDRESS and EVM_TOKEN_ID from the result
EVM_TOKEN_ADDRESS=

# Register EVM token metadata on Axelar Hub
ts-node evm/its register-token-metadata $EVM_TOKEN_ADDRESS -n $EVM_CHAIN
```

- Run on Sui chain, with sui private key:

```bash
# SOURCE CHAIN
# Deploy token on Sui. Mint burn token manager requires `--treasuryCap`.
ts-node sui/its register-custom-coin $SYMBOL $NAME $SUI_DECIMALS --treasuryCap
# ts-node sui/its register-custom-coin TSTC "Test Coin" 9 --channel 0xcb28218c416880bf305404b0a23c4fcb30965c6955e87a6a963137324ba364e6 --treasuryCap

# Register token metadata on Axelar Hub
ts-node sui/its register-coin-metadata $SYMBOL
# ts-node sui/its register-coin-metadata TSTC
```

2. Link source chain (Sui) token to EVM token; this will deploy a token manager on destination chain.

```bash
# SOURCE CHAIN
# Link Sui coin to the destination token
# --channel must be added in case of mint_burn type token connection, it can be found in register custom coin tx
ts-node sui/its link-coin $SYMBOL $EVM_CHAIN $EVM_TOKEN_ADDRESS --tokenManagerMode $TOKEN_MANAGER_MODE  --destinationTokenManagerMode $DESTINATION_TOKEN_MANAGER_MODE --registered
# ts-node sui/its link-coin TSTC avalanche 0x7E3481a01efd4E16389D65A10f96833cA83a464b --tokenManagerMode mint_burn  --destinationTokenManagerMode lock_unlock --channel 0xcb28218c416880bf305404b0a23c4fcb30965c6955e87a6a963137324ba364e6 --registered

# Record the Sui Token ID from the token entry in chain config
SUI_TOKEN_ID=

ts-node evm/its.js token-manager-address $SUI_TOKEN_ID -n $EVM_CHAIN

TOKEN_MANAGER=

# Transfer Mintership if required to Token manager
# ts-node evm/its.js transfer-mintership $EVM_TOKEN_ADDRESS $TOKEN_MANAGER -n $EVM_CHAIN
```

3. Interchain Transfer (both ways)

```bash
ts-node evm/its interchain-transfer sui $SUI_TOKEN_ID [wallet-address] 125 -n $EVM_CHAIN
```

```bash
ts-node sui/its interchain-transfer [coinPackageId] [coinPackageName] [coinModName] [coinObjectID] $SUI_TOKEN_ID $EVM_CHAIN [destinationAddress] [amount]
# ts-node sui/its interchain-transfer 0x265ce251c3a65f0ddfe0d90a62b758662209813b26adb7b76f260c148bc92350 tstc TSTC 0x62b91d9f23658bd01c5ad6942ac0d11d2ef9de9f588f7bb28c040c38f12a2be7 0x1b1fa2634fa1bd00c63259910c7410a9426af705c60874cc295ad2f8904715ae avalanche 0x13f8C723AeB8CA762c652c553a11a11483846d8B 100000000000
```
#### Case 2: Evm as source chain

1. Deploy tokens on both chains, and register their metadata on Axelar Hub.


- Run on EVM chain, update env with the EVM private key:

```bash
# DESTINATION CHAIN (Sui)
ts-node sui/tokens publish-coin $SYMBOL $NAME $DECIMALS
# ts-node sui/tokens publish-coin DTCOIN "Coin Test" 9

ts-node sui/its register-coin-metadata $SYMBOL
# ts-node sui/its register-coin-metadata DTCOIN
```

- Run on Sui chain, update env with the Sui private key:

```bash
# SOURCE CHAIN (EVM)
ts-node evm/interchainTokenFactory --action deployInterchainToken --minter [wallet-address] --name $NAME --symbol $SYMBOL --decimals 9 --initialSupply 100000000000 --salt $EVM_TEMP_SALT -n $EVM_CHAIN
# ts-node evm/interchainTokenFactory --action deployInterchainToken --minter 0x13f8C723AeB8CA762c652c553a11a11483846d8B --name "Coin Test" --symbol DTCOIN --decimals 9 --initialSupply 100000000000 --salt "tmpSaltDtCoin01" -n avalanche

# Set Token Address from result
EVM_TOKEN_ADDRESS=

ts-node evm/its register-token-metadata $EVM_TOKEN_ADDRESS -n $EVM_CHAIN
# ts-node evm/its register-token-metadata 0x899848ebD896ece4395736B20883539495218D7A -n avalanche
```

2. Register EVM custom token

- Run on EVM chain, update env with the EVM private key:

```bash
ts-node evm/interchainTokenFactory --action registerCustomToken --tokenAddress $EVM_TOKEN_ADDRESS --tokenManagerType $MINT_BURN --operator [wallet-address] --salt $SALT -n $EVM_CHAIN
# ts-node evm/interchainTokenFactory --action registerCustomToken --tokenAddress 0x899848ebD896ece4395736B20883539495218D7A --tokenManagerType 4 --operator 0x13f8C723AeB8CA762c652c553a11a11483846d8B --salt "realSaltDtCoin01" -n avalanche

# Record Token ID from result
EVM_TOKEN_ID=
```

3. Mint tokens to user on Sui

- Run on Sui chain, update env with the Sui private key:

```bash
ts-node sui/its-example mint-token $SYMBOL --recipient [wallet-address]
# ts-node sui/its-example mint-token DTCOIN --recipient 0x76f89a9b56dc580aed9f97e2b3bd03d8d24464e38522da9464c15103761c6707
```

4. Give unlinked Sui coin to ITS

- Run on Sui chain, update env with the Sui private key:

```bash
ts-node sui/its give-unlinked-coin $SYMBOL $EVM_TOKEN_ID --treasuryCapReclaimer
# ts-node sui/its give-unlinked-coin DTCOIN 0xbf95fba6a7e0feffdae870e91ca00d1287152dc0c6913349f6c577cecb036045 --treasuryCapReclaimer
```

5. Link source (EVM) and destination tokens (Sui)

- Run on EVM chain, update env with the EVM private key:

```bash
ts-node evm/interchainTokenFactory --action linkToken --destinationChain sui --destinationTokenAddress $SUI_COIN_TYPE --tokenManagerType $MINT_BURN --linkParams "0x" --salt $SALT -n avalanche
# ts-node evm/interchainTokenFactory --action linkToken --destinationChain sui --destinationTokenAddress "4d04e01b9bc1775cfe97a89f367d1c822fb55c21850e6e2813349e6f422bb451::dtcoin::DTCOIN" --tokenManagerType 4 --linkParams "0x" --salt "realSaltDtCoin01" -n avalanche

# Set the Token ID from the result
EVM_TOKEN_ID=
```

6. Transfer EVM minter role to Token Manager contract

- Run on EVM chain, update env with the EVM private key:

```bash
ts-node evm/its.js token-manager-address $EVM_TOKEN_ID -n $EVM_CHAIN
# ts-node evm/its.js token-manager-address 0xbf95fba6a7e0feffdae870e91ca00d1287152dc0c6913349f6c577cecb036045 -n avalanche

# Record the Token Manager from the result
TOKEN_MANAGER=

ts-node evm/its.js transfer-mintership $EVM_TOKEN_ADDRESS $TOKEN_MANAGER -n $EVM_CHAIN
# ts-node evm/its.js transfer-mintership 0x899848ebD896ece4395736B20883539495218D7A 0xB4778215c814fF29Bffb4171605A3acDcEe3DF0C -n avalanche
```


_TODO: Fix step 7_
7. Interchain Transfer (both ways)

- Run on EVM chain, update env with the EVM private key:

```bash
ts-node evm/its interchain-transfer sui $EVM_TOKEN_ID [wallet-address] 125 -n $EVM_CHAIN
# ts-node evm/its interchain-transfer sui 0xa71bac93b2580036a01288256a23d7491fa9d166f6514d55a3b38f3203434a7b 0x4cdab023fcddcf492891b9d72ce7b523c5b465883d02fedd1bbe81f4598cf40b 125 -n avalanche
```

- Run on Sui chain, update env with the Sui private key:

```bash
# ts-node sui/its interchain-transfer 0x67db6d266f19b647b40900508a65879478622acdb76d7c01f6d61a1b0bce6bac dtcoin DTCOIN 0xfc215a6e8b45dbdc0be9e6364a6080a1fb2cf59a6ec5db3c0c2632619bb832ea 0xa71bac93b2580036a01288256a23d7491fa9d166f6514d55a3b38f3203434a7b avalanche 0x13f8C723AeB8CA762c652c553a11a11483846d8B 15000000000

# ts-node sui/its-example send-token DTCOIN avalanche 0x13f8C723AeB8CA762c652c553a11a11483846d8B 0.5 1
```
