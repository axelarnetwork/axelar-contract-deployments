# Sui ITS v1.2.0

|                | **Owner**                              |
|----------------|----------------------------------------|
| **Created By** | @drewstaylor <drew@interoplabs.io>     |
| **Deployment** | @blockchainguyy <ayush@interoplabs.io> |

| **Network**          | **Deployment Status** | **Date**   |
|----------------------|-----------------------|------------|
| **Devnet Amplifier** | Completed             | 2025-09-18 |
| **Stagenet**         | Completed             | 2025-09-19 |
| **Testnet**          | TBD                   | TBD        |
| **Mainnet**          | TBD                   | TBD        |

[Release](https://www.npmjs.com/package/@axelar-network/axelar-cgp-sui/tag/v1.2.0)

Many of the deployment commands require either Owner or Operator privileges on the ITS contract.

Some commands require a wallet that owns the contract's admin capability (`OwnerCap`). By default, this will be the address that deployed the ITS v0 contract.

The commands requiring this capability are:
* [Upgrading the ITS move contract](#upgrading-the-its-move-contract)
* [Enabling the Upgrade](#enabling-the-upgrade)
* [Disabling the Legacy Contract](#disabling-the-legacy-contract)

Migrating legacy coin metadata requires a `OperatorCap` capability. This is any address added as an operator for the affected coin. By default, the address that deployed and initialized the ITS v0 contract possesses a `OperatorCap`.

The commands requiring this capability are:
* [Migrating Legacy Tokens](#migrating-legacy-tokens)


## Deployment

```bash
# Clone latest main and update deps
npm ci && npm run build
```

Create a `.env` config. Use `all` for `CHAINS` to run the cmd for every EVM chain, or set a specific chain. On `devnet-amplifier` chain name will be set to `sui-2`.

```bash
PRIVATE_KEY=<sui-deployer-key>
PRIVATE_KEY_TYPE="mnemonic" # Optional
SIGNATURE_SCHEME=secp256k1
ENV=<devnet-amplifier|stagenet|testnet|mainnet>
CHAIN=sui
```

1. To fix the issue of some tokens not displaying correctly in wallets, we need to fetch the affected tokens. This list can be fetched before, or after the upgrade.

```bash
# Save legacy tokens for later migration
ts-node sui/tokens legacy-coins
```

2. Update the release dependency in `package.json`

```diff
- "@axelar-network/axelar-cgp-sui": "1.1.3",
+ "@axelar-network/axelar-cgp-sui": "1.2.0",
```

and run
```bash
npm i
```

3. Update the Sui compiler version from 1.38 to 1.55 using [suiup](https://github.com/MystenLabs/suiup)

```bash
# If 1.55 is already installed
suiup default set sui@v1.55.0

# Or, if 1.55 is not yet installed
suiup install sui@v1.55.0

# Make sure that 1.55 version is in your path:
sui --version
# sui 1.55.0-53c8eb3b93dc
```

4. Do the upgrade tx

- Note: use PRIVATE_KEY of `UpgradeCap` object of v0 ITS

```bash
# Upgrade InterchainTokenService v0 -> v1
ts-node sui/deploy-contract upgrade InterchainTokenService any_upgrade
```

5. Migrate version control state to enable the upgrade. 

- Note: use PRIVATE_KEY of `UpgradeCap` object of v0 ITS

```bash
ts-node sui/deploy-contract migrate InterchainTokenService
```

## Checklist

The following post-upgrade tasks should be performed after the rollout

- [ ] [Disable the legacy ITS contract](#disabling-the-legacy-contract)
- [ ] [Verify Version Control state (v0 and v1)](#verify-version-control-state)
- [ ] [Re-deploy Example contract](#re-deploy-example-contract)
- [ ] [Migrate metadata of legacy coins](#migrating-legacy-tokens)
- [ ] [Test ITS token deployment and transfers](#test-its-token-deployment-and-transfers)
- [ ] [Test custom token linking](#test-custom-token-linking)

### Disabling the Legacy Contract ###

```bash
# Disallow all functions in the legacy ITS package
ts-node sui/contract pause --functions "all" --version "0" InterchainTokenService
```

### Verify Version Control State

1. All functions should be enabled on v1

```bash
ts-node sui/its check-version-control 1
```

2. Only `allow_function` and `disallow_function` should be enabled on v0

```bash
ts-node sui/its check-version-control 0
```

### Re-deploy Example contract

1. Update the move contracts locally

```bash
ts-node sui/deploy-contract sync
```

- Note: this will ensure the `Move.toml` and `Move.lock` don't need to be manually edited

2. Now, you can re-deploy the Example contract:

- Note: use PRIVATE_KEY of deployer 

```bash
ts-node sui/deploy-contract deploy Example
```

### Migrating Legacy Tokens

- Note: use PRIVATE_KEY of `UpgradeCap` object of v0 ITS

```bash
# Migrate legacy tokens in batches of 10 coins per tx
ts-node sui/its migrate-coin-metadata-all --batch 10
# Or
# Migrate legacy tokens in batches of 10, with verbose logging
ts-node sui/its migrate-coin-metadata-all --batch 10 --logging 10
```

### Test ITS token deployment and transfers

Test Sui Token Deployment using either lock / unlock or mint / burn token manager

```bash
# Register token with manager type: lock / unlock
ts-node sui/its-example deploy-token --origin LOCK "Test Token" 9

# Register token with manager type: mint / burn
ts-node sui/its-example deploy-token --tokenManagerMode "mint_burn" --mintAmount 100 --origin MINT "Test Token" 9
```

Testing Sui <-> EVM transfers

1. Send Token Deployment to Another Chain
```bash
ts-node sui/its-example send-deployment [coin-symbol] [chain] [gas-value]
# Example:
# ts-node sui/its-example send-deployment LOCK avalanche-fuji 0.5
```

2. Send Tokens to an EVM Chain
```bash
ts-node sui/its-example send-token [coin-symbol] [chain] [recepient-address] [gas-value] [amount-to-send]
# Example:
# ts-node sui/its-example send-token LOCK avalanche-fuji 0xba76c6980428A0b10CFC5d8ccb61949677A61233 0.5 1000
```

3. Send Tokens Back to Sui, from an EVM Chain
```bash
ts-node evm/its interchain-transfer sui [token-id] [recipient] [amount-to-send] --gasValue [gas-value] -n [evm-chain]
# Example: 
# ts-node evm/its interchain-transfer sui 0x334e3a13a8d0a8fc8ab5c7828fa4c664821f0a514e2ed447de9d9103352d7873 0x76f89a9b56dc580aed9f97e2b3bd03d8d24464e38522da9464c15103761c6707 25 --gasValue 5000 -n avalanche-fuji
```

### Test custom token linking

Deploy a custom token and link it to the token on the origin chain. 

- Note: test for both lock / unlock and mint / burn tokens

```bash
ts-node sui/its link-coin [coin-symbol] [coin-description] [coin-decimals] [destination-chain] [destination-token-address] --tokenManagerMode ['lock_unlock' | 'mint_burn'] --destinationOperator [address]

# Example (lock / unlock)
# ts-node sui/its link-coin LNKL "Custom link coin" 10 ethereum-sepolia 0x3fc29836e84e471a053d2d9e80494a867d670ead

# Example (mint / burn)
# ts-node sui/its link-coin LNKM "Custom link coin" 10 ethereum-sepolia 0x3fc29836e84e471a053d2d9e80494a867d670ead --tokenManagerMode mint_burn --destinationOperator 0x13f8C723AeB8CA762c652c553a11a11483846d8B
```
