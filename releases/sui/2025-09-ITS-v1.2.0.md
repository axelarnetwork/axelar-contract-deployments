# Sui ITS v1.2.0

|                | **Owner**                              |
| -------------- | -------------------------------------- |
| **Created By** | @drewstaylor <drew@interoplabs.io>     |
| **Deployment** | @blockchainguyy <ayush@interoplabs.io> |

| **Network**          | **Deployment Status** | **Date**   |
| -------------------- | --------------------- | ---------- |
| **Devnet Amplifier** | Completed             | 2025-09-18 |
| **Stagenet**         | Completed             | 2025-09-19 |
| **Testnet**          | TBD                   | TBD        |
| **Mainnet**          | TBD                   | TBD        |

[Release](https://www.npmjs.com/package/@axelar-network/axelar-cgp-sui/tag/v1.2.0)

Many of the deployment commands require either Owner or Operator privileges on the ITS contract.

Some commands require a wallet that owns the contract's admin capability (`OwnerCap`). By default, this will be the address that deployed the ITS v0 contract.

The commands requiring this capability are:

- [Upgrading the ITS move contract](#upgrading-the-its-move-contract)
- [Enabling the Upgrade](#enabling-the-upgrade)
- [Disabling the Legacy Contract](#disabling-the-legacy-contract)

Migrating legacy coin metadata requires a `OperatorCap` capability. This is any address added as an operator for the affected coin. By default, the address that deployed and initialized the ITS v0 contract possesses a `OperatorCap`.

The commands requiring this capability are:

- [Migrating Legacy Tokens](#migrating-legacy-tokens)

## Deployment

```bash
# Clone latest main and update deps
npm ci && npm run build
```

Create a `.env` config. Use `all` for `CHAINS` to run the cmd for every EVM chain, or set a specific chain. On `devnet-amplifier` chain name will be set to `sui-2`.

```bash
PRIVATE_KEY=<sui-its-admin-caps-holder>
PRIVATE_KEY_TYPE="mnemonic" # Optional
SIGNATURE_SCHEME=secp256k1
ENV=<devnet-amplifier|stagenet|testnet|mainnet>
CHAIN=sui
```

| Network          | ITS Admin Caps Holder (OwnerCap, UpgradeCap, OperatorCap)          |
| ---------------- | ------------------------------------------------------------------ |
| devnet-amplifier | 0x3a6ff6c3d2b12d8acd39d9bbddca1094c28081123e59ffd0dee618d36207ee88 |
| stagenet         | 0x3a6ff6c3d2b12d8acd39d9bbddca1094c28081123e59ffd0dee618d36207ee88 |
| testnet          | 0x3a6ff6c3d2b12d8acd39d9bbddca1094c28081123e59ffd0dee618d36207ee88 |
| mainnet          | 0x980372415053fe9d09956dea38d33d295f10de3d5c5226099304fe346ce241c9 |

1. To fix the issue of some tokens not displaying correctly in wallets, we need to fetch the affected tokens. This list can be fetched before, or after the upgrade.

```bash
# Save legacy tokens for later migration
ts-node sui/tokens legacy-coins
```

2. Update the release dependency in `package.json`

```diff
- "@axelar-network/axelar-cgp-sui": "1.1.3",
+ "@axelar-network/axelar-cgp-sui": "1.2.0",
```

and run

```bash
npm i
```

3. Update the Sui compiler version from 1.38 to 1.55 using [suiup](https://github.com/MystenLabs/suiup)

```bash
# If 1.55 is already installed
suiup default set sui@v1.55.0

# Or, if 1.55 is not yet installed
suiup install sui@v1.55.0

# Make sure that 1.55 version is in your path:
sui --version
# sui 1.55.0-53c8eb3b93dc
```

4. Do the upgrade tx

```bash
# Upgrade InterchainTokenService v0 -> v1
ts-node sui/deploy-contract upgrade InterchainTokenService any_upgrade
```

5. Migrate version control state to enable the upgrade.

```bash
ts-node sui/deploy-contract migrate InterchainTokenService
```

## Checklist

The following post-upgrade tasks should be performed after the rollout

- [ ] [Disable the legacy ITS contract](#disabling-the-legacy-contract)
- [ ] [Verify Version Control state (v0 and v1)](#verify-version-control-state)
- [ ] [Re-deploy Example contract](#re-deploy-example-contract)
- [ ] [Migrate metadata of legacy coins](#migrating-legacy-tokens)
- [ ] [Test ITS token deployment and transfers](#test-its-token-deployment-and-transfers)
- [ ] [Test custom token linking](#test-custom-token-linking)

### Disabling the Legacy Contract

```bash
# Disallow all functions in the legacy ITS package
ts-node sui/contract pause --functions "all" --version "0" InterchainTokenService
```

### Verify Version Control State

1. All functions should be enabled on v1

```bash
ts-node sui/its check-version-control 1
```

2. Only `allow_function` and `disallow_function` should be enabled on v0

```bash
ts-node sui/its check-version-control 0
```

### Re-deploy Example contract

1. Re-deploy the Example contract:

- Note (Optional): Preferred to use PRIVATE_KEY of deployer

```bash
ts-node sui/deploy-contract deploy Example
```

### Migrating Legacy Tokens

- Note: use PRIVATE_KEY of ITS Admin Caps Holder

```bash
# Migrate legacy tokens in batches of 10 coins per tx
ts-node sui/its migrate-coin-metadata-all --batch 10
# Or
# Migrate legacy tokens in batches of 10, with verbose logging
ts-node sui/its migrate-coin-metadata-all --batch 10 --logging 10
```

### Test ITS token deployment and transfers

1. Test Sui Token Deployment using either lock / unlock or mint / burn token manager

```bash
# Register token with manager type: lock / unlock
ts-node sui/its-example deploy-token [coin-symbol] "Test Token" 9 --origin

# Register token with manager type: mint / burn
ts-node sui/its-example deploy-token [coin-symbol] "Test Token" 9 --tokenManagerMode "mint_burn" --mintAmount 100 --origin
```

Testing Sui <-> EVM transfers

1. Send Token Deployment to Another Chain

```bash
ts-node sui/its-example send-deployment [coin-symbol] [chain] [gas-value]
# Example:
# ts-node sui/its-example send-deployment LOCK avalanche 0.5
```

2. Send Tokens to an EVM Chain

```bash
ts-node sui/its-example send-token [coin-symbol] [chain] [recepient-address] [gas-value] [amount-to-send]
# Example:
# ts-node sui/its-example send-token LOCK avalanche 0xba76c6980428A0b10CFC5d8ccb61949677A61233 0.5 50
```

3. Send Tokens Back to Sui, from an EVM Chain

```bash
ts-node evm/its interchain-transfer sui [token-id] [recipient] [amount-to-send] --gasValue [gas-value] -n [evm-chain]
# Example:
# ts-node evm/its interchain-transfer sui 0x334e3a13a8d0a8fc8ab5c7828fa4c664821f0a514e2ed447de9d9103352d7873 0x76f89a9b56dc580aed9f97e2b3bd03d8d24464e38522da9464c15103761c6707 5 --gasValue 5000 -n avalanche
```

### Test custom token linking (Sui as source)

1. Enviroment setup

```bash
NAME="TEST1234"
SYMBOL="TEST1234"
# Sui contract validates salt length, it must match Sui address (66)
SALT=0x4cdab023fcddcf492891b9d72ce7b523c5b465883d02fedd1bbe81f4598cf40b 
EVM_CHAIN=avalanche
TOKEN_MANAGER_MODE=lock_unlock
#TOKEN_MANAGER_MODE=lock_unlock
DECIMALS=9
```

2. Deploy tokens on both chains and register token metadata for each

- Run on Sui chain, with sui private key:

```bash
# SOURCE CHAIN
# Deploy token on Sui and register token metadata on Axelar Hub
ts-node sui/its register-coin-metadata $SYMBOL $EVM_CHAIN --coinName $NAME --coinDecimals $DECIMALS
```

- Run on EVM chain, update env with the EVM private key:

```bash
# DESTINATION CHAIN
# Deploy token on EVM
ts-node evm/interchainTokenFactory --action deployInterchainToken --minter 0xba76c6980428A0b10CFC5d8ccb61949677A61233 --name $NAME --symbol $SYMBOL --decimals 9 --initialSupply 100000000000 --salt $SALT -n $EVM_CHAIN

# Set EVM_TOKEN_ADDRESS and EVM_TOKEN_ID from the result
EVM_TOKEN_ADDRESS=
EVM_TOKEN_ID=

# Register EVM token metadata on Axelar Hub
ts-node evm/its register-token-metadata $EVM_TOKEN_ADDRESS -n $EVM_CHAIN
```

3. Source chain (Sui) registers custom token and links it (this will deploy a token manager on destination chain)

- Run on Sui chain, update env with sui private key:

```bash
# SOURCE CHAIN
# Register custom coin on sui and link it to the destination token
ts-node sui/its link-coin $SYMBOL $EVM_CHAIN $EVM_TOKEN_ADDRESS --tokenManagerMode $TOKEN_MANAGER_MODE --salt $SALT
```

4. (**MINT_BURN only**) Transfer mintership on EVM chain to its Token Manager

- Run on EVM chain, update env with the EVM private key:

```bash
# DESTINATION CHAIN
# (Only do if TOKEN_MANAGER_MODE is mint_burn)

# Record tokenManager address from output for transferMintership
ts-node evm/its.js token-manager-address $EVM_TOKEN_ID -n $EVM_CHAIN

TOKEN_MANAGER_ADDRESS=

# Transfer mintership for each token to the token manager
ts-node evm/its.js transfer-mintership $EVM_TOKEN_ADDRESS $TOKEN_MANAGER_ADDRESS -n $EVM_CHAIN
```

- Interchain Transfer (both ways)

```bash
ts-node evm/its interchain-transfer sui [token-id] [recipient] [amount-to-send] --gasValue [gas-value] -n [sui-chain]

ts-node sui/its-example send-token [coin-symbol] [chain] [recepient-address] [gas-value] [amount-to-send]
```

### Test custom token linking (Sui as destination)

TODO
