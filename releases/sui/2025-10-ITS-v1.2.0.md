# Sui ITS v1.2.0

|                | **Owner**                              |
| -------------- | -------------------------------------- |
| **Created By** | @drewstaylor <drew@interoplabs.io>     |
| **Deployment** | @blockchainguyy <ayush@interoplabs.io> |

| **Network**          | **Deployment Status** | **Date**   |
| -------------------- | --------------------- | ---------- |
| **Devnet Amplifier** | Completed             | 2025-09-18 |
| **Stagenet**         | Completed             | 2025-09-19 |
| **Testnet**          | Completed             | 2025-10-08 |
| **Mainnet**          | Completed             | 2025-10-10 |

[Release](https://www.npmjs.com/package/@axelar-network/axelar-cgp-sui/tag/v1.2.0)

Many of the deployment commands require either Owner or Operator privileges on the ITS contract.

Some commands require a wallet that owns the contract's admin capability (`OwnerCap`). By default, this will be the address that deployed the ITS v0 contract.

The commands requiring this capability are:

- [Upgrading the ITS move contract](#upgrading-the-its-move-contract)
- [Enabling the Upgrade](#enabling-the-upgrade)
- [Disabling the Legacy Contract](#disabling-the-legacy-contract)

Migrating legacy coin metadata requires a `OperatorCap` capability. This is any address added as an operator for the affected coin. By default, the address that deployed and initialized the ITS v0 contract possesses a `OperatorCap`.

The commands requiring this capability are:

- [Migrating Legacy Tokens](#migrating-legacy-tokens)

## Deployment

```bash
# Clone latest main and update deps
npm ci && npm run build
```

Create a `.env` config. Use `all` for `CHAINS` to run the cmd for every EVM chain, or set a specific chain. On `devnet-amplifier` chain name will be set to `sui-2`.

```bash
PRIVATE_KEY=<sui-its-admin-caps-holder>
PRIVATE_KEY_TYPE="mnemonic" # Optional
SIGNATURE_SCHEME=secp256k1
ENV=<devnet-amplifier|stagenet|testnet|mainnet>
CHAIN=sui
```

| Network          | ITS Admin Caps Holder (OwnerCap, UpgradeCap, OperatorCap)          |
| ---------------- | ------------------------------------------------------------------ |
| devnet-amplifier | 0x3a6ff6c3d2b12d8acd39d9bbddca1094c28081123e59ffd0dee618d36207ee88 |
| stagenet         | 0x3a6ff6c3d2b12d8acd39d9bbddca1094c28081123e59ffd0dee618d36207ee88 |
| testnet          | 0x3a6ff6c3d2b12d8acd39d9bbddca1094c28081123e59ffd0dee618d36207ee88 |
| mainnet          | 0x980372415053fe9d09956dea38d33d295f10de3d5c5226099304fe346ce241c9 |

1. To fix the issue of some tokens not displaying correctly in wallets, we need to fetch the affected tokens. This list can be fetched before, or after the upgrade.

```bash
# Save legacy tokens for later migration
ts-node sui/tokens legacy-coins
```

2. Update the release dependency in `package.json`

```diff
- "@axelar-network/axelar-cgp-sui": "1.1.3",
+ "@axelar-network/axelar-cgp-sui": "1.2.0",
```

and run

```bash
# Remove the old version to avoid cache issues
rm -r node_modules/@axelar-network/axelar-cgp-sui/
rm -r sui/move

npm i
```

3. Update the Sui compiler version from 1.38 to 1.55 using [suiup](https://github.com/MystenLabs/suiup)

```bash
# If 1.55 is already installed
suiup default set sui@v1.55.0

# Or, if 1.55 is not yet installed
suiup install sui@v1.55.0

# Make sure that 1.55 version is in your path:
sui --version
# sui 1.55.0-53c8eb3b93dc
```

4. Do the upgrade tx

```bash
# run sync
ts-node sui/deploy-contract.js sync
# Upgrade InterchainTokenService v0 -> v1
ts-node sui/deploy-contract upgrade InterchainTokenService any_upgrade
```

5. Migrate version control state to enable the upgrade.

```bash
ts-node sui/deploy-contract migrate InterchainTokenService
```

### Disabling the Legacy Contract

```bash
# Disallow all functions in the legacy ITS package
ts-node sui/contract pause --functions "all" --version "0" InterchainTokenService
```

### Re-deploy Example contract

1. Re-deploy the Example contract:

- Note (Optional): Preferred to use PRIVATE_KEY of deployer

```bash
ts-node sui/deploy-contract deploy Example
```

### Migrating Legacy Tokens

- Note: use PRIVATE_KEY of ITS Admin Caps Holder

```bash
# Migrate legacy tokens in batches of 10 coins per tx
ts-node sui/its migrate-coin-metadata-all --batch 10
# Or
# Migrate legacy tokens in batches of 10, with verbose logging
ts-node sui/its migrate-coin-metadata-all --batch 10 --logging 10
```

## Checklist

The following post-upgrade tests should be performed after the rollout

- [ ] [Verify Version Control state (v0 and v1)](#verify-version-control-state)
- [ ] [Test ITS token deployment and transfers](#test-its-token-deployment-and-transfers)
- [ ] [Test custom token linking](#test-custom-token-linking)

### Verify Version Control State

1. All functions should be enabled on v1

```bash
ts-node sui/its check-version-control 1
```

2. Only `allow_function` and `disallow_function` should be enabled on v0

```bash
ts-node sui/its check-version-control 0
```

### Test ITS token deployment and transfers

1. Test Sui Token Deployment using either lock / unlock or mint / burn token manager

```bash
# Register token with manager type: lock / unlock
ts-node sui/its-example deploy-token [coin-symbol] "Test Token" 9 --tokenManagerMode "lock_unlock" --origin

# Register token with manager type: mint / burn
ts-node sui/its-example deploy-token [coin-symbol] "Test Token" 9 --tokenManagerMode "mint_burn" --mintAmount 100 --origin
```

Testing Sui <-> EVM transfers

1. Send Token Deployment to Another Chain

```bash
ts-node sui/its-example send-deployment [coin-symbol] [chain] [gas-value]
# Example:
# ts-node sui/its-example send-deployment LOCK avalanche 0.5
```

2. Send Tokens to an EVM Chain

```bash
ts-node sui/its-example send-token [coin-symbol] [chain] [recepient-address] [gas-value] [amount-to-send]
# Example:
# ts-node sui/its-example send-token LOCK avalanche 0xba76c6980428A0b10CFC5d8ccb61949677A61233 0.5 50
```

3. Send Tokens Back to Sui, from an EVM Chain

```bash
ts-node evm/its interchain-transfer sui [token-id] [recipient] [amount-to-send] -n [evm-chain]
# Example:
# ts-node evm/its interchain-transfer sui 0x334e3a13a8d0a8fc8ab5c7828fa4c664821f0a514e2ed447de9d9103352d7873 0x76f89a9b56dc580aed9f97e2b3bd03d8d24464e38522da9464c15103761c6707 5 -n avalanche
```

### Test custom token linking

This section covers comprehensive testing of custom token linking between Sui and EVM chains, testing all combinations of source chains and token manager modes.

#### Environment Setup

```bash
# Common variables for all tests
NAME="TEST1234"
SYMBOL="TEST1234"
EVM_DECIMALS=9
SUI_DECIMALS=6
EVM_CHAIN=avalanche

# Salt configuration
# EVM contract validates salt uniqueness, salt cannot be reused
EVM_TEMP_SALT="TEST1234" # Token manager deployed with this salt will be discarded
# Sui contract validates salt length, it must match Sui address (66)
SALT=0x0000000000000000000000000000000000000000000000000000000000000001

# Token manager types
LOCK_UNLOCK=2
MINT_BURN=4
MINT_BURN_FROM=1

# Wallet addresses (replace with actual addresses)
EVM_WALLET_ADDRESS="0x13f8C723AeB8CA762c652c553a11a11483846d8B"
SUI_WALLET_ADDRESS="0x76f89a9b56dc580aed9f97e2b3bd03d8d24464e38522da9464c15103761c6707"
```

#### Test Case 1: Sui as Source Chain with LOCK_UNLOCK Token Manager

**Setup:** Sui (LOCK_UNLOCK) → EVM (MINT_BURN)

1. **Deploy tokens on both chains and register metadata**

**On EVM chain (Destination):**

```bash
# Set EVM private key in environment

# Deploy token on EVM
ts-node evm/interchainTokenFactory --action deployInterchainToken \
    --minter $EVM_WALLET_ADDRESS \
    --name $NAME \
    --symbol $SYMBOL \
    --decimals $EVM_DECIMALS \
    --initialSupply 100000000000 \
    --salt $EVM_TEMP_SALT \
    -n $EVM_CHAIN

# Set EVM_TOKEN_ADDRESS from the result
EVM_TOKEN_ADDRESS=<from-deployment-result>

# Register EVM token metadata on Axelar Hub
ts-node evm/its register-token-metadata $EVM_TOKEN_ADDRESS -n $EVM_CHAIN
```

**On Sui chain (Source):**

```bash
# Set Sui private key in environment

# Deploy token on Sui with LOCK_UNLOCK mode
ts-node sui/its register-custom-coin $SYMBOL $NAME $SUI_DECIMALS --salt $SALT

# Record Channel ID from result
CHANNEL=<from-result>

# Register token metadata on Axelar Hub
ts-node sui/its register-coin-metadata $SYMBOL
```

2. **Link Sui token to EVM token**

```bash
# On Sui chain (Source)
ts-node sui/its link-coin $SYMBOL $EVM_CHAIN $EVM_TOKEN_ADDRESS \
    --tokenManagerMode lock_unlock \
    --destinationTokenManagerMode mint_burn \
    --channel $CHANNEL \
    --registered

# Record the Sui Token ID from the result
SUI_TOKEN_ID=<from-link-result>

# Get token manager address on EVM
ts-node evm/its.js token-manager-address $SUI_TOKEN_ID -n $EVM_CHAIN

TOKEN_MANAGER_ADDRESS=<from-result>

# Transfer mintership to token manager (if required)
ts-node evm/its.js transfer-mintership $EVM_TOKEN_ADDRESS $TOKEN_MANAGER_ADDRESS -n $EVM_CHAIN
```

3. **Test interchain transfers**

**Sui → EVM:**

```bash
ts-node sui/its interchain-transfer [coinObjectID] $SUI_TOKEN_ID $EVM_CHAIN $EVM_WALLET_ADDRESS [amount]
```

**EVM → Sui:**

```bash
ts-node evm/its interchain-transfer sui $SUI_TOKEN_ID $SUI_WALLET_ADDRESS 125 -n $EVM_CHAIN
```

#### Test Case 2: Sui as Source Chain with MINT_BURN Token Manager

**Setup:** Sui (MINT_BURN) → EVM (LOCK_UNLOCK)

1. **Deploy tokens on both chains and register metadata**

**On EVM chain (Destination):**

```bash
# Set EVM private key in environment

# Deploy token on EVM
ts-node evm/interchainTokenFactory --action deployInterchainToken \
    --minter $EVM_WALLET_ADDRESS \
    --name $NAME \
    --symbol $SYMBOL \
    --decimals $EVM_DECIMALS \
    --initialSupply 100000000000 \
    --salt $EVM_TEMP_SALT \
    -n $EVM_CHAIN

# Set EVM_TOKEN_ADDRESS from the result
EVM_TOKEN_ADDRESS=<from-deployment-result>

# Register EVM token metadata on Axelar Hub
ts-node evm/its register-token-metadata $EVM_TOKEN_ADDRESS -n $EVM_CHAIN
```

**On Sui chain (Source):**

```bash
# Set Sui private key in environment

# Deploy token on Sui with MINT_BURN mode (requires --treasuryCap)
ts-node sui/its register-custom-coin $SYMBOL $NAME $SUI_DECIMALS  --salt $SALT --treasuryCap

# Record the channel from the result for linking
CHANNEL=<from-deployment-result>

# Register token metadata on Axelar Hub
ts-node sui/its register-coin-metadata $SYMBOL
```

2. **Link Sui token to EVM token**

```bash
# On Sui chain (Source)
ts-node sui/its link-coin $SYMBOL $EVM_CHAIN $EVM_TOKEN_ADDRESS \
    --tokenManagerMode mint_burn \
    --destinationTokenManagerMode lock_unlock \
    --channel $CHANNEL \
    --registered

# Record the Sui Token ID from the result
SUI_TOKEN_ID=<from-link-result>
```

3. **Test interchain transfers**

**EVM → Sui:**

```bash
ts-node evm/its interchain-transfer sui $SUI_TOKEN_ID $SUI_WALLET_ADDRESS 125 -n $EVM_CHAIN
```

**Sui → EVM:**

```bash
ts-node sui/its interchain-transfer [coinObjectID] $SUI_TOKEN_ID $EVM_CHAIN $EVM_WALLET_ADDRESS [amount]
```

#### Test Case 3: Sui as Destination Chain with LOCK_UNLOCK Token Manager

**Setup:** EVM (MINT_BURN) → Sui (LOCK_UNLOCK)

1. **Deploy tokens on both chains and register metadata**

**On Sui chain (Destination):**

```bash
# Set Sui private key in environment

# Deploy token on Sui
ts-node sui/tokens publish-coin $SYMBOL $NAME $SUI_DECIMALS

# Register token metadata on Axelar Hub
ts-node sui/its register-coin-metadata $SYMBOL

# Record the Sui coin type from the result without 0x
SUI_COIN_TYPE=<from-deployment-result>
```

**On EVM chain (Source):**

```bash
# Set EVM private key in environment

# Deploy token on EVM
ts-node evm/interchainTokenFactory --action deployInterchainToken \
    --minter $EVM_WALLET_ADDRESS \
    --name $NAME \
    --symbol $SYMBOL \
    --decimals $EVM_DECIMALS \
    --initialSupply 100000000000 \
    --salt $EVM_TEMP_SALT \
    -n $EVM_CHAIN

# Set EVM_TOKEN_ADDRESS from the result
EVM_TOKEN_ADDRESS=<from-deployment-result>

# Register EVM token metadata on Axelar Hub
ts-node evm/its register-token-metadata $EVM_TOKEN_ADDRESS -n $EVM_CHAIN
```

2. **Register EVM custom token**

```bash
# On EVM chain (Source)
ts-node evm/interchainTokenFactory --action registerCustomToken \
    --tokenAddress $EVM_TOKEN_ADDRESS \
    --tokenManagerType $MINT_BURN \
    --operator $EVM_WALLET_ADDRESS \
    --salt $SALT \
    -n $EVM_CHAIN

# Record Token ID from result
EVM_TOKEN_ID=<from-result>
```

3. **Mint tokens to user on Sui**

```bash
# On Sui chain (Destination)
ts-node sui/its-example mint-token $SYMBOL --recipient $SUI_WALLET_ADDRESS
```

4. Give unlinked Sui coin to ITS.
   (Only pass the `--treasuryCapReclaimer` flag if the Sui token manager is mint / burn)

- Run on Sui chain, update env with the Sui private key:

```bash
# On Sui chain (Destination)
ts-node sui/its give-unlinked-coin $SYMBOL $EVM_TOKEN_ID
```

5. **Link source (EVM) and destination tokens (Sui)**

```bash
# On EVM chain (Source)
ts-node evm/interchainTokenFactory --action linkToken \
    --destinationChain sui \
    --destinationTokenAddress $SUI_COIN_TYPE \
    --tokenManagerType $LOCK_UNLOCK \
    --linkParams "0x" \
    --salt $SALT \
    -n $EVM_CHAIN
```

6. **Transfer EVM minter role to Token Manager contract**

```bash
# On EVM chain (Source)
ts-node evm/its.js token-manager-address $EVM_TOKEN_ID -n $EVM_CHAIN

# Record the Token Manager address from the result
TOKEN_MANAGER_ADDRESS=<from-result>

ts-node evm/its.js transfer-mintership $EVM_TOKEN_ADDRESS $TOKEN_MANAGER_ADDRESS -n $EVM_CHAIN
```

7. **Test interchain transfers**

**EVM → Sui:**

```bash
ts-node evm/its interchain-transfer sui $EVM_TOKEN_ID $SUI_WALLET_ADDRESS 125 -n $EVM_CHAIN
```

**Sui → EVM:**

```bash
ts-node sui/its interchain-transfer [coinObjectID] $EVM_TOKEN_ID $EVM_CHAIN $EVM_WALLET_ADDRESS [amount]
```

#### Test Case 4: Sui as Destination Chain with MINT_BURN Token Manager

**Setup:** EVM (LOCK_UNLOCK) → Sui (MINT_BURN)

1. **Deploy tokens on both chains and register metadata**

**On Sui chain (Destination):**

```bash
# Set Sui private key in environment

# Deploy token on Sui
ts-node sui/tokens publish-coin $SYMBOL $NAME $SUI_DECIMALS

# Register token metadata on Axelar Hub
ts-node sui/its register-coin-metadata $SYMBOL

# Record the Sui coin type from the result without 0x
SUI_COIN_TYPE=<from-deployment-result>
```

**On EVM chain (Source):**

```bash
# Set EVM private key in environment

# Deploy token on EVM
ts-node evm/interchainTokenFactory --action deployInterchainToken \
    --minter $EVM_WALLET_ADDRESS \
    --name $NAME \
    --symbol $SYMBOL \
    --decimals $EVM_DECIMALS \
    --initialSupply 100000000000 \
    --salt $EVM_TEMP_SALT \
    -n $EVM_CHAIN

# Set EVM_TOKEN_ADDRESS from the result
EVM_TOKEN_ADDRESS=<from-deployment-result>

# Register EVM token metadata on Axelar Hub
ts-node evm/its register-token-metadata $EVM_TOKEN_ADDRESS -n $EVM_CHAIN
```

2. **Register EVM custom token with LOCK_UNLOCK**

```bash
# On EVM chain (Source)
ts-node evm/interchainTokenFactory --action registerCustomToken \
    --tokenAddress $EVM_TOKEN_ADDRESS \
    --tokenManagerType $LOCK_UNLOCK \
    --operator $EVM_WALLET_ADDRESS \
    --salt $SALT \
    -n $EVM_CHAIN

# Record Token ID from result
EVM_TOKEN_ID=<from-result>
```

3. **Mint tokens to user on Sui**

```bash
# On Sui chain (Destination)
ts-node sui/its-example mint-token $SYMBOL --recipient $SUI_WALLET_ADDRESS
```

4. **Give unlinked Sui coin to ITS**

```bash
# On Sui chain (Destination)
ts-node sui/its give-unlinked-coin $SYMBOL $EVM_TOKEN_ID --treasuryCapReclaimer
```

5. **Link source (EVM) and destination tokens (Sui)**

```bash
# On EVM chain (Source)
ts-node evm/interchainTokenFactory --action linkToken \
    --destinationChain sui \
    --destinationTokenAddress $SUI_COIN_TYPE \
    --tokenManagerType $MINT_BURN \
    --linkParams "0x" \
    --salt $SALT \
    -n $EVM_CHAIN

# Record the final Token ID from the result
EVM_TOKEN_ID=<from-result>
```

6. **Test interchain transfers**

**EVM → Sui:**

```bash
ts-node evm/its interchain-transfer sui $EVM_TOKEN_ID $SUI_WALLET_ADDRESS 125 -n $EVM_CHAIN
```

**Sui → EVM:**

```bash
ts-node sui/its interchain-transfer [coinObjectID] $EVM_TOKEN_ID $EVM_CHAIN $EVM_WALLET_ADDRESS [amount]
```
