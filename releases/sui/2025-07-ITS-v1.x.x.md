# Sui ITS v1.x.x

|                | **Owner**                              |
| -------------- | -------------------------------------- |
| **Created By** | @drewstaylor <drew@interoplabs.io> |
| **Deployment** | @blockchainguyy <ayush@interoplabs.io> |

| **Network**          | **Deployment Status** | **Date**   |
| -------------------- | --------------------- | ---------- |
| **Devnet Amplifier** | TBD                   | TBD        |
| **Stagenet**         | TBD                   | TBD        |
| **Testnet**          | TBD                   | TBD        |
| **Mainnet**          | TBD                   | TBD        |

Release (TBD)

Changelog(TBD)

## Deployment

```bash
# Clone latest main and update deps
npm ci && npm run build
```

Create an `.env` config. Use `all` for `CHAINS` to run the cmd for every EVM chain, or set a specific chain. On `devnet-amplifier` chain name will be set to `sui-2`.

```yaml
PRIVATE_KEY=<sui-deployer-key>
PRIVATE_KEY_TYPE="mnemonic" # Optional
SIGNATURE_SCHEME=secp256k1
ENV=<devnet-amplifier|stagenet|testnet|mainnet>
CHAIN=sui
```

### ITS Contract Admin & Roles

Many of the below commands require either Owner or Operator privelages on the ITS contract.

#### OwnerCap

Some commands require a wallet that owns the contract's admin capability (`OwnerCap`). By default, this will be the address that deployed the ITS v0 contract.

The commands requiring this capability are:
* [Upgrading the ITS move contract][]
* [Enabling the Upgrade][]
* [Disabling the Legacy Contract][]

#### OperatorCap

Migrating legacy coin metadata requires an `OperatorCap` capability. This is any address added as an operator for the effected coin, or an admin possessing the ITS `OwnerCap`. 

The commands requiring this capability are:
* [Migrating Legacy Tokens][]

### Fetching Legacy Tokens

To fix the issue of some tokens not displaying correctly in wallets, we need to fetch the effected tokens. This list can be fetched before, or after the upgrade.

```bash
# Save legacy tokens for later migration
ts-node sui/tokens legacy-coins
```

### Upgrading the ITS move contract ###

1. Update the release dependency in `package.json`

```diff
- "@axelar-network/axelar-cgp-sui": "1.1.3",
+ "@axelar-network/axelar-cgp-sui": "1.x.x",
```

2. Do the upgrade tx

```bash
# Upgrade InterchainTokenService v0 -> v1
ts-node sui/deploy-contract upgrade InterchainTokenService any_upgrade
```

### Enabling the Upgrade ###

Migrate version control state to enable the upgrade. 

```bash
ts-node sui/deploy-contract migrate InterchainTokenService
```

## Checklist

The following post-upgrade tasks should be performed after the rollout

- [ ] Disable the legacy ITS contract
- [ ] Verify Version Control state (v0 and v1)
- [ ] Re-deploy Example contract
- [ ] Fetch metadata of legacy coins (if not already fetched)
- [ ] Migrate metadata of legacy coins
- [ ] Test ITS token deployment

### Disabling the Legacy Contract ###

```bash
# Disallow all functions in the legacy ITS package
ts-node sui/contract pause --functions "all" --version "0" InterchainTokenService
```

### Verify Version Control State

1. All functions should be enabled on v1

```bash
ts-node sui/its check-version-control 1
```

2. Only `allow_function` and `disallow_function` should be enabled on v0

```bash
ts-node sui/its check-version-control 0
```

### Re-deploy Example Contract

Re-deploy Example contract (the existing one doesn't work after the ITS upgrade is enabled)

```bash
ts-node sui/deploy-contract sync
ts-node sui/deploy-contract deploy Example
```

### Migrating Legacy Tokens ###

1. Without status debug logs

```bash
# Migrate legacy tokens in batches of 10 coins per tx
ts-node sui/its migrate-coin-metadata-all --batch 10
```

2. Or, with debug logs turned on

```bash
# Migrate legacy tokens in batches of 10, with verbose logging
ts-node sui/its migrate-coin-metadata-all --batch 10 --logging 10
```

#### Test ITS token deployment

```bash
# Deploy Test Tokens
ts-node sui/its-example deploy-token --origin TST1 "Test Token 1" 6

# Send Token Deployment to Gateway
ts-node sui/its-example send-deployment TST1 [destinationChain] 0.5

# Send Tokens to Destination chain
ts-node sui/its-example send-token TST1 [destinationChain] [destinationAddress] 0.5 1

# Initiate token transfer from both EVM chains too
ts-node evm/its.js --action interchainTransfer --destinationChain sui --tokenId [tokenId] --destinationAddress [recipientAddress] --amount 1 --gasValue 0.5
```
