# Sui ITS v1.x.x

|                | **Owner**                              |
| -------------- | -------------------------------------- |
| **Created By** | @drewstaylor <drew@interoplabs.io> |
| **Deployment** | @blockchainguyy <ayush@interoplabs.io> |

| **Network**          | **Deployment Status** | **Date**   |
| -------------------- | --------------------- | ---------- |
| **Devnet Amplifier** | TBD                   | TBD        |
| **Stagenet**         | TBD                   | TBD        |
| **Testnet**          | TBD                   | TBD        |
| **Mainnet**          | TBD                   | TBD        |

Release (TBD)

Changelog(TBD)

## Deployment

```bash
# Clone latest main and update deps
npm ci && npm run build
```

Create an `.env` config. Use `all` for `CHAINS` to run the cmd for every EVM chain, or set a specific chain. On `devnet-amplifier` chain name will be set to `sui-2`.

```yaml
PRIVATE_KEY=<sui-deployer-key>
PRIVATE_KEY_TYPE="mnemonic" # Optional
SIGNATURE_SCHEME=secp256k1
ENV=<devnet-amplifier|stagenet|testnet|mainnet>
CHAIN=sui
```

### Upgrading the ITS move contract

The upgrade policy requirement depends on what the contract was deployed with. The default choice for deployments is "any_upgrade". The possible choices for deployments are "immutable", "any_upgrade", "code_upgrade", "dep_upgrade".

```bash
# Upgrade InterchainTokenService v0 -> v1
ts-node sui/deploy-contract upgrade InterchainTokenService <policy>
```

### Enabling the Upgrade

```bash
# Migrate version control state to enable the upgrade
ts-node sui/deploy-contract migrate InterchainTokenService
```

- Re-deploy Example Contract

The original Example contract doesn't work after the upgrade is enabled.

```bash
# Deploy Example contract that works with upgraded ITS
ts-node sui/deploy-contract deploy Example
```

## Checklist

The following post-upgrade tasks should be performed after the rollout

- [ ] Disable the legacy ITS contract
- [ ] Fetch metadata of legacy coins
- [ ] Migrate metadata of legacy coins
- [ ] Test ITS token deployment

### Disabling the Legacy Contract

In the version control contract, the legacy ITS package has been replaced by the new (e.g. after running the command `ts-node sui/deploy-contract upgrade InterchainTokenService <policy>`). However, it still exists on chain and should be disabled to prevent node operators and relayers from calling the legacy contract after the upgrade.

To disable the legacy contract we must disallow its functions, but this should only be done after the upgraded package is live and successfully enabled.

```bash
# Disallow all functions in the legacy ITS package
ts-node sui/contract pause --functions "all" --version "0" InterchainTokenService
```

### Fetching Legacy Tokens

To fix the issue of some tokens not displaying correctly in wallets we need to fetch the effected tokens. This list can be fetched before, or after, the ITS move contract is upgraded.

```bash
# Save legacy tokens for later migration
ts-node sui/tokens legacy-coins
```

### Migrating Legacy Tokens

Without status updates

```bash
# Migrate legacy tokens saved by the `sui/tokens legacy-coins` command 
# (defaults to 'quiet mode', with a logging <size> of 0)
ts-node sui/its migrate-coin-metadata-all
```

With status updates

```bash
# Use --logging <size> to control status updates for large bulk migrations
# e.g. update migration status display every 100 migrated tokens:
ts-node sui/its migrate-coin-metadata-all --logging 100
```

#### Test ITS token deployment

```bash
# Deploy Test Tokens
ts-node sui/its-example deploy-token --origin TST1 "Test Token 1" 6

# Send Token Deployment to Gateway
ts-node sui/its-example send-deployment TST1 [destinationChain] 0.5

# Send Tokens to Destination chain
ts-node sui/its-example send-token TST1 [destinationChain] [destinationAddress] 0.5 1

# Initiate token transfer from both EVM chains too
ts-node evm/its.js --action interchainTransfer --destinationChain sui --tokenId [tokenId] --destinationAddress [recipientAddress] --amount 1 --gasValue 0.5
```
