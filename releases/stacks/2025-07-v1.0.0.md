# Stacks v1.0.0

|                | **Owner**                           |
|----------------|-------------------------------------|
| **Created By** | @raress96 <rares.serban@buidly.com> |
| **Deployment** | @raress96 <rares.serban@buidly.com> |

| **Network**          | **Deployment Status** | **Date**   |
|----------------------|-----------------------|------------|
| **Devnet Amplifier** | Deployed              | 2025-05-01 |
| **Stagenet**         | -                     | TBD        |
| **Testnet**          | -                     | TBD        |
| **Mainnet**          | -                     | TBD        |

[Release](https://github.com/Trust-Machines/axelar_stacks_bridge/releases/tag/1.0.1)

## Background

Changes in the release:

This is the v1.0.0 initial release.

## Deployment: Phase 1

Create an `.env` config. `CHAIN` should be set to `stacks`.

```yaml
ENV=xyz
CHAIN=stacks
```

An initial Stacks chain config needs to be added to the `${ENV}.json` file under `chains` key.

#### Devnet-Amplifier / Stagenet / Testnet

```bash
\"$CHAIN\": {
  "name": "Stacks",
  "axelarId": \"$CHAIN\",
  "rpc": "https://api.testnet.hiro.so",
  "tokenSymbol": "STX",
  "networkType": "testnet",
  "chainType": "stacks",
  "finality": "1",
  "decimals": 6,
  "approxFinalityWaitTime": 1,
  "explorer": {
    "name": "Stacks Explorer",
    "url": "https://explorer.hiro.so/?chain=testnet"
  },
  "contracts": {}
}
```

#### Mainnet

```bash
\"$CHAIN\": {
  "name": "Stacks",
  "axelarId": \"$CHAIN\",
  "rpc": "https://api.hiro.so",
  "tokenSymbol": "STX",
  "networkType": "mainnet",
  "chainType": "stacks",
  "finality": "1",
  "decimals": 6,
  "approxFinalityWaitTime": 1,
  "explorer": {
    "name": "Stacks Explorer",
    "url": "https://explorer.hiro.so"
  },
  "contracts": {}
}
```

1. Stacks contracts need to be deployed from a new account. You can generate a new Stacks account by running:

```bash
ts-node stacks/generate-wallet.js
```

Make sure to save the `Mnemonic` and `Address` to a safe place!

Update your `.env` file to include the following:

```bash
STACKS_MNEMONIC=[mnemonic from above step]
```

2. Fund the account with STX

For Devnet-Amplifier, Stagenet and Testnet, you can use the faucet script:

```bash
ts-node stacks/faucet.js --mnemonic $STACKS_MNEMONIC
```

3. Prepare contracts for deployment:

Download the latest release of
the [Axelar Stacks Bridge](https://github.com/Trust-Machines/axelar_stacks_bridge/releases) and check the checksum:

```bash
wget -O axelar_stacks_bridge_v1.0.1.zip https://github.com/Trust-Machines/axelar_stacks_bridge/archive/refs/tags/1.0.1.zip
shasum -a 256 axelar_stacks_bridge_v1.0.1.zip
```

Check that the checksum matches:

```
232ee041eb99d229dcafbb88cb2e73588325899a3753bdac008432b0d2080aa9  axelar_stacks_bridge_v1.0.1.zip
```

Then copy the contracts to the `./stacks/contracts` folder:

```bash
unzip axelar_stacks_bridge_v1.0.1.zip
cp -r axelar_stacks_bridge-1.0.1/contracts/. ./stacks/contracts/
rm axelar_stacks_bridge_v1.0.1.zip
rm -rf axelar_stacks_bridge-1.0.1
```

Then run:

```bash
ts-node stacks/prepare-contracts.js --basePath ./stacks/contracts
```

This will replace appropriate Stacks Clarity Trait references with the correct Stacks Address from the wallet generated
above and will also replace other snippets of code depending on the environment.

4. Deploy contracts:

#### clarity-stacks

```bash
ts-node stacks/deploy-contract.js --contract clarity-stacks --basePath ./stacks/contracts
```

#### gas-storage

```bash
ts-node stacks/deploy-contract.js --contract gas-storage --basePath ./stacks/contracts
```

#### traits

```bash
ts-node stacks/deploy-contract.js --contract traits --basePath ./stacks/contracts
```

#### gas-impl

```bash
ts-node stacks/deploy-contract.js --contract gas-impl --version "1.0.1" --basePath ./stacks/contracts
```

#### gateway-storage

```bash
ts-node stacks/deploy-contract.js --contract gateway-storage --basePath ./stacks/contracts
```

#### gas-service

```bash
ts-node stacks/deploy-contract.js --contract gas-service --basePath ./stacks/contracts
```

#### gateway-impl

```bash
ts-node stacks/deploy-contract.js --contract gateway-impl --version "1.0.1" --basePath ./stacks/contracts
```

#### gateway

```bash
ts-node stacks/deploy-contract.js --contract gateway --basePath ./stacks/contracts
```

#### governance

```bash
ts-node stacks/deploy-contract.js --contract governance --basePath ./stacks/contracts
```

#### interchain-token-service-storage

```bash
ts-node stacks/deploy-contract.js --contract interchain-token-service-storage --basePath ./stacks/contracts
```

#### interchain-token-factory

```bash
ts-node stacks/deploy-contract.js --contract interchain-token-factory --basePath ./stacks/contracts
```

#### interchain-token-service

```bash
ts-node stacks/deploy-contract.js --contract interchain-token-service --basePath ./stacks/contracts
```

#### interchain-token-factory-impl

```bash
ts-node stacks/deploy-contract.js --contract interchain-token-factory-impl --version "1.0.1" --basePath ./stacks/contracts
```

#### verify-onchain

```bash
ts-node stacks/deploy-contract.js --contract verify-onchain --basePath ./stacks/contracts
```

#### interchain-token-service-impl

```bash
ts-node stacks/deploy-contract.js --contract interchain-token-service-impl --version "1.0.1" --basePath ./stacks/contracts
```

#### native-interchain-token

This contract is used by the Relayer.

```bash
ts-node stacks/deploy-contract.js --contract native-interchain-token --basePath ./stacks/contracts
```

5. Check that all contracts have been deployed successfully:

```bash
ts-node stacks/check-contracts.js
```

If you do not get any errors above, then the deployment can be continued.

6. At this point, you should deploy the [Stacks CosmWasm Axelar contracts](../cosmwasm/2025-05-Stacks-v1.0.0.md) by
   following the instructions there.

## Deployment: Phase 2

> **_NOTE:_** Ensure that the [Stacks CosmWasm Axelar contracts](../cosmwasm/2025-05-Stacks-v1.0.0.md) are deployed on
> the Axelar Network before calling setup on the Stacks contracts!

1. Setup gas-service

```bash
ts-node stacks/setup-contract.js GasService --gasCollector "[relayer wallet address]"
```

2. Setup gateway

| Network              | `minimumRotationDelay` | `previousSignerRetention` |
|----------------------|------------------------|---------------------------| 
| **Devnet-amplifier** | `0`                    | `15`                      |
| **Stagenet**         | `300`                  | `15`                      |
| **Testnet**          | `3600`                 | `15`                      |
| **Mainnet**          | `86400`                | `15`                      |

```bash
ts-node stacks/setup-contract.js Gateway --operator "[operator wallet address]" --minimumRotationDelay "[minimum rotation delay]" --previousSignerRetention "[previous signer retention]"
```

3. Setup interchain-token-service

| Network              | `trustedChains`        |
|----------------------|------------------------| 
| **Devnet-amplifier** | `avalanche-fuji,sui-2` |
| **Stagenet**         | `TBD`                  |
| **Testnet**          | `TBD`                  |
| **Mainnet**          | `TBD`                  |

```bash
ts-node stacks/setup-contract.js InterchainTokenService --operator "[operator wallet address]" --trustedChains "[trusted chains]"
```

4. Setup governance

| Network              | `governanceChain` | `governanceAddress`                          |
|----------------------|-------------------|----------------------------------------------| 
| **Devnet-amplifier** | `avalanche-fuji`  | `0x9279Da42329a01D4bf1229FCFA5cABF7B3c9D383` |
| **Stagenet**         | `TBD`             | `TBD`                                        |
| **Testnet**          | `TBD`             | `TBD`                                        |
| **Mainnet**          | `TBD`             | `TBD`                                        |

```bash
ts-node stacks/setup-contract.js Governance --governanceChain "[governance chain]" --governanceAddress "[governance address]"
```

## Checklist GMP

Make sure that all contracts have been deployed & setup successfully and that no transactions have failed by checking
the Stacks Explorer.

In order to perform routing of messages from Stacks to Axelar Network and vice versa,
the [Stacks Relayer](https://github.com/Trust-Machines/axelar-stacks-relayer?tab=readme-ov-file#manual-relaying)
supports Manual Relaying, if setting up an instance of the Relayer is too much overhead initially. Please follow the
instructions from the
link [repository](https://github.com/Trust-Machines/axelar-stacks-relayer?tab=readme-ov-file#manual-relaying).

Then, the following checks should be performed after the rollout:

### Stacks -> EVM GMP call

0. Deploy HelloWorld contract

```
ts-node stacks/deploy-contract.js --contract hello-world
```

1. Send a GMP call

```bash
ts-node stacks/checklist.js hello-world [destination-chain] [destination-contract-address] [payloadHex] [gasAmount]
```

2. Route GMP call via Amplifier

- https://docs.axelar.dev/dev/amplifier/chain-integration/relay-messages

3. Submit proof with multisig session id

```bash
ts-node evm/gateway.js -n [destination-chain] --action submitProof --multisigSessionId [multisig session id]
```

4. Confirm whether the message is approved

```bash
ts-node evm/gateway.js -n [destination-chain] --action isContractCallApproved --commandID [command-id] --sourceChain $CHAIN --sourceAddress [hello world address] --destination [destination address] --payloadHash [payload hash]
```

### EVM GMP call -> Stacks

1. Send a GMP call

```bash
ts-node evm/gateway.js -n [source-chain] --action callContract --destinationChain $CHAIN --destination [hello world contract] --payload 0x1234
```

2. Route GMP call via Amplifier

- [Stacks Relayer](https://github.com/Trust-Machines/axelar-stacks-relayer?tab=readme-ov-file#manual-relaying)
- https://docs.axelar.dev/dev/amplifier/chain-integration/relay-messages

## Checklist ITS

### Stacks → EVM ITS call

#### Setup token

1. Deploy `sample-sip-010` token to use for testing (or use a similar lowercase name for the token if repeating the checklist)

```bash
ts-node stacks/deploy-contract.js --contract sample-sip-010 --name sample-sip-010
```

2. Deploy & setup token manager for token (or use a similar lowercase name for the token manager if repeating the checklist)

```bash
ts-node stacks/deploy-contract.js --contract token-manager --name token-manager-sample
```

For setup, use name of the token manager contract previously deployed, and the address of the token previously deployed.

```bash
ts-node stacks/setup-contract.js TokenManager --name TokenManagerSample --token "[address of the previously deployed token]"
```

3. Register the token manager on Stacks ITS contract

```bash
ts-node stacks/checklist.js register-token-manager TokenManagerSample
```

4. Deploy the token on another chain

```bash
ts-node stacks/checklist.js deploy-remote-canonical-interchain-token TokenManagerSample --destinationChain "[destination chain]" --gasValue "1000000" # 1 STX for cross chain gas
```

5. Route GMP call from Stacks to ITS Hub

- [Stacks Relayer](https://github.com/Trust-Machines/axelar-stacks-relayer?tab=readme-ov-file#manual-relaying)
- https://docs.axelar.dev/dev/amplifier/chain-integration/relay-messages

#### Interchain transfer

1. Do interchain transfer with sample token

```bash
ts-node stacks/checklist.js interchain-transfer TokenManagerSample --destinationChain "[destination chain]" --destinationAddress "[destination-address]" --value "10000000" --gasValue "1000000" # send 10 SMPL tokens & pay 1 STX for cross chain gas 
```

2. Route GMP call from Stacks to ITS Hub

- [Stacks Relayer](https://github.com/Trust-Machines/axelar-stacks-relayer?tab=readme-ov-file#manual-relaying)
- https://docs.axelar.dev/dev/amplifier/chain-integration/relay-messages

### EVM → Stacks ITS call

Make sure to have your EVM private key set in `.env` under `PRIVATE_KEY` env var.

#### Setup token

1. Deploy new token on EVM chain:

```bash
ts-node evm/interchainTokenFactory.js --action deployInterchainToken --minter [minter-address] --name "test" --symbol "TST" --decimals 6 --initialSupply 10000 --salt "salt1234" -n [source-chain] 
```

2. Deploy the token remotely on the Stacks chain:

```bash
ts-node evm/interchainTokenFactory.js --action deployRemoteInterchainToken --destinationChain $CHAIN --salt "salt1234" --gasValue 100000000000000000 -n [source-chain]
```

Save the `tokenId` returned for doing an interchain transfer.

#### Interchain transfer

1. Interchain Token Transfer for Native Interchain Token

```bash
ts-node stacks/decode-address.js [stacks-address]
ts-node evm/its.js interchain-transfer -n [source-chain] $CHAIN [token-id] [decoded-recipient-address] [amount-without-decimals]
```

2. Route GMP call from ITS Hub to Stacks

- [Stacks Relayer](https://github.com/Trust-Machines/axelar-stacks-relayer?tab=readme-ov-file#manual-relaying)
- https://docs.axelar.dev/dev/amplifier/chain-integration/relay-messages
