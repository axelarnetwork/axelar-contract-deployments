name: Test Stellar

on: pull_request

jobs:
  check-relevant-changes:
    name: Check for Relevant Changes
    runs-on: blacksmith-2vcpu-ubuntu-2204
    outputs:
      run_tests: ${{ steps.filter.outputs.stellar == 'true' || steps.filter.outputs.common == 'true' || steps.filter.outputs.github == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            stellar:
              - 'stellar/**'
            common:
              - 'common/**'
            github:
              - '.github/workflows/test-stellar.yaml'
      - name: Summarize Changes
        run: |
          echo "Changes in stellar: ${{ steps.filter.outputs.stellar }}"
          echo "Changes in common: ${{ steps.filter.outputs.common }}"
          echo "Changes in github: ${{ steps.filter.outputs.github }}"

  test-stellar:
    name: Test Stellar
    needs: check-relevant-changes
    if: ${{ needs.check-relevant-changes.outputs.run_tests == 'true' }}
    runs-on: blacksmith-8vcpu-ubuntu-2204
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout axelar-amplifier-stellar repo
        uses: actions/checkout@v4
        with:
          repository: axelarnetwork/axelar-amplifier-stellar
          path: axelar-amplifier-stellar

      - name: Get latest short commit for axelar-amplifier-stellar
        id: commit_hash
        run: |
          cd axelar-amplifier-stellar
          git fetch --all
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT

      - name: Install Node.js
        uses: useblacksmith/setup-node@v5
        with:
          node-version: 18.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup Stellar network
        uses: ./.github/actions/setup-stellar

      ###### Command: Deploy Contract ######

      - name: Deploy AxelarOperators
        run: node stellar/deploy-contract deploy AxelarOperators --version ${{ steps.commit_hash.outputs.hash }}

      - name: Deploy AxelarGasService
        run: node stellar/deploy-contract deploy AxelarGasService --version ${{ steps.commit_hash.outputs.hash }}

      - name: Deploy AxelarGateway
        run: node stellar/deploy-contract deploy AxelarGateway --version ${{ steps.commit_hash.outputs.hash }}

      - name: Deploy InterchainTokenService
        run: node stellar/deploy-contract deploy InterchainTokenService --version ${{ steps.commit_hash.outputs.hash }}

      - name: Deploy AxelarExample
        run: node stellar/deploy-contract deploy AxelarExample --version ${{ steps.commit_hash.outputs.hash }}

      - name: Deploy Upgrader
        run: node stellar/deploy-contract deploy Upgrader --version ${{ steps.commit_hash.outputs.hash }}

      - name: Deploy Multicall
        run: node stellar/deploy-contract deploy Multicall --version ${{ steps.commit_hash.outputs.hash }}

      ###### Command: Gateway ######

      - name: Gateway Paused
        run: node stellar/contract.js paused AxelarGateway

      - name: Gateway Pause
        run: node stellar/contract.js pause AxelarGateway

      - name: Gateway Unpause
        run: node stellar/contract.js unpause AxelarGateway

      - name: Gateway Call Contract
        run: node stellar/gateway.js call-contract remote 0x4F4495243837681061C4743b74B3eEdf548D56A5 0x1234

      - name: Gateway Rotate Signers
        run: node stellar/gateway.js rotate --new-nonce test --signers wallet

      ###### Command: ITS ######

      - name: Add Trusted Chain
        run: node stellar/its.js add-trusted-chains remote

      - name: Add All Trusted Chains
        run: node stellar/its.js add-trusted-chains all

      - name: Remove Trusted Chain
        run: node stellar/its.js remove-trusted-chains remote

      - name: Remove All Trusted Chains
        run: node stellar/its.js remove-trusted-chains all

      ###### Command: ITS Example ######
      - name: Prepare ITS Example Parameters
        run: |
          echo "sourceChain=stellar" >> $GITHUB_ENV
          echo "sourceAddress=GBZXN7PIRZGNMHGA7MUUUF4GWPY5AYPV6LY4UV2GL6VJGIQRXFDNMADI" >> $GITHUB_ENV
          echo "destinationChain=remote" >> $GITHUB_ENV
          echo "destinationAddress=0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266" >> $GITHUB_ENV

          echo "name=TEST" >> $GITHUB_ENV
          echo "symbol=TEST" >> $GITHUB_ENV
          echo "decimal=18" >> $GITHUB_ENV
          echo "salt=0x1234" >> $GITHUB_ENV
          echo "amount=1" >> $GITHUB_ENV

          echo "nativeTokenAddress=CDMLFMKMMD7MWZP3FKUBZPVHTUEDLSX4BYGYKH4GCESXYHS3IHQ4EIG4" >> $GITHUB_ENV
          echo "tokenId=0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266" >> $GITHUB_ENV

          # Note that tokenId is hardcoded since it's derivation must always be the same

      - name: Deploy Test Tokens
        run: |
          node stellar/its.js deploy-interchain-token ${{ env.name }} ${{ env.symbol }} ${{ env.decimal }} ${{ env.salt }} ${{ env.amount }}
          node stellar/its.js deploy-remote-interchain-token ${{ env.salt }} ${{ env.destinationChain }} --gas-token-address ${{ env.nativeTokenAddress }} --gas-amount 100000000
          node stellar/its.js register-canonical-token ${{ env.nativeTokenAddress }}
          #node stellar/its.js deploy-remote-canonical-token ${{ env.tokenId }} ${{ env.destinationChain }} --gas-token-address ${{ env.nativeTokenAddress }} --gas-amount 100000000
          #node stellar/its.js interchain-transfer [token-id] ${{ env.destinationChain }} ${{ env.destinationAddress }} ${{ env.amount }} --data '' --gas-token-address ${{ env.nativeTokenAddress }} --gas-amount 100000000

      ###### Command: Flow Limit ######
      # - name: ITS Flow Limit
      #  run: node stellar/its.js flow-limit [token-id] [flow-limit]

      #- name: ITS Flow Limit Set
      #  run: node stellar/its.js set-flow-limit [token-id] [flow-limit]

      #- name: ITS Flow Limit Remove
      #  run: node stellar/its.js remove-flow-limit [token-id]

      #- name: ITS Flow Limit Remove
      #  run: node stellar/its.js remove-flow-limit [token-id]

      ###### Command: Operators ######

      ###### Command: Transfer Ownership ######

      ###### Command: Transfer Operatorship ######
