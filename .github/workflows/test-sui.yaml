name: Test Sui

on: pull_request

env:
  SUI_VERSION: mainnet-v1.25.3

jobs:
  test-sui:
    runs-on: blacksmith-2vcpu-ubuntu-2204

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: useblacksmith/setup-node@v5
        with:
          node-version: 18.x
          cache: 'npm'

      - name: Install
        run: npm ci

      - name: Setup Sui CLI and install dependencies
        uses: ./.github/actions/setup-sui
        with:
          SUI_VERSION: ${{ env.SUI_VERSION }}

      - name: Spin up Sui Network
        run: nohup sh -c "sui-test-validator" > nohup.out 2> nohup.err < /dev/null &

      - name: Sleep for 30 seconds
        run: sleep 30s
        shell: bash

      - name: Prepare local.json
        run: |
          echo '{
                "sui": {
                    "name": "Sui",
                    "axelarId": "sui",
                    "networkType": "localnet",
                    "tokenSymbol": "SUI",
                    "rpc": "http://127.0.0.1:9000",
                    "faucetUrl": "http://127.0.0.1:9123",
                    "contracts": {
                      "AxelarGateway": {}
                    }
                }
            }' > ./axelar-chains-config/info/local.json

      # Create .env file with default hardhat private key that's prefunded
      - name: Prepare .env
        run: |
          echo 'PRIVATE_KEY=suiprivkey1qyw6c8t5ws65fcvlcw5rhyt2jd8d6ad6e526shgktlm0x3aelq9rx2lp4wq' >> .env
          echo 'ENV=local' >> .env
          echo 'SKIP_EXISTING = true' >> .env

      - name: Display local.json
        run: cat ./axelar-chains-config/info/local.json

      - name: Request SUI from faucet
        run: node sui/faucet.js

      ###### Command: Deploy Contract ######

      - name: Deploy AxelarGateway
        run: node sui/deploy-contract deploy AxelarGateway --signers wallet

      - name: Deploy GasService
        run: node sui/deploy-contract deploy GasService

      - name: Deploy Operators
        run: node sui/deploy-contract deploy Operators

      - name: Deploy Test
        run: node sui/deploy-contract deploy Test

      ###### Command: Gas Service ######

      - name: Pay Gas
        run: node sui/gas-service.js payGas --amount 100 ethereum 0x6f24A47Fc8AE5441Eb47EFfC3665e70e69Ac3F05 0xba76c6980428A0b10CFC5d8ccb61949677A61233 0x1234

      - name: Refund Gas
        run: node sui/gas-service.js refund 0x2 --amount 1

      - name: Collect Gas
        run: node sui/gas-service.js collectGas --amount 0.1

      ###### Command: GMP ######

      - name: Execute Outgoing Call Contract
        run: node sui/gmp.js sendCall ethereum 0x6f24A47Fc8AE5441Eb47EFfC3665e70e69Ac3F05 0.1 0x1234

      # TODO: Fix error in this command
      - name: Execute Incoming Call Contract
        if: always()
        continue-on-error: true
        run: |
          node sui/gateway.js approve --proof wallet ethereum 0x32034b47cb29d162d9d803cc405356f4ac0ec07fe847ace431385fe8acf3e6e5-2 0x4F4495243837681061C4743b74B3eEdf548D56A5 0x6ce0d81b412abca2770eddb1549c9fcff721889c3aab1203dc93866db22ecc4b 0x56570de287d73cd1cb6092bb8fdee6173974955fdef345ae579ee9f475ea7432
          node sui/gmp.js execute ethereum 0x32034b47cb29d162d9d803cc405356f4ac0ec07fe847ace431385fe8acf3e6e5-2 0x4F4495243837681061C4743b74B3eEdf548D56A5 0x1234

      ###### Command: Gateway ######
      - name: Gateway Approve
        run: node sui/gateway.js approve --proof wallet ethereum 0x32034b47cb29d162d9d803cc405356f4ac0ec07fe847ace431385fe8acf3e6e5-2 0x4F4495243837681061C4743b74B3eEdf548D56A5 0x6ce0d81b412abca2770eddb1549c9fcff721889c3aab1203dc93866db22ecc4b 0x56570de287d73cd1cb6092bb8fdee6173974955fdef345ae579ee9f475ea7432

      - name: Gateway Call Contract
        run: node sui/gateway.js call-contract ethereum 0x4F4495243837681061C4743b74B3eEdf548D56A5 0x1234

        # TODO: Fix error in this command
      - name: Gateway Rotate Signers
        if: always()
        continue-on-error: true
        run: node sui/gateway.js rotate --signers wallet --proof wallet

      ###### Command: Operators ######

      - name: Store Capability Object in Operators
        run: node sui/operators.js storeCap

      - name: Add Operator
        run: node sui/operators.js add 0x4e9147724ba2b95242137b8ffe78326d7b35333cb90d42c552b47d0367ef7199

      - name: Collect Gas with Operator
        run: node sui/gas-service.js collectGas --amount 1

      - name: Refund Gas with Operator
        run: node sui/gas-service.js refund 0x2 --amount 1

      - name: Remove Operator
        run: node sui/operators.js remove 0x4e9147724ba2b95242137b8ffe78326d7b35333cb90d42c552b47d0367ef7199

      ###### Command: Generate Keypair ######
      - name: Generate Keypair
        run: node sui/generate-keypair.js

      ###### Command: Multisig ######

      # TODO: Add multisig tests

      ###### Command: Transfer Object ######
      - name: Transfer Object
        run: |
          object_id=$(sui client objects --json | jq -r '.[-1].data.objectId')
          node sui/transfer-object.js --objectId $object_id --recipient 0xdd7c964ff032273889eb6029a29314413b461629c45c0442c6f9cf8342450c12
